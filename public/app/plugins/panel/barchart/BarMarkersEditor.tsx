import { css } from '@emotion/css';
import { GrafanaTheme2, StandardEditorProps, SelectableValue, StandardEditorContext } from '@grafana/data';
import { t } from '@grafana/i18n';
import { Button, Field, InlineField, Input, Label, Select, Combobox, Container, useStyles2 } from '@grafana/ui';
import { useState } from 'react';
import { ColorPicker } from '../../../../../packages/grafana-ui/src/components/ColorPicker/ColorPicker';
import {PreparedMarker, BarMarkerOpts, Marker} from './markerTypes';
import Slider from 'rc-slider';
import { Time } from '../../../api/clients/playlist/v0alpha1/endpoints.gen';

export const BarMarkersEditor = (props: StandardEditorProps<Marker[]>) => {
  // State to manage the list of markers

const theme = useStyles2(getStyles)

var [markers, setMarkers] = useState<Marker[]>(props.value || []);

    // Remove a marker from the list
  const handleRemoveMarker = (id: number) => {
    const updatedMarkers = markers.filter((marker: Marker) => marker.id !== id);
    setMarkers(updatedMarkers);
    props.onChange(updatedMarkers); // Notify parent component of the change
  };

  const handleAddMarker = () => {

    let newId = 1;
    let cond = true;
    while(cond){
      cond = false
      for(const m of markers){
        if(m.id === newId){
          newId = m.id + 1;
          cond = true;
          break;
        }
      }
    }

    const newMarker: Marker = {
      id : newId,
      targetField: "",
      dataField: "",
      opts: {
        label: `Marker ${markers.length + 1}`,
        color: 'rgb(184, 119, 217)',
        shape: 'line',
        width: 1,
        isRotated: false
      },
    };
    const updatedMarkers = [...markers, newMarker];
    markers = updatedMarkers;
    setMarkers(markers);
    props.onChange(markers); // Notify parent component of the change
  };

  
    const fields =  props.context?.data[0]?.fields ?? [];
    const xAxis = props.context?.options?.xField;
    var xFieldIdx = 0;
    if(xAxis){
      xFieldIdx = fields.findIndex(f => f.name === xAxis);
    }
    var yFieldOptions: Array<SelectableValue<string | number>> = [];
    for (let i = 0; i < fields.length; i++) {
      if (i === xFieldIdx){continue;}
      if(fields)
      yFieldOptions.push({ label: fields[i].name ?? `Field ${i}`, value: fields[i].name ?? i });
    }

  
  // Update a specific field of a marker
  const handleOptsSettingChange = (id: number, field: keyof BarMarkerOpts, newValue: string | number | undefined) => {
    const updatedMarkers = markers.map((marker: Marker) =>
      marker.id === id ? { ...marker, opts: { ...marker.opts, [field]: newValue } } : marker
    );
    setMarkers(updatedMarkers);
    props.onChange(updatedMarkers); // Notify parent component of the change
  };



  // Update a specific field of a marker
  const handleSettingChange = (id: number, field: keyof Marker, newValue:  string | number | undefined) => {
  
 
    const updatedMarkers = markers.map((marker: Marker) =>
      marker.id === id ? { ...marker, [field]: newValue } : marker
    );
    setMarkers(updatedMarkers);
    props.onChange(updatedMarkers); // Notify parent component of the change
  
  };


  // Options for the shape dropdown
  const shapeOptions: Array<SelectableValue<string>> = [
    { label: 'Line', value: 'line' },
    { label: 'Circle', value: 'circle' },
    { label: 'Star', value: 'star' },
    { label: 'Cross', value: 'cross' },
  ];

  return (
    <div>
      <Button
        onClick={handleAddMarker}

        
      >
        {t('barchart.barmarkers-editor.add-marker', 'Add Marker +')}
      </Button>

      {/* Render each marker as a grouped UI element */}
      {markers.map((marker: Marker) => (
        // Code generated by copilot
          // Code generated by copilot
          <div
            key={marker.id}
            style={{
              marginTop: '16px',

              border: '1px dashed #ccc',
              padding: '16px',
              borderRadius: '4px',
              position: 'relative',
              display: 'no-flex',
              alignContent: 'space-between',
              flexWrap: 'wrap',
              gap: '16px',
              alignItems: 'center',
              minWidth: '0',
              minHeight: '300px',
              // Add extra right padding to prevent overlap with remove button
              paddingRight: '10px',
            }}
          >
            {/* Editable Marker title */}
            <div style={{ minWidth: '120px', padding: '5px' }}>
              <InlineField label={t('barchart.barmarkers-editor.marker-title', 'Title')}>
                 <div style={{ maxWidth: '160px'}}>
                <Input
            value={marker.opts.label ?? `Marker ${marker.id}`}
            onChange={(e) =>
              handleOptsSettingChange(marker.id, 'label', (e.target as HTMLInputElement).value)
            }
            placeholder={t('barchart.barmarkers-editor.marker-title-placeholder', `Marker ${marker.id}`)}
                />
                </div>
              </InlineField>
            </div>
            {/* Button to remove the marker */}
            <Button
              variant="destructive"
              size="sm"
              style={{
                position: 'absolute',
                top: '10px',
                right: '10px',
                padding: '8px',

                zIndex: 2,
              }}
              onClick={() => handleRemoveMarker(marker.id)}
            >
              {t('barchart.barmarkers-editor.remove-marker', 'X')}
            </Button>
              
            <div style={{ minWidth: '120px', padding: '5px' }}>
              <Field label={t('barchart.barmarkers-editor.y-axis', 'targetField')}>
              <Select
                options= {yFieldOptions}
                value={marker.targetField ?? ''}
                onChange={(v) =>
                handleSettingChange(marker.id, 'targetField', v.value?? '')
                }
                placeholder={t('barchart.barmarkers-editor.y-axis-placeholder', 'Select Y-Axis value')}
              />
              </Field>
            </div>
            <div style={{ minWidth: '120px', padding: '5px' }}>
              <Field label={t('barchart.barmarkers-editor.y-axis', 'dataField')}>
              <Select
                options= {yFieldOptions}
                value={marker.dataField ?? ''}
                onChange={(v) =>
                handleSettingChange(marker.id, 'dataField', v.value?? '')
                }
                placeholder={t('barchart.barmarkers-editor.y-axis-placeholder', 'Select Y-Axis value')}
              />
              </Field>
            </div>
              {/* Color Picker for Marker */}
              <div style={{ minWidth: '120px', padding: '5px', paddingBottom: '10px' }}>
                <Label>{t('barchart.barmarkers-editor.color', 'Color')}</Label>
                <ColorPicker
                color={marker.opts.color || 'rgb(184, 119, 217)'}
                onChange={(color: string) => handleOptsSettingChange(marker.id, 'color', color)}
                />
              </div>
            {/* Dropdown for Shape */}
            <div style={{ minWidth: '120px', padding: '5px' }}>
              <Field label={t('barchart.barmarkers-editor.shape', 'Shape')}>
                <Select
            options={shapeOptions}
            value={marker.opts.shape ?? 'line'}
            onChange={(v) =>
              handleOptsSettingChange(marker.id, 'shape', v.value!)
            }
            placeholder={t('barchart.barmarkers-editor.shape-placeholder', 'Select Shape')}
                />
              </Field>
            </div>
            <div style={{ minWidth: '120px', padding: '5px' }}>
                <Field label={t('barchart.barmarkers-editor.width', 'Width')}>
                <Slider
                  min={0}
                  max={2}
                  step={0.01}
                  value={marker.opts.width ?? 1}
                  onChange={(v) => handleOptsSettingChange(marker.id, 'width', typeof v === 'number' ? v : v[0])}
                />
                </Field>
          </div>
          </div>
        ))}
    </div>
    
  );
};
// Code generated by copilot
// Code generated by copilot
const getStyles = (theme: GrafanaTheme2) => ({
  button: css({
    marginBottom: theme.spacing(1),
    color: theme.colors.text.primary,
    background: theme.colors.action.selected,
    border: `1px solid ${theme.colors.border.medium}`,
  }),
  markerWrapper: css({
    marginTop: theme.spacing(2),
    border: `1px dashed ${theme.colors.background.secondary}`,
    padding: theme.spacing(2),
    borderRadius: theme.shape.borderRadius(),
    position: 'relative',
  }),
  removeButton: css({
    position: 'absolute',
    top: theme.spacing(1),
    right: theme.spacing(1),
  }),
  field: css({
    marginBottom: theme.spacing(1),
  }),
  slider: css({
    width: '100%',
    marginTop: theme.spacing(1),
    
  }),
});
// End of copilot-generated code