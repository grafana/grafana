name: Check Fronted Test Coverage

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    paths:
      - '**/*.js'
      - '**/*.jsx'
      - '**/*.ts'
      - '**/*.tsx'
      - 'package.json'
      - '.github/CODEOWNERS'

permissions: {}

jobs:
  setup:
    name: Setup opted-in teams
    runs-on: ubuntu-x64-small
    outputs:
      # NOTE: Only checks test coverage for opted-in codeowners.
      #       Please add the GitHub user/team or email used in
      #       CODEOWNERS to the list below to opt-in.
      opted-in-teams: >-
        [
          "@grafana/datapro",
          "@grafana/dataviz-squad"
        ]
    steps:
      - name: Define opted-in teams
        run: echo "Opted-in teams defined in job outputs"

  detect-changes:
    name: Detect changed files
    runs-on: ubuntu-x64-small
    permissions:
      contents: read
    outputs:
      changed-files: ${{ steps.changed-files.outputs.all_changed_files }}
    steps:
      - uses: actions/checkout@v5
        with:
          persist-credentials: true
          fetch-depth: 2

      - name: Detect changed files
        id: changed-files
        uses: tj-actions/changed-files@ed68ef82c095e0d48ec87eccea555d944a631a4c # v46
        with:
          separator: ' '

      - name: Display changed files
        run: |
          echo "=== Changed Files Detected ==="
          echo "${{ steps.changed-files.outputs.all_changed_files }}"
          echo "=============================="

  cleanup-on-skip:
    name: Cleanup coverage comments
    needs: setup
    if: contains(github.event.pull_request.labels.*.name, 'no-check-frontend-test-coverage')
    runs-on: ubuntu-x64-small
    permissions:
      pull-requests: write
    strategy:
      fail-fast: false
      matrix:
        codeowner: ${{ fromJSON(needs.setup.outputs.opted-in-teams) }}
    steps:
      - name: Delete coverage comment for ${{ matrix.codeowner }}
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2.9.4
        with:
          header: coverage-report-${{ matrix.codeowner }}
          delete: true

  generate-slugs:
    name: Generate slug for ${{ matrix.codeowner }}
    needs: setup
    if: "!contains(github.event.pull_request.labels.*.name, 'no-check-frontend-test-coverage')"
    runs-on: ubuntu-x64-small
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        codeowner: ${{ fromJSON(needs.setup.outputs.opted-in-teams) }}
    steps:
      - uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: ./.github/actions/setup-node

      - name: Generate slug for ${{ matrix.codeowner }}
        run: |
          SLUG=$(node -e "
            const { createCodeownerSlug } = require('./scripts/codeowners-manifest/utils.js');
            console.log(createCodeownerSlug('${{ matrix.codeowner }}'));
          ")

          echo "=== Codeowner Slug Generated ==="
          echo "Codeowner: ${{ matrix.codeowner }}"
          echo "Slug: $SLUG"
          echo "================================"
