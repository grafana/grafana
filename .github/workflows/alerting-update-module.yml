name: Update Alerting Module

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update-grafana:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if update branch exists
        run: |
          if git ls-remote --heads origin update-alerting-module | grep -q 'update-alerting-module'; then
            echo "Branch 'update-alerting-module' already exists. There might be an open PR with Grafana updates."
            echo "Please review and merge/close the existing PR before running this workflow again."
            exit 1
          fi

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          "go-version-file": "go.mod"

      - name: Extract current commit hash of alerting module
        id: current-commit
        run: |
          FROM_COMMIT=$(go list -m -json github.com/grafana/alerting | jq -r '.Version' | grep -oP '(?<=-)[a-f0-9]+$')
          echo "from_commit=$FROM_COMMIT" >> $GITHUB_OUTPUT

      - name: Get latest commit
        id: latest-commit
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TO_COMMIT=$(gh api repos/grafana/alerting/commits/main --jq '.sha')
          if [ -z "$TO_COMMIT" ]; then
            echo "Failed to fetch latest commit"
            exit 1
          fi
          echo "to_commit=$TO_COMMIT" >> $GITHUB_OUTPUT

      - name: Compare commit hashes
        run: |
          FROM_COMMIT="${{ steps.current-commit.outputs.from_commit }}"
          TO_COMMIT="${{ steps.latest-commit.outputs.to_commit }}"
          
          # Compare just the length of the shorter hash
          SHORT_TO_COMMIT="${TO_COMMIT:0:${#FROM_COMMIT}}"
          
          if [ "$FROM_COMMIT" = "$SHORT_TO_COMMIT" ]; then
            echo "Current version ($FROM_COMMIT) is already at latest ($SHORT_TO_COMMIT). No update needed."
            exit 0
          fi
          echo "Updates available: $FROM_COMMIT -> $TO_COMMIT"

      - name: Check for commit history
        id: check-commits
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # get all commits that contains 'Alerting:' in the message          
          ALERTING_COMMITS=$(gh api repos/grafana/alerting/compare/${{ steps.current-commit.outputs.from_commit }}...${{ steps.latest-commit.outputs.to_commit }} \
            --jq '.commits[].commit.message | split("\n")[0]') || true
          
          # Use printf instead of echo -e for better multiline handling
          printf "%s\n" "$ALERTING_COMMITS"
          
          # make the list for markdown and replace PR numbers with links
          ALERTING_COMMITS_FORMATTED=$(echo "$ALERTING_COMMITS" | while read -r line; do echo "- $line" | sed -E 's/\(#([0-9]+)\)/[#\1](https:\/\/github.com\/grafana\/grafana\/pull\/\1)/g'; done)
          
          echo "alerting_commits<<EOF" >> $GITHUB_OUTPUT
          echo "$ALERTING_COMMITS_FORMATTED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update alerting module
        env:
          GOSUMDB: off
        run: |
          go get github.com/grafana/alerting@${{ steps.latest-commit.outputs.to_commit }}
          make update-workspace

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        id: create-pr
        with:
          token: '${{ github.token }}'
          title:  'Alerting: Update alerting module to ${{ steps.latest-commit.outputs.to_commit }}'
          branch: alerting/update-alerting-module
          delete-branch: true
          body: |
            Updates Grafana Alerting module to latest version.

            Compare changes: https://github.com/grafana/alerting/compare/${{ steps.current-commit.outputs.from_commit }}...${{ steps.latest-commit.outputs.to_commit }}
            <details>
            <summary>Commits</summary>
            
            ${{ steps.check-commits.outputs.alerting_commits }}

            </details>

            Created by: [GitHub Action Job](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
      - name: Add PR URL to Summary
        if: steps.create-pr.outputs.pull-request-url != ''
        run: |
          echo "## Pull Request Created" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View Pull Request](${{ steps.create-pr.outputs.pull-request-url }})" >> $GITHUB_STEP_SUMMARY