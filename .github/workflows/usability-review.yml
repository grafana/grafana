name: Usability Review Agent

on:
  pull_request:
    types:
      - labeled

permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write

env:
  TARGET_URL: https://ephemeral15111821114646titoli.grafana-dev.net
  OUTPUT_TEXT_PATH: usability-review.txt
  SCREENSHOT_PATH: usability-screenshot.png

jobs:
  usability-review:
    # Only run when the 'usability-review' label is added
    if: github.event.label.name == 'usability-review'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Get vault secrets (ops)"
        id: vault-secrets-ops
        uses: grafana/shared-workflows/actions/get-vault-secrets@get-vault-secrets/v1.3.0
        with:
          repo_secrets: |
            GCOM_HOST=ephemeral-instances-bot:gcom-host
            GCOM_TOKEN=ephemeral-instances-bot:gcom-token

      - name: "Get vault secrets (dev)"
        id: vault-secrets-dev
        uses: grafana/shared-workflows/actions/get-vault-secrets@get-vault-secrets/v1.3.0
        with:
          vault_instance: "dev"
          repo_secrets: |
            OPENAI_API_KEY=usability-review-agent:OPENAI_API_KEY
            # Using pre-created user credentials (see SETUP.md for manual setup steps)
            # Remove these if stack-users:write token becomes available
            GRAFANA_USERNAME=usability-review-agent:USERNAME
            GRAFANA_PASSWORD=usability-review-agent:PASSWORD

      - name: Verify credentials retrieved
        run: |
          echo "Username length: ${#GRAFANA_USERNAME}"
          echo "Password length: ${#GRAFANA_PASSWORD}"
          echo "Username ends with: ...${GRAFANA_USERNAME: -3}"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install OpenAI package
        run: |
          python -m pip install -U pip
          pip install openai

      - name: Get PR details
        id: pr-details
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # Get PR title, body, and changed files
          PR_DATA=$(gh pr view $PR_NUMBER --json title,body,files)

          PR_TITLE=$(echo "$PR_DATA" | jq -r '.title')
          PR_BODY=$(echo "$PR_DATA" | jq -r '.body // ""')

          # Get list of changed files
          CHANGED_FILES=$(echo "$PR_DATA" | jq -r '.files[].path' | head -20)

          # Save to files for next step
          echo "$PR_TITLE" > pr_title.txt
          echo "$PR_BODY" > pr_body.txt
          echo "$CHANGED_FILES" > changed_files.txt

          echo "PR Title: $PR_TITLE"
          echo "Changed files count: $(echo "$CHANGED_FILES" | wc -l)"

      - name: Generate PR summary
        id: pr-summary
        env:
          OPENAI_API_KEY: ${{ env.OPENAI_API_KEY }}
        run: |
          python - <<'PY'
          import os
          from openai import OpenAI

          client = OpenAI()

          # Read PR details
          with open("pr_title.txt", "r") as f:
              pr_title = f.read().strip()

          with open("pr_body.txt", "r") as f:
              pr_body = f.read().strip()

          with open("changed_files.txt", "r") as f:
              changed_files = f.read().strip()

          # Generate summary of what the PR does
          system = "You are a technical analyst summarizing pull request changes."
          user = f"""Analyze this PR and provide a 2-3 sentence summary of what feature/change is being implemented:

          PR Title: {pr_title}

          PR Description: {pr_body if pr_body else "(No description provided)"}

          Changed Files:
          {changed_files}

          Focus on what the user-facing impact is and what functionality is being added or modified."""

          resp = client.chat.completions.create(
              model="gpt-4o-mini",
              messages=[
                  {"role": "system", "content": system},
                  {"role": "user", "content": user},
              ],
          )
          pr_summary = resp.choices[0].message.content.strip()

          with open("pr_summary.txt", "w") as f:
              f.write(pr_summary)

          print(f"PR Summary: {pr_summary}")
          PY

      - name: Build dynamic prompt
        id: build-prompt
        run: |
          # Read the PR summary
          PR_SUMMARY=$(cat pr_summary.txt)

          # Read base prompt template from action
          BASE_PROMPT=$(cat .github/actions/usability-review-agent/prompt.txt)

          # Build dynamic prompt with PR context
          cat > dynamic_prompt.txt <<EOF
          ## Context
          You are reviewing a pull request that makes the following changes:

          $PR_SUMMARY

          Your task is to test the workflow and provide usability feedback.

          ## Instructions
          $BASE_PROMPT
          EOF

          # Copy to action directory so it can be used
          cp dynamic_prompt.txt .github/actions/usability-review-agent/dynamic_prompt.txt

          echo "Dynamic prompt created"

      - name: Extract instance slug from URL
        run: |
          INSTANCE_SLUG=$(echo "${{ env.TARGET_URL }}" | sed -E 's|https?://([^.]+)\..*|\1|')
          echo "Instance slug: $INSTANCE_SLUG"
          echo "INSTANCE_SLUG=$INSTANCE_SLUG" >> $GITHUB_ENV

      - name: Enable basic auth on instance
        env:
          GCOM_HOST: ${{ env.GCOM_HOST }}
          GCOM_TOKEN: ${{ env.GCOM_TOKEN }}
          INSTANCE_SLUG: ${{ env.INSTANCE_SLUG }}
        run: |
          # Check current config
          CURRENT_CONFIG=$(curl -s "${GCOM_HOST}/api/instances/${INSTANCE_SLUG}/config" \
            -H "Authorization: Bearer ${GCOM_TOKEN}")

          DISABLE_LOGIN_FORM=$(echo "$CURRENT_CONFIG" | jq -r '.auth.disable_login_form // true')
          echo "Current disable_login_form: $DISABLE_LOGIN_FORM"

          if [ "$DISABLE_LOGIN_FORM" != "false" ]; then
            echo "Enabling basic auth..."
            curl -X POST "${GCOM_HOST}/api/instances/${INSTANCE_SLUG}/config" \
              -H "Authorization: Bearer ${GCOM_TOKEN}" \
              -H "Content-Type: application/x-www-form-urlencoded" \
              -d 'config[auth][disable_login_form]=false'

            echo "Waiting for pod restart..."
            sleep 300

            # Verify instance is ready
            for i in {1..10}; do
              if curl -sf https://${INSTANCE_SLUG}.grafana-dev.net/api/health; then
                echo "Instance ready!"
                break
              fi
              echo "Attempt $i failed, waiting..."
              sleep 10
            done
          else
            echo "Basic auth already enabled, skipping..."
          fi

      - name: Create test user for playwright
        # NOTE: Temporarily disabled - using pre-created user from Vault instead
        # Re-enable this if stack-users:write token becomes available
        if: false
        env:
          GCOM_HOST: ${{ env.GCOM_HOST }}
          GCOM_TOKEN: ${{ env.GCOM_TOKEN }}
          INSTANCE_SLUG: ${{ env.INSTANCE_SLUG }}
        run: |
          pip install requests
          python3 <<'PYTHON'
          import os, requests, json, random, string

          gcom_host = os.environ['GCOM_HOST']
          gcom_token = os.environ['GCOM_TOKEN']
          instance = os.environ['INSTANCE_SLUG']

          # Generate random password
          password = ''.join(random.choices(string.ascii_letters + string.digits, k=16))

          # Create user via GCOM API (proxies to instance /api/admin/users)
          resp = requests.post(
              f"{gcom_host}/api/instances/{instance}/api/admin/users",
              headers={"Authorization": f"Bearer {gcom_token}"},
              json={"name": "Playwright Test", "login": "playwright-test", "password": password}
          )
          resp.raise_for_status()
          user_id = resp.json()['id']

          # Make user admin via GCOM API (proxies to instance)
          requests.put(
              f"{gcom_host}/api/instances/{instance}/api/admin/users/{user_id}/permissions",
              headers={"Authorization": f"Bearer {gcom_token}"},
              json={"isGrafanaAdmin": True}
          )

          # Export credentials directly to environment
          with open(os.environ['GITHUB_ENV'], 'a') as env_file:
              env_file.write(f"GRAFANA_USERNAME=playwright-test\n")
              env_file.write(f"GRAFANA_PASSWORD={password}\n")

          print(f"Created user: playwright-test")
          PYTHON

      - name: Run usability review agent
        uses: ./.github/actions/usability-review-agent
        with:
          target_url: ${{ env.TARGET_URL }}
          openai_api_key: ${{ env.OPENAI_API_KEY }}
          grafana_username: ${{ env.GRAFANA_USERNAME }}
          grafana_password: ${{ env.GRAFANA_PASSWORD }}
          workflow_name: "the application interface"
          prompt_file: "dynamic_prompt.txt"
          output_text_path: ${{ env.OUTPUT_TEXT_PATH }}
          screenshot_path: ${{ env.SCREENSHOT_PATH }}

      - name: Upload review artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: usability-review-results
          path: |
            ${{ env.OUTPUT_TEXT_PATH }}
            ${{ env.SCREENSHOT_PATH }}
            login_page.png
            login_error.png
          if-no-files-found: warn
          retention-days: 7

      - name: Post review results to PR
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          RUN_ID: ${{ github.run_id }}
        run: |
          COMMENT_FILE=$(mktemp)

          echo "## ðŸ” Usability Review Results" > "$COMMENT_FILE"
          echo "" >> "$COMMENT_FILE"
          echo "**Target URL:** ${{ env.TARGET_URL }}" >> "$COMMENT_FILE"
          echo "" >> "$COMMENT_FILE"
          echo "---" >> "$COMMENT_FILE"
          echo "" >> "$COMMENT_FILE"

          if [ -s ${{ env.OUTPUT_TEXT_PATH }} ]; then
            cat ${{ env.OUTPUT_TEXT_PATH }} >> "$COMMENT_FILE"
          else
            echo "âš ï¸ No review output was generated." >> "$COMMENT_FILE"
          fi

          echo "" >> "$COMMENT_FILE"
          echo "---" >> "$COMMENT_FILE"
          echo "" >> "$COMMENT_FILE"
          echo "ðŸ“¸ [View screenshot and full artifacts](https://github.com/${{ github.repository }}/actions/runs/$RUN_ID)" >> "$COMMENT_FILE"

          gh pr comment $PR_NUMBER --body-file "$COMMENT_FILE"
          rm "$COMMENT_FILE"

      - name: Post individual suggestions as separate comments
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          OUTPUT_TEXT_PATH: ${{ env.OUTPUT_TEXT_PATH }}
        run: |
          python3 <<'PYTHON'
          import os
          import subprocess
          import re

          # Read the AI output
          output_path = os.environ['OUTPUT_TEXT_PATH']
          if not os.path.exists(output_path) or os.path.getsize(output_path) == 0:
              print("No output file found, skipping individual comments")
              exit(0)

          with open(output_path, 'r') as f:
              content = f.read()

          # Extract table rows (skip header and separator)
          table_pattern = r'\|([^|]+)\|([^|]+)\|([^|]+)\|([^|]+)\|'
          matches = re.findall(table_pattern, content)

          if len(matches) < 3:
              print(f"Not enough table rows found ({len(matches)}), skipping individual comments")
              exit(0)

          # Skip first 2 matches (header + separator)
          issue_rows = matches[2:5]  # Get exactly 3 issues

          pr_number = os.environ['PR_NUMBER']

          for severity, issue, impact, suggestion in issue_rows:
              # Clean up whitespace
              severity = severity.strip()
              issue = issue.strip()
              impact = impact.strip()
              suggestion = suggestion.strip()

              # Create individual comment
              comment = f"""### {severity}: {issue}

**Impact:** {impact}

**Suggestion:** {suggestion}

---
_Posted by Usability Review Agent_"""

              # Post comment
              subprocess.run(
                  ['gh', 'pr', 'comment', pr_number, '--body', comment],
                  check=True
              )
              print(f"Posted comment for: {issue}")

          PYTHON
