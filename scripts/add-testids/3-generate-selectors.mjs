#!/usr/bin/env node

/**
 * Phase 3: Generate E2E Selectors Package Code
 *
 * Updates the @grafana/e2e-selectors package with new selector definitions
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import {
  buildSelectorTree,
  generateSelectorCode,
  groupByFeatureArea,
  sortSelectors,
  generateMarkdownDocs,
  validateUniqueness,
} from './utils/selector-generator.mjs';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const WORKSPACE_ROOT = path.resolve(__dirname, '../..');
const SELECTORS_PATH = path.join(__dirname, 'output/2-selectors.json');
const COMPONENTS_FILE = path.join(WORKSPACE_ROOT, 'packages/grafana-e2e-selectors/src/selectors/components.ts');
const OUTPUT_PATH = path.join(__dirname, 'output/3-selector-code.ts');
const DOCS_PATH = path.join(__dirname, 'output/3-selectors-docs.md');

// Load selectors
const selectorsData = JSON.parse(fs.readFileSync(SELECTORS_PATH, 'utf8'));

/**
 * Main execution
 */
function main() {
  console.log('üîç Phase 3: Generate E2E Selectors Package Code\n');

  const selectors = selectorsData.selectors;

  // Validate uniqueness
  console.log('Validating selector uniqueness...');
  const validation = validateUniqueness(selectors);

  if (!validation.isValid) {
    console.error(`\n‚ùå Found ${validation.duplicates.length} duplicate selectors:`);
    validation.duplicates.forEach((dup) => {
      console.error(`  - ${dup.selectorPath} (${dup.sourceFile})`);
    });
    console.error('\nPlease resolve duplicates before proceeding.\n');
    process.exit(1);
  }

  console.log('‚úÖ All selectors are unique\n');

  // Build selector tree
  console.log('Building selector tree...');
  const tree = buildSelectorTree(selectors);

  // Generate TypeScript code
  console.log('Generating TypeScript code...');
  const code = generateSelectorCode(tree, 1);

  // Create full file content
  const fileContent = `/**
 * Auto-generated selector definitions
 *
 * Generated by: scripts/add-testids/3-generate-selectors.mjs
 * Generated at: ${new Date().toISOString()}
 * Total selectors: ${selectors.length}
 *
 * DO NOT EDIT THIS FILE MANUALLY
 * To add new selectors, run: node scripts/add-testids/1-discover.mjs
 */

export const autoGeneratedComponents = {
${code}
};
`;

  // Save generated code
  fs.writeFileSync(OUTPUT_PATH, fileContent, 'utf8');

  // Generate documentation
  console.log('Generating documentation...');
  const docs = generateMarkdownDocs(selectors);
  fs.writeFileSync(DOCS_PATH, docs, 'utf8');

  // Print results
  console.log('\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
  console.log('üìä CODE GENERATION RESULTS');
  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');

  console.log(`Selectors processed:                 ${selectors.length.toLocaleString()}`);
  console.log(`Feature areas:                       ${Object.keys(tree).length.toLocaleString()}`);
  console.log(`Code lines generated:                ${fileContent.split('\n').length.toLocaleString()}\n`);

  console.log('Generated Files:');
  console.log(`  - TypeScript code: ${path.relative(WORKSPACE_ROOT, OUTPUT_PATH)}`);
  console.log(`  - Documentation:   ${path.relative(WORKSPACE_ROOT, DOCS_PATH)}\n`);

  // Show sample of generated code
  console.log('üìù Sample Generated Code:\n');
  const sampleLines = fileContent.split('\n').slice(0, 30);
  sampleLines.forEach((line) => console.log(`  ${line}`));
  console.log('  ...\n');

  console.log('üí° NEXT STEPS:\n');
  console.log('1. Review the generated TypeScript code in output/3-selector-code.ts');
  console.log('2. Manually merge into packages/grafana-e2e-selectors/src/selectors/components.ts');
  console.log('3. Run: yarn workspace @grafana/e2e-selectors build');
  console.log('4. Proceed to Phase 4 to update source files\n');

  console.log('‚ö†Ô∏è  IMPORTANT: The generated code needs manual review before merging!\n');
}

main();
