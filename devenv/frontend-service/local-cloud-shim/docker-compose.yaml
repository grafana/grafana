name: grafana-fs-dev-shim

services:
  proxy:
    image: grafana-proxy
    build:
      context: ../
      dockerfile: proxy.dockerfile
    volumes:
      - ../../../public/build:/cdn/public/build
      - ../../../public/app/plugins:/cdn/public/app/plugins
      - ../../../public/fonts:/cdn/public/fonts
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
      - ./mock-data:/etc/nginx/mock-data:ro
    ports:
      - "12345:80" # Gateway
      - "3010:81" # CDN
    depends_on:
      - frontend-service
    labels:
      - "alloy.logs=true"

  frontend-service:
    image: grafana-fs-dev
    build:
      context: ../../..
      dockerfile: devenv/frontend-service/grafana-fs-dev.dockerfile
    entrypoint: ["bin/grafana", "server", "target"]
    volumes:
      - ../configs/frontend-service.local.ini:/grafana/conf/custom.ini
    # Port 3000 is only accessible via the proxy, not directly exposed
    labels:
      - "alloy.logs=true"
    environment:
      OTEL_BSP_SCHEDULE_DELAY: 500
      GF_DATABASE_SKIP_MIGRATIONS: true
      GF_DATABASE_ENSURE_DEFAULT_ORG_AND_USER: false
      GF_DEFAULT_APP_MODE: development
      GF_DEFAULT_TARGET: frontend-server
      GF_SECURITY_CONTENT_SECURITY_POLICY: false
      GF_FEATURE_TOGGLES_ENABLE: enableNativeHTTPHistogram
      GF_SERVER_CDN_URL: http://localhost:3010
      GF_SERVER_ROUTER_LOGGING: true
      GF_LOG_LEVEL: info
      OTEL_SERVICE_NAME: frontend-service
      GF_TRACING_OPENTELEMETRY_OTLP_ADDRESS: "alloy:4317"
      GF_TRACING_OPENTELEMETRY_OTLP_PROPAGATION: jaeger,w3c
