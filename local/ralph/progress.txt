# Ralph Progress Log
Started: Tue Feb 17 14:02:44 CET 2026

## Codebase Patterns
- Explore state uses `createAction()` from Redux Toolkit (not `createSlice()` due to ImmerJs autoFreeze conflict with flot graph lib)
- Reducers are composed in `paneReducer` via sequential calls: `queryReducer`, `datasourceReducer`, `timeReducer`, etc.
- Action matching uses `actionName.match(action)` pattern in reducers
- Explore pane state type is `ExploreItemState` in `public/app/types/explore.ts`
- Initial state factory is `makeExplorePaneState()` in `public/app/features/explore/state/utils.ts`
- All actions include `exploreId` in their payload for pane scoping
- TypeScript typecheck: `npx tsc --noEmit` from repo root
- All text strings in UI components must use `t()` or `<Trans>` for i18n (eslint rule: `@grafana/i18n/no-untranslated-strings`)
- `Field` components require `noMargin` prop (eslint rule: `no-restricted-syntax`)
- Import order is enforced by eslint — keep `./state/*` imports alphabetical
- `runQueries` in `query.ts` already receives `scopedVars` from `getCorrelationsData()` — merge additional vars into this object before passing to `buildQueryTransaction()`
- `ScopedVars` format: `{ [name]: { text: value, value: value } }` — defined in `@grafana/data`
- `ExploreItemState.variableSet` is a `SceneVariableSet` instance from `@grafana/scenes`
- `SceneVariableSet` manages scene variables and fires `SceneVariableValueChangedEvent` when values change
- `CustomVariable` from `@grafana/scenes` stores values as comma-separated `query` string and uses `getValue()`/`getValueText()` for access
- `variable.useState()` hook provides reactive state access to scene variable properties
- `getVariableScene(type, initialState)` in `dashboard-scene/settings/variables/utils.ts` is the factory for creating typed scene variables
- `getNextAvailableId(type, variables)` generates unique names like `query0`, `custom1`
- `buildExploreVariableScopedVars()` in `state/variables.ts` converts `SceneVariableSet` to `ScopedVars` for query interpolation
- Do not use `as` type assertions in ESLint-strict files — use `String()`, `instanceof` checks, or type guards instead
- `@grafana/scenes` imports must be in their own import group (between `@grafana/runtime` and `@grafana/schema`/`@grafana/ui`)
- `Card` components require `noMargin` prop (eslint rule: `no-restricted-syntax`), same as `Field`
- `Drawer` from `@grafana/ui` accepts `title`, `onClose`, `size` ('md', 'lg', 'xl') props and renders children as content
- `VariableEditorForm` from dashboard-scene requires variable to have a parent `SceneVariableSet` (for `validateVariableName`)
- `SceneObjectBase` constructor calls `_setParent()` which sets `._parent` on all child scene objects — so creating `new SceneVariableSet({ variables: [v] })` automatically sets `v.parent` to the set
- `replaceVariableAction` in `state/variables.ts` replaces a variable by name in the `SceneVariableSet` (for type changes)
- Explore variable UI components live in `public/app/features/explore/Variables/`
- Import ordering: `./Variables/*` imports go after `./ShortLinkButtonMenu` and before `./extensions/*`
- `SceneVariable.useState()` returns `SceneVariableState` (no `value` field) — use `variable.getValue()` for generic value access; only typed hooks like `CustomVariable.useState()` expose type-specific fields
- `ConstantVariable` instances should be hidden from toolbar dropdowns — filter with `!(v instanceof ConstantVariable)`
- `getDefinition()` from `dashboard-scene/settings/variables/utils.ts` returns human-readable definition strings per variable type
- `ConfirmModal` from `@grafana/ui` is used for delete confirmations — render outside the Drawer using fragments
- `jest-fail-on-console` is active — any `console.warn`/`console.error` will fail tests; mock them with `jest.spyOn` when warnings are expected
- `SceneVariableSet` must be activated (`.activate()`) before events like `SceneVariableValueChangedEvent` will fire
- `CustomVariable.changeValueTo(value, text)` programmatically changes a variable's value
- For explore component tests: use `TestProvider` with `configureStore()` and set `store.getState().explore.panes = { left: makeExplorePaneState() }`
- `getDataSourceSrv` mock must include `meta.info.logos.{small,large}` for QueryVariable editor to render
- Variable type display names from `getEditableVariables()`: 'Custom', 'Query', 'Textbox', 'Constant'
- Explore pane IDs are dynamically generated — in integration tests use `Object.keys(store.getState().explore.panes)[0]` instead of hardcoded 'left'
- `setupExplore()` requires `act()` wrappers around Redux dispatches and `jest.spyOn(console, 'error').mockImplementation()` to suppress React act() warnings
- `ExploreVariableEditor` props: `initialView?: 'list' | 'editor'` controls opening mode; 'list' opens list view (if variables exist), 'editor' opens type selection (for new variable)
- In integration tests, `ToolbarButton` text is best found via `screen.getByText()` rather than `getByRole('button', { name })` because accessible name computation may differ
---

## 2026-02-17 - US-001
- Implemented explore variables state management
- Files changed:
  - `public/app/types/explore.ts` - Added `ExploreVariable` interface and `variables` field to `ExploreItemState`
  - `public/app/features/explore/state/variables.ts` - New file with `addVariableAction`, `removeVariableAction`, `updateVariableSelectedValueAction` and `variablesReducer`
  - `public/app/features/explore/state/explorePane.ts` - Integrated `variablesReducer` into `paneReducer`
  - `public/app/features/explore/state/utils.ts` - Added `variables: []` to initial pane state
- **Learnings for future iterations:**
  - Each sub-reducer in Explore receives the full `ExploreItemState` and returns a new state, composed sequentially in `paneReducer`
  - Variables are scoped per pane because each pane gets its own `ExploreItemState` instance
  - `addVariable` auto-selects the first value via `selectedValue: values[0]`
---

## 2026-02-17 - US-002
- Added 'Add variable' button and creation dialog to ExploreToolbar
- Files changed:
  - `public/app/features/explore/AddVariableDialog.tsx` - New component: Modal dialog with name input, dynamic value list (add/remove), and form validation
  - `public/app/features/explore/ExploreToolbar.tsx` - Added 'Add variable' button in leftItems after ToolbarExtensionPoint, wired up dialog state and addVariableAction dispatch
- **Learnings for future iterations:**
  - All text strings must be wrapped with `t()` or `<Trans>` from `@grafana/i18n` — eslint enforces this strictly
  - `Field` components from `@grafana/ui` require `noMargin` prop — spacing should be handled via layout components like `Stack`
  - Import order in explore files is enforced: `./state/*` imports must be alphabetically ordered
  - The `AddToDashboard` component in `public/app/features/explore/extensions/AddToDashboard/index.tsx` is a good pattern reference for toolbar button + modal combos
---

## 2026-02-17 - US-003
- Displayed variable selector dropdowns in Explore toolbar
- Files changed:
  - `public/app/features/explore/ExploreToolbar.tsx` - Added `Select` import, `variables` selector from Redux store, `updateVariableSelectedValueAction` import, and rendered Select dropdowns in leftItems after the Add variable button
- **Learnings for future iterations:**
  - `@grafana/ui` `Select` component accepts `prefix` prop (type: `JSX.Element | string | null`) — useful for labeling dropdowns with variable names like `$job`
  - `Select` with `width="auto"` auto-sizes to content, good for toolbar items
  - Spread operator (`...array.map(...)`) works well for injecting dynamic items into JSX arrays
  - The i18n ESLint rule targets JSX text content, not prop string values passed to library components
---

## 2026-02-17 - US-004
- Interpolated explore variables into queries and added auto-refresh on variable change
- Files changed:
  - `public/app/features/explore/state/query.ts` - Converted explore variables from `ExploreItemState.variables` to `ScopedVars` format and merged into the scopedVars passed to `buildQueryTransaction()` in `runQueries`
  - `public/app/features/explore/ExploreToolbar.tsx` - Added `dispatch(runQueries({ exploreId }))` after dispatching `updateVariableSelectedValueAction` in the Select onChange handler
- **Learnings for future iterations:**
  - `runQueries` already gets `scopedVars` from `getCorrelationsData()` for correlation editor — explore variables need to be merged into this, not replace it
  - `buildQueryTransaction()` in `explore.ts` spreads `scopedVars` into the request's `scopedVars` after `__interval` and `__interval_ms`, so our variables are available for template interpolation
  - The template service (`getTemplateSrv()`) handles `$var` and `${var}` interpolation — variables in `scopedVars` are checked first during replacement
  - Dispatching `runQueries` immediately after `updateVariableSelectedValueAction` works because Redux dispatches are synchronous — the state update from the variable action is applied before `runQueries` reads the state
---

## 2026-02-17 - US-005
- Migrated explore variables from Redux `ExploreVariable[]` to `SceneVariableSet` from `@grafana/scenes`
- Files changed:
  - `public/app/types/explore.ts` - Removed `ExploreVariable` interface, replaced `variables: ExploreVariable[]` with `variableSet: SceneVariableSet`
  - `public/app/features/explore/state/variables.ts` - Rewrote to create `CustomVariable` instances in a `SceneVariableSet`; removed `updateVariableSelectedValueAction` (value changes now go through `variable.setState()` directly); added `buildExploreVariableScopedVars()` helper
  - `public/app/features/explore/state/utils.ts` - Initialize `variableSet: new SceneVariableSet({ variables: [] })` per pane
  - `public/app/features/explore/state/query.ts` - Use `buildExploreVariableScopedVars(exploreItemState.variableSet)` for ScopedVars construction
  - `public/app/features/explore/ExploreToolbar.tsx` - Read variables from `SceneVariableSet`; render `ExploreVariableSelect` component using `variable.useState()` hook; subscribe to `SceneVariableValueChangedEvent` for auto-refresh
- **Learnings for future iterations:**
  - `SceneVariableSet` is a mutable scene object — in Redux reducers, create a new `SceneVariableSet` instance to trigger re-renders (don't mutate in place)
  - `CustomVariable` stores values as CSV in `query` property and derives `options` from it
  - `variable.useState()` is the React hook for reactive access to scene variable state — components re-render automatically when variable state changes
  - `SceneVariableValueChangedEvent` is fired when `variable.setState()` changes value/text — subscribe on the `SceneVariableSet` to catch all variable changes
  - ESLint forbids `as` type assertions — use `instanceof` type guards (e.g., `v instanceof CustomVariable`) and `String()` conversions instead
  - Import group ordering: `@grafana/scenes` goes between `@grafana/runtime` and `@grafana/schema`/`@grafana/ui` — no empty lines within a group
---

## 2026-02-17 - US-006
- Created Drawer-based variable editor with type selection and VariableEditorForm
- Files changed:
  - `public/app/features/explore/Variables/ExploreVariableTypeSelection.tsx` - New component: shows 4 type cards (custom, query, textbox, constant) using `getEditableVariables()` config
  - `public/app/features/explore/Variables/ExploreVariableEditor.tsx` - New component: Drawer with type selection → editor form flow, manages variable lifecycle (add/replace/delete) via Redux actions
  - `public/app/features/explore/ExploreToolbar.tsx` - Replaced `AddVariableDialog` modal with `ExploreVariableEditor` Drawer; removed `addVariableAction` import and `onAddVariable` callback
  - `public/app/features/explore/state/variables.ts` - Renamed `addVariableAction` → `addSceneVariableAction` (takes a `SceneVariable` directly instead of name/values); added `replaceVariableAction` for type changes; removed `CustomVariable`-specific logic
  - `public/app/features/explore/AddVariableDialog.tsx` - Deleted (replaced by Drawer-based editor)
- **Learnings for future iterations:**
  - `Card` components from `@grafana/ui` require `noMargin` prop (same ESLint rule as `Field`)
  - `Drawer` from `@grafana/ui` takes `title`, `onClose`, `size` props — children are rendered as drawer content
  - `VariableEditorForm` from dashboard-scene requires the variable to have a parent `SceneVariableSet` — this happens automatically when constructing `new SceneVariableSet({ variables: [variable] })` because `SceneObjectBase._setParent()` is called in the constructor
  - `getVariableScene(type, { name })` creates a proper typed variable (CustomVariable, QueryVariable, etc.) — no need to manually construct each type
  - `getNextAvailableId(type, variables)` generates unique names like `custom0`, `query1` — use this when creating new variables
  - Import ordering in explore: `./Variables/*` imports go after `./ShortLinkButtonMenu` and before `./extensions/*`
---

## 2026-02-17 - US-007
- Added gear icon next to each variable dropdown in toolbar for editing
- Created ExploreVariableListView component showing all variables with name, type, definition
- Updated ExploreVariableEditor to show list view when variables exist, type selection when empty
- Added delete confirmation modal (ConfirmModal from @grafana/ui)
- Constant variables are hidden from toolbar dropdowns (filtered out with `instanceof ConstantVariable`)
- Clicking gear icon in toolbar opens Drawer with VariableEditorForm pre-populated
- Files changed:
  - `public/app/features/explore/ExploreToolbar.tsx` - Added gear icon (IconButton with 'cog'), split ExploreVariableSelect into Custom and Generic variants, filter out ConstantVariable from toolbar, pass `initialVariable` and `editingVariable` state to ExploreVariableEditor
  - `public/app/features/explore/Variables/ExploreVariableEditor.tsx` - Rewritten with three views (list/typeSelection/editor), initialVariable prop, delete confirmation via ConfirmModal, back navigation between views
  - `public/app/features/explore/Variables/ExploreVariableListView.tsx` - New component: table with variable name, type, definition (using getDefinition from dashboard-scene), edit/delete actions per row, empty state CTA, 'New variable' button
- **Learnings for future iterations:**
  - `SceneVariable.useState()` returns `SceneVariableState` which does NOT have `value` — use `variable.getValue()` for generic access; only `CustomVariable.useState()` has `value` and `options`
  - For toolbar dropdowns, split into type-specific components: `ExploreVariableSelectCustom` (with options dropdown) and `ExploreVariableSelectGeneric` (single-value display)
  - `ConfirmModal` from `@grafana/ui` takes `isOpen`, `title`, `body`, `confirmText`, `onConfirm`, `onDismiss` props
  - `getDefinition()` from `dashboard-scene/settings/variables/utils.ts` provides human-readable variable definition strings (query text, CSV values, etc.)
  - When using `<>` fragments to render both a Drawer and a ConfirmModal, the modal must be outside the Drawer
---

## 2026-02-17 - US-008
- Created comprehensive unit tests for explore variable state management
- Files changed:
  - `public/app/features/explore/state/variables.test.ts` - New test file with 15 tests covering all acceptance criteria
- Tests cover:
  - Initial state: empty SceneVariableSet on pane creation
  - addSceneVariableAction: CustomVariable, QueryVariable, TextBoxVariable, ConstantVariable
  - Auto-generated unique names via getNextAvailableId
  - removeVariableAction: removal by name and no-op for non-existent variables
  - replaceVariableAction: type change preserving name and label
  - buildExploreVariableScopedVars: empty set, single variable, multiple variables
  - SceneVariableValueChangedEvent: fires on value change
- **Learnings for future iterations:**
  - `jest-fail-on-console` is active in the test suite — `console.warn` from `SceneObjectBase._setParent()` (re-parenting warning) will fail tests unless explicitly mocked with `jest.spyOn(console, 'warn').mockImplementation()`
  - When testing reducers that create new `SceneVariableSet` instances from existing variables, the variables get re-parented which triggers the warning
  - `CustomVariable.changeValueTo(value, text)` is the method to programmatically change a variable's value (triggers `SceneVariableValueChangedEvent`)
  - `SceneVariableSet` must be activated (`.activate()`) before events will fire
  - `getDataSourceSrv` mock needs `meta.info.logos` for `DataSourceLogo` component to render without error
  - `validateVariableName()` requires variable to have a parent `SceneVariableSet` — ensure Redux store has a pane initialized so `addSceneVariableAction` dispatch actually processes
  - Use `TestProvider` with a pre-configured `store` from `configureStore()` and set `store.getState().explore.panes` for explore component tests
---

## 2026-02-17 - US-009
- Created comprehensive component tests for variable editor UI
- Files changed:
  - `public/app/features/explore/Variables/ExploreVariableTypeSelection.test.tsx` - 3 tests: renders 4 type cards, does NOT render unsupported types, clicking calls onSelect with correct type
  - `public/app/features/explore/Variables/ExploreVariableEditor.test.tsx` - 15 tests covering: type selection view, Drawer close, editor form rendering (Custom + Query), list view with existing variables, edit/delete from list, New variable from list, initialVariable direct editing, empty state, Back to list navigation, name validation (__prefix and duplicates)
- Tests cover:
  - Type selection: renders exactly 4 cards (custom, query, textbox, constant), excludes unsupported types
  - Drawer: open/close behavior, cancel button
  - VariableEditorForm: renders for CustomVariable and QueryVariable
  - List view: shows variables with name and type, edit/delete/new buttons
  - Delete confirmation modal
  - Editor navigation: back to list
  - Name validation: __prefix error, duplicate name error
- **Learnings for future iterations:**
  - `getDataSourceSrv` must return objects with full `meta.info.logos` structure for QueryVariable editor rendering
  - For name validation tests, the variable must have a parent `SceneVariableSet` — use `initialVariable` with a pre-built `SceneVariableSet` instead of relying on Redux dispatch
  - `TestProvider` from `test/helpers/TestProvider` wraps Redux store, Router, and GrafanaContext — pass `store` prop with pre-configured explore panes
  - `configureStore()` from `app/store/configureStore` creates the full Grafana Redux store; set `store.getState().explore.panes = { left: makeExplorePaneState() }` for explore tests
  - `VariableTextField` uses `defaultValue` (uncontrolled) — `onChange` fires on each keystroke, `onBlur` commits the value
  - Variable type names from `getEditableVariables()`: 'Custom', 'Query', 'Textbox', 'Constant' (not 'Text box')
---

## 2026-02-17 - US-010
- Created integration tests for variable interpolation and toolbar
- Files changed:
  - `public/app/features/explore/spec/variables.test.tsx` - New test file with 12 integration tests
- Tests cover:
  - Variable interpolation: CustomVariable ScopedVars, TextBoxVariable ScopedVars, ConstantVariable interpolated without toolbar dropdown
  - Variable value changes: dispatch triggers ScopedVars update
  - Pane isolation: variables in left pane do not appear in right pane ScopedVars
  - Variable deletion: removing variable clears it from ScopedVars
  - Toolbar rendering: Select shows variable options, prefix displays `$variableName`, gear icon opens editor Drawer
  - Empty variable: renders dropdown without crashing
  - Rapid value changes: final state reflects latest value
- **Learnings for future iterations:**
  - Explore pane IDs are dynamically generated (not 'left'/'right') — use `Object.keys(store.getState().explore.panes)[0]` to get the actual ID
  - `jest-fail-on-console` catches `console.error`/`console.warn` — mock them in beforeEach when testing with `setupExplore` (React act() warnings are expected from Redux store dispatches)
  - `setupExplore()` helper renders the full ExplorePage with Redux, Router, and all services — dispatching actions requires `act()` wrapper
  - For integration tests with URL params and split panes, `waitForExplore('right')` waits for the second pane; get pane IDs with `Object.keys(store.getState().explore.panes)`
  - The `@grafana/ui` Select component renders values inside styled containers — avoid `getByText()` on option values directly; use the prefix text (`$varName`) to verify rendering
  - `addSceneVariableAction` triggers toolbar re-render via `useSelector` on `variableSet` → `useEffect([variableSet])` → `setVariables()` — wrap dispatch in `act()` and `waitFor` the prefix text
---

## 2026-02-17 - US-011
- Replaced 'dashboard' references with 'explore' wording in variable editor Drawer
- Files changed:
  - `public/app/features/explore/Variables/ExploreVariableTypeSelection.tsx` - Added `EXPLORE_DESCRIPTION_OVERRIDES` map to override type card descriptions; constant type now says "useful for metric prefixes in shared queries" instead of "useful for metric prefixes in dashboards you want to share"; exported `EXPLORE_VARIABLE_TYPES` for reuse
  - `public/app/features/explore/Variables/ExploreVariableTypeSelection.test.tsx` - Added test: "does not mention dashboard in any type card description" that asserts no rendered text contains 'dashboard'
- **Learnings for future iterations:**
  - When reusing shared components from dashboard-scene (e.g., `getEditableVariables()`), override their text in the Explore-specific wrapper rather than modifying the shared component
  - Use `EXPLORE_DESCRIPTION_OVERRIDES` pattern: a map of `EditableVariableType → () => string` functions (using `t()` for i18n) that override specific descriptions while falling back to the original for others
  - The `VariableEditorForm` from dashboard-scene renders `VariableTypeSelect` internally with all type descriptions — this cannot be easily overridden without forking the component
---

## 2026-02-17 - US-012
- Replaced per-variable gear icons with a single 'Manage variables' button in the toolbar
- When no variables exist, toolbar shows '+ Add variable' button (opens Drawer to type selection)
- When variables exist, toolbar shows '(cog) Manage variables' button (opens Drawer to list view)
- Removed `onEdit` prop and `IconButton` gear icons from `ExploreVariableSelectCustom` and `ExploreVariableSelectGeneric`
- Updated `ExploreVariableEditor` props: replaced `initialVariable` with `initialView` ('list' | 'editor')
- Files changed:
  - `public/app/features/explore/ExploreToolbar.tsx` - Removed gear icons from variable Select components, added conditional button rendering (Add variable vs Manage variables), removed `editingVariable` state, added `variableEditorInitialView` state, removed `IconButton`/`Stack` imports
  - `public/app/features/explore/Variables/ExploreVariableEditor.tsx` - Changed props from `initialVariable?: SceneVariable | null` to `initialView?: 'list' | 'editor'`, computed initial view based on prop and variable count
  - `public/app/features/explore/Variables/ExploreVariableEditor.test.tsx` - Updated all tests to use `initialView` prop instead of `initialVariable`, navigated to editor form via list view edit buttons for name validation/editor tests
  - `public/app/features/explore/spec/variables.test.tsx` - Replaced 'gear icon opens editor' test with 'Manage variables button opens Drawer to list view' and 'no per-variable gear icons' tests
  - `public/locales/en-US/grafana.json` - Added `manage-variables` and other missing i18n keys
- **Learnings for future iterations:**
  - `ToolbarButton` from `@grafana/ui` renders children as button text — use `<Trans>` for i18n
  - In integration tests, `ToolbarButton` text is best found via `screen.getByText()` rather than `screen.getByRole('button', { name: ... })` because the accessible name computation may differ
  - When changing `ExploreVariableEditor` props, all test files that render it need updating — there are two: `ExploreVariableEditor.test.tsx` (component tests) and `spec/variables.test.tsx` (integration tests)
---

## 2026-02-17 - US-013
- Implemented URL persistence for explore variables
- Variable state is serialized to/from the URL panes parameter, surviving page refresh and URL sharing
- Files changed:
  - `packages/grafana-data/src/types/explore.ts` - Added `ExploreUrlVariable` interface and `variables?: ExploreUrlVariable[]` field to `ExploreUrlState`
  - `packages/grafana-data/src/index.ts` - Exported `ExploreUrlVariable` type
  - `public/app/features/explore/state/variables.ts` - Added `SetVariablesPayload` interface, `setVariablesAction` for bulk variable replacement
  - `public/app/features/explore/state/variablesSerialization.ts` - New file with `serializeVariableSet()` (SceneVariableSet → ExploreUrlVariable[]) and `deserializeVariables()` (ExploreUrlVariable[] → SceneVariable[])
  - `public/app/features/explore/hooks/useStateSync/external.utils.ts` - Added `variables` field to `getUrlStateFromPaneState` using `serializeVariableSet`
  - `public/app/features/explore/hooks/useStateSync/synchronizer/toURL.ts` - Added variable actions to `syncToURLPredicate` (addSceneVariable, removeVariable, replaceVariable, setVariables)
  - `public/app/features/explore/hooks/useStateSync/migrators/v1.ts` - Added `variables` parsing in `applyDefaults` with `isValidUrlVariable` validation
  - `public/app/features/explore/hooks/useStateSync/internal.utils.ts` - Added `variables: boolean` to `urlDiff` return type
  - `public/app/features/explore/hooks/useStateSync/synchronizer/fromURL.ts` - Added variable restoration, guarded by `urlPane.variables !== undefined` to prevent circular sync clearing
  - `public/app/features/explore/hooks/useStateSync/synchronizer/init.ts` - Added variable restoration on initial page load via `setVariablesAction` after `initializeExplore`
  - `public/app/features/explore/state/variables.test.ts` - Added tests for `setVariablesAction`, `serializeVariableSet`, `deserializeVariables`, round-trip serialization (28 total tests)
  - `public/app/features/explore/hooks/useStateSync/migrators/v1.test.ts` - Added 4 tests for URL variable parsing (10 total)
  - `public/app/features/explore/hooks/useStateSync/index.test.tsx` - Added 7 tests for URL sync: restore from URL, persist on add, remove on delete, syncFromURL restoration, backwards compat, malformed URL, split pane independence (23 total)
- Key bug fix: `syncFromURL` must check `urlPane.variables !== undefined` before dispatching `setVariablesAction`, because the bi-directional URL sync can create a race condition where `syncFromURL` fires with a stale URL (without variables) after the store has already been updated with variables
- **Learnings for future iterations:**
  - The bi-directional URL sync (`syncToURL` → URL change → `syncFromURL`) has a timing issue: `initializeFromURL` sets the URL but doesn't update `prevParams`, so the next `useEffect` render sees `isURLOutOfSync=true` and calls `syncFromURL`. If the store has already been updated (e.g., by a test dispatch), `syncFromURL` compares the old URL (without variables) against the new store state (with variables) and incorrectly clears them.
  - Guard `syncFromURL` variable restoration with `urlPane.variables !== undefined` to only apply URL state when the URL explicitly contains variable data
  - `serializeVariableSet` and `deserializeVariables` are in a separate file (`state/variablesSerialization.ts`) to avoid circular dependencies between state and URL sync modules
  - `ExploreUrlVariable` type is intentionally flat (no nested SceneVariable-specific fields) for clean URL serialization
---

## 2026-02-17 - US-014
- Reviewed and fixed acceptance criteria for US-006 through US-011 after removing multi-type variable support
- Only custom variables are now supported; type selection step is removed
- Files changed:
  - `public/app/features/explore/Variables/ExploreVariableEditor.tsx` - Removed type selection step; new variables open editor form directly with a CustomVariable; removed ExploreVariableTypeSelection import
  - `public/app/features/explore/Variables/ExploreVariableListView.tsx` - Removed variable type display from list view; simplified nameCell styling
  - `public/app/features/explore/Variables/ExploreVariableTypeSelection.tsx` - Deleted (no longer needed)
  - `public/app/features/explore/Variables/ExploreVariableTypeSelection.test.tsx` - Deleted (no longer needed)
  - `public/app/features/dashboard-scene/settings/variables/VariableEditorForm.tsx` - Made `onTypeChange` prop optional; conditionally render `VariableTypeSelect` only when `onTypeChange` is provided
  - `public/app/features/explore/Variables/ExploreVariableEditor.test.tsx` - Rewrote: removed type selection tests, removed QueryVariable test, added "hides the variable type selector" test, updated "New variable" test to verify editor form opens directly
  - `public/app/features/explore/state/variables.test.ts` - Removed QueryVariable/TextBoxVariable/ConstantVariable add tests, removed replaceVariableAction type change test, updated auto-generated name tests to use custom type only, updated multi-variable ScopedVars test to use only CustomVariables
- All 90 tests pass across 6 test suites; 200 dashboard-scene variable tests pass; TypeScript clean
---

## 2026-02-18 - US-016
- Enabled custom values in variable selector dropdowns
- Files changed:
  - `public/app/features/explore/ExploreToolbar.tsx` - Added `allowCustomValue` to destructured variable state, passed it to `Select` component; added logic to append current value to options list when it's a custom value not in predefined options (fixes URL restore showing "Choose")
  - `public/app/features/explore/Variables/ExploreVariableEditor.tsx` - Set `allowCustomValue: true` as default when creating new `CustomVariable` instances (both in initial editor view and "Add from list" flow)
  - `local/ralph/prd.json` - Added US-016 user story with passes: true
- **Learnings for future iterations:**
  - When `allowCustomValue` is enabled on a `Select` component, the `Creatable` mode from react-select handles user input automatically — no `onCreateOption` handler is needed since `onChange` fires for both existing and new options
  - Custom-typed values are NOT added to the variable's `options` array — they only exist as the current `value`/`text`. On URL restore, the `Select` can't match the current value to any option and shows "Choose". Fix: append the current value to the rendered options list if it's not already present.
  - All infrastructure for `allowCustomValue` was already in place: `CustomVariable` state property, `Select` component prop, URL serialization/deserialization, and editor UI checkbox — only the toolbar Select was missing the prop
---

## 2026-02-18 - US-017
- Matched Explore variable selector UI to Dashboard variable selector
- Files changed:
  - `public/app/features/explore/ExploreToolbar.tsx` - Replaced `ExploreVariableSelectCustom` and `ExploreVariableSelectGeneric` with `ExploreVariableSelector` using `ControlsLabel` + `variable.Component` pattern from dashboard VariableControls; added `useEffect` for `SceneVariableValueChangedEvent` subscription; added container styles matching dashboard (inline-flex, shared border)
  - `public/app/features/explore/spec/variables.test.tsx` - Updated all `$variableName` assertions to `variableName` (ControlsLabel renders name without `$` prefix); renamed test "toolbar Select prefix shows $variableName" to "toolbar shows variable name as label"
- **Learnings for future iterations:**
  - `ControlsLabel` from `@grafana/scenes` renders a label with colored background (primary in dark, secondary in light), border, and left-rounded corners — paired with `variable.Component` and `position: relative; right: -1` creates a shared border effect
  - `useSceneObjectState(variable, { shouldActivateOrKeepAlive: true })` activates the variable and provides reactive state — required for `variable.Component` to render properly
  - `variable.Component` for `CustomVariable` renders `MultiOrSingleValueSelect` which handles single/multi value, allowCustomValue, virtualization, checkboxes, and toggle-all automatically
  - When using `variable.Component`, value changes go through `model.changeValueTo()` which fires `SceneVariableValueChangedEvent` — subscribe to this on the `SceneVariableSet` instead of manually dispatching `runQueries` in onChange
  - The `SceneVariableSet` must be activated via `.activate()` for events to propagate — set this up in a `useEffect` with cleanup
---
