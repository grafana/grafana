/*! For license information please see module.js.LICENSE.txt */
define(["@grafana/data","react","@emotion/css","@grafana/runtime","@grafana/ui","lodash","rxjs"],((e,t,r,n,a,o,i)=>(()=>{"use strict";var s={44:(e,t,r)=>{var n=r(959),a=Symbol.for("react.element"),o=Symbol.for("react.fragment"),i=Object.prototype.hasOwnProperty,s=n.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,l={key:!0,ref:!0,__self:!0,__source:!0};function c(e,t,r){var n,o={},c=null,u=null;for(n in void 0!==r&&(c=""+r),void 0!==t.key&&(c=""+t.key),void 0!==t.ref&&(u=t.ref),t)i.call(t,n)&&!l.hasOwnProperty(n)&&(o[n]=t[n]);if(e&&e.defaultProps)for(n in t=e.defaultProps)void 0===o[n]&&(o[n]=t[n]);return{$$typeof:a,type:e,key:c,ref:u,props:o,_owner:s.current}}t.Fragment=o,t.jsx=c,t.jsxs=c},728:(e,t,r)=>{e.exports=r(44)},89:e=>{e.exports=r},781:t=>{t.exports=e},531:e=>{e.exports=n},7:e=>{e.exports=a},241:e=>{e.exports=o},959:e=>{e.exports=t},269:e=>{e.exports=i}},l={};function c(e){var t=l[e];if(void 0!==t)return t.exports;var r=l[e]={exports:{}};return s[e](r,r.exports,c),r.exports}c.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return c.d(t,{a:t}),t},c.d=(e,t)=>{for(var r in t)c.o(t,r)&&!c.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},c.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),c.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var u={};c.r(u),c.d(u,{plugin:()=>Rn});var d=c(781),p=c(728),h=c(89),f=c(959),m=c.n(f),y=c(7),b=Object.defineProperty,g=Object.defineProperties,v=Object.getOwnPropertyDescriptors,O=Object.getOwnPropertySymbols,j=Object.prototype.hasOwnProperty,w=Object.prototype.propertyIsEnumerable,T=(e,t,r)=>t in e?b(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,x=(e,t)=>{for(var r in t||(t={}))j.call(t,r)&&T(e,r,t[r]);if(O)for(var r of O(t))w.call(t,r)&&T(e,r,t[r]);return e};const C=({dataSourceName:e,docsLink:t,hasRequiredFields:r=!0,className:n})=>{const a=(0,y.useTheme2)(),o={container:(0,h.css)({p:{margin:0},"p + p":{marginTop:a.spacing(2)}}),text:(0,h.css)((i=x({},a.typography.body),s={color:a.colors.text.secondary,a:(0,h.css)({color:a.colors.text.link,textDecoration:"underline","&:hover":{textDecoration:"none"}})},g(i,v(s))))};var i,s;return m().createElement("div",{className:(0,h.cx)(o.container,n)},m().createElement("p",{className:o.text},"Before you can use the ",e," data source, you must configure it below or in the config file. For detailed instructions,"," ",m().createElement("a",{href:t,target:"_blank",rel:"noreferrer"},"view the documentation"),"."),r&&m().createElement("p",{className:o.text},m().createElement("i",null,"Fields marked with * are required")))};var D=Object.defineProperty,P=Object.defineProperties,S=Object.getOwnPropertyDescriptors,F=Object.getOwnPropertySymbols,E=Object.prototype.hasOwnProperty,I=Object.prototype.propertyIsEnumerable,N=(e,t,r)=>t in e?D(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,k=(e,t)=>{for(var r in t||(t={}))E.call(t,r)&&N(e,r,t[r]);if(F)for(var r of F(t))I.call(t,r)&&N(e,r,t[r]);return e};const A=({children:e,title:t,description:r,isCollapsible:n=!1,isInitiallyOpen:a=!0,kind:o="section",className:i})=>{const{colors:s,typography:l,spacing:c}=(0,y.useTheme2)(),[u,d]=(0,f.useState)(!n||a),p=u?"angle-up":"angle-down",b="sub-section"===o,g=`${u?"Collapse":"Expand"} section ${t}`,v={header:(0,h.css)({display:"flex",justifyContent:"space-between",alignItems:"center"}),title:(0,h.css)({margin:0}),subtitle:(0,h.css)({margin:0,fontWeight:l.fontWeightRegular}),descriptionText:(0,h.css)((O=k({marginTop:c(b?.25:.5),marginBottom:0},l.bodySmall),j={color:s.text.secondary},P(O,S(j)))),content:(0,h.css)({marginTop:c(2)})};var O,j;return m().createElement("div",{className:i},m().createElement("div",{className:v.header},"section"===o?m().createElement("h3",{className:v.title},t):m().createElement("h6",{className:v.subtitle},t),n&&m().createElement(y.IconButton,{name:p,onClick:()=>d(!u),type:"button",size:"xl","aria-label":g})),r&&m().createElement("p",{className:v.descriptionText},r),u&&m().createElement("div",{className:v.content},e))};var R=Object.defineProperty,q=Object.defineProperties,M=Object.getOwnPropertyDescriptors,_=Object.getOwnPropertySymbols,B=Object.prototype.hasOwnProperty,J=Object.prototype.propertyIsEnumerable,L=(e,t,r)=>t in e?R(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;const $=e=>{var t,r=e,{children:n}=r,a=((e,t)=>{var r={};for(var n in e)B.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&_)for(var n of _(e))t.indexOf(n)<0&&J.call(e,n)&&(r[n]=e[n]);return r})(r,["children"]);return m().createElement(A,(t=((e,t)=>{for(var r in t||(t={}))B.call(t,r)&&L(e,r,t[r]);if(_)for(var r of _(t))J.call(t,r)&&L(e,r,t[r]);return e})({},a),q(t,M({kind:"section"}))),n)};var W=Object.defineProperty,G=Object.defineProperties,U=Object.getOwnPropertyDescriptors,z=Object.getOwnPropertySymbols,V=Object.prototype.hasOwnProperty,H=Object.prototype.propertyIsEnumerable,Q=(e,t,r)=>t in e?W(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;const K=({config:e,onChange:t,description:r,urlPlaceholder:n,urlTooltip:a,urlLabel:o,className:i})=>{const s=/^(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?$/.test(e.url),l={container:(0,h.css)({maxWidth:578})};return m().createElement(m().Fragment,null,m().createElement($,{title:"Connection",description:r,className:(0,h.cx)(l.container,i)},m().createElement(y.InlineField,{htmlFor:"connection-url",label:o||"URL",labelWidth:24,tooltip:a||m().createElement(m().Fragment,null,"Specify a complete HTTP URL",m().createElement("br",null),"(for example https://example.com:8080)"),grow:!0,disabled:e.readOnly,required:!0,invalid:!s&&!e.readOnly,error:s?"":"Please enter a valid URL",interactive:!0},m().createElement(y.Input,{id:"connection-url","aria-label":"Data source connection URL",onChange:r=>{return t((n=((e,t)=>{for(var r in t||(t={}))V.call(t,r)&&Q(e,r,t[r]);if(z)for(var r of z(t))H.call(t,r)&&Q(e,r,t[r]);return e})({},e),a={url:r.currentTarget.value},G(n,U(a))));var n,a},value:e.url||"",placeholder:n||"URL"}))))},Y=()=>({inlineFieldNoMarginRight:(0,h.css)({marginRight:0}),inlineFieldWithSecret:(0,h.css)({'[class$="layoutChildrenWrapper"]:first-child':{flexGrow:1}})}),Z=({user:e,passwordConfigured:t,userLabel:r="User",userTooltip:n="The username of the data source account",userPlaceholder:a="User",passwordLabel:o="Password",passwordTooltip:i="The password of the data source account",passwordPlaceholder:s="Password",onUserChange:l,onPasswordChange:c,onPasswordReset:u,readOnly:d})=>{const p=Y(),f={lastInlineField:(0,h.css)({marginBottom:0})};return m().createElement(m().Fragment,null,m().createElement(y.InlineField,{className:p.inlineFieldNoMarginRight,label:r,labelWidth:24,tooltip:n,required:!0,htmlFor:"basic-auth-user-input",interactive:!0,grow:!0,disabled:d},m().createElement(y.Input,{id:"basic-auth-user-input",placeholder:a,value:e,onChange:e=>l(e.currentTarget.value),required:!0})),m().createElement(y.InlineField,{className:(0,h.cx)(p.inlineFieldNoMarginRight,p.inlineFieldWithSecret,f.lastInlineField),label:o,labelWidth:24,tooltip:i,required:!0,htmlFor:"basic-auth-password-input",interactive:!0,grow:!0,disabled:d},m().createElement(y.SecretInput,{id:"basic-auth-password-input",isConfigured:t,onReset:d?()=>{}:u,placeholder:s,onChange:e=>c(e.currentTarget.value),required:!0})))};var X=Object.defineProperty,ee=Object.defineProperties,te=Object.getOwnPropertyDescriptors,re=Object.getOwnPropertySymbols,ne=Object.prototype.hasOwnProperty,ae=Object.prototype.propertyIsEnumerable,oe=(e,t,r)=>t in e?X(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;const ie=e=>{var t,r=e,{children:n}=r,a=((e,t)=>{var r={};for(var n in e)ne.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&re)for(var n of re(e))t.indexOf(n)<0&&ae.call(e,n)&&(r[n]=e[n]);return r})(r,["children"]);return m().createElement(A,(t=((e,t)=>{for(var r in t||(t={}))ne.call(t,r)&&oe(e,r,t[r]);if(re)for(var r of re(t))ae.call(t,r)&&oe(e,r,t[r]);return e})({},a),ee(t,te({kind:"sub-section"}))),n)};var se=(e=>(e.NoAuth="NoAuth",e.BasicAuth="BasicAuth",e.OAuthForward="OAuthForward",e.CrossSiteCredentials="CrossSiteCredentials",e))(se||{}),le=Object.defineProperty,ce=Object.defineProperties,ue=Object.getOwnPropertyDescriptors,de=Object.getOwnPropertySymbols,pe=Object.prototype.hasOwnProperty,he=Object.prototype.propertyIsEnumerable,fe=(e,t,r)=>t in e?le(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,me=(e,t)=>{for(var r in t||(t={}))pe.call(t,r)&&fe(e,r,t[r]);if(de)for(var r of de(t))he.call(t,r)&&fe(e,r,t[r]);return e},ye=(e,t)=>ce(e,ue(t));const be={[se.BasicAuth]:{label:"Basic authentication",value:se.BasicAuth,description:"Authenticate with your data source username and password"},[se.CrossSiteCredentials]:{label:"Enable cross-site access control requests",value:se.CrossSiteCredentials,description:"Allow cross-site Access-Control requests with your existing credentials and cookies. This enables the server to authenticate the user and perform authorized requests on their behalf on other domains."},[se.OAuthForward]:{label:"Forward OAuth Identity",value:se.OAuthForward,description:"Forward the OAuth access token (and if available: the OIDC ID token) of the user querying to the data source"},[se.NoAuth]:{label:"No Authentication",value:se.NoAuth,description:"Data source is available without authentication"}},ge=({selectedMethod:e,mostCommonMethod:t,visibleMethods:r,extendedDefaultOptions:n,customMethods:a,onAuthMethodSelect:o,basicAuth:i,readOnly:s})=>{var l,c,u,d;const[p,b]=(0,f.useState)(!1),{colors:g,spacing:v}=(0,y.useTheme2)(),O=(0,f.useMemo)((()=>{var e;return null!=r?r:[se.BasicAuth,se.OAuthForward,se.NoAuth,...null!=(e=null==a?void 0:a.map((e=>e.id)))?e:[]]}),[a,r]),j=O.length>1,w=(0,f.useMemo)((()=>{var e;const r=null!=(e=null==a?void 0:a.reduce(((e,t)=>(e[t.id]={label:t.label,value:t.id,description:t.description},e)),{}))?e:{},o={};let i;for(i in be)n&&n[i]?o[i]=me(me({},be[i]),n[i]):o[i]=be[i];const s=me(me({},r),o);return O.filter((e=>Boolean(s[e]))).map((e=>{const r=s[e];return e===t&&j?ye(me({},r),{label:`${r.label} (most common)`}):r}))}),[O,a,n,t,j]);let T=e;j?e===se.NoAuth&&t&&!p&&(T=t):T=O[0];let x=null;T===se.BasicAuth&&i?x=m().createElement(Z,ye(me({},i),{readOnly:s})):T.startsWith("custom-")&&(x=null!=(c=null==(l=null==a?void 0:a.find((e=>e.id===T)))?void 0:l.component)?c:null);const C=j?"Authentication methods":null!=(u=w[0].label)?u:"",D=j?"Choose an authentication method to access the data source":null!=(d=w[0].description)?d:"",P={authMethods:(0,h.css)(me({marginTop:v(2.5)},j&&{padding:v(2),border:`1px solid ${g.border.weak}`})),selectedMethodFields:(0,h.css)({marginTop:v(1.5)})};return m().createElement(ie,{title:C,description:D},m().createElement("div",{className:P.authMethods},j&&m().createElement(y.Select,{options:w,value:T,onChange:e=>{b(!0),o(e.value)},disabled:s}),x&&m().createElement("div",{className:P.selectedMethodFields},x)))},ve=({children:e,enabled:t,label:r,tooltipText:n,onToggle:a,readOnly:o})=>{const{colors:i,spacing:s}=(0,y.useTheme2)(),l={container:(0,h.css)({marginTop:3}),checkboxContainer:(0,h.css)({display:"flex",alignItems:"center"}),infoIcon:(0,h.css)({marginTop:-2,marginLeft:5,color:i.text.secondary}),content:(0,h.css)({margin:s(1,0,2,3)})};return m().createElement("div",{className:l.container},m().createElement("div",{className:l.checkboxContainer},m().createElement(y.Checkbox,{value:t,label:r,onChange:()=>a(!t),disabled:o}),m().createElement(y.Tooltip,{placement:"top",content:n,interactive:!0},m().createElement(y.Icon,{name:"info-circle",className:l.infoIcon,size:"sm"}))),t&&e&&m().createElement("div",{className:l.content},e))},Oe=({enabled:e,certificateConfigured:t,onToggle:r,onCertificateChange:n,onCertificateReset:a,tooltips:o,readOnly:i})=>{var s;const l=Y();return m().createElement(ve,{enabled:e,label:"Add self-signed certificate",tooltipText:"Add your own Certificate Authority (CA) certificate on top of one generated by the certificate authorities for additional security measures",onToggle:e=>r(e),readOnly:i},m().createElement(y.InlineField,{label:"CA Certificate",labelWidth:24,tooltip:null!=(s=null==o?void 0:o.certificateLabel)?s:"Your self-signed certificate",required:!0,htmlFor:"self-signed-certificate-input",interactive:!0,grow:!0,className:(0,h.cx)(l.inlineFieldNoMarginRight,l.inlineFieldWithSecret),disabled:i},m().createElement(y.SecretTextArea,{id:"self-signed-certificate-input",isConfigured:t,onChange:e=>n(e.currentTarget.value),onReset:i?()=>{}:a,placeholder:"Begins with --- BEGIN CERTIFICATE ---",rows:6,required:!0})))},je=({enabled:e,serverName:t,clientCertificateConfigured:r,clientKeyConfigured:n,onToggle:a,onServerNameChange:o,onClientCertificateChange:i,onClientKeyChange:s,onClientCertificateReset:l,onClientKeyReset:c,tooltips:u,readOnly:d})=>{var p,f,b;const g=Y();return m().createElement(ve,{enabled:e,label:"TLS Client Authentication",tooltipText:"Validate using TLS client authentication, in which the server authenticates the client",onToggle:e=>a(e),readOnly:d},m().createElement(y.InlineField,{label:"ServerName",labelWidth:24,tooltip:null!=(p=null==u?void 0:u.serverNameLabel)?p:"A Servername is used to verify the hostname on the returned certificate",required:!0,htmlFor:"client-auth-servername-input",interactive:!0,grow:!0,className:g.inlineFieldNoMarginRight,disabled:d},m().createElement(y.Input,{id:"client-auth-servername-input",placeholder:"domain.example.com",value:t,onChange:e=>o(e.currentTarget.value),required:!0})),m().createElement(y.InlineField,{label:"Client Certificate",labelWidth:24,tooltip:null!=(f=null==u?void 0:u.certificateLabel)?f:"The client certificate can be generated from a Certificate Authority or be self-signed",required:!0,htmlFor:"client-auth-client-certificate-input",interactive:!0,grow:!0,className:(0,h.cx)(g.inlineFieldNoMarginRight,g.inlineFieldWithSecret),disabled:d},m().createElement(y.SecretTextArea,{id:"client-auth-client-certificate-input",isConfigured:r,onChange:e=>i(e.currentTarget.value),onReset:d?()=>{}:l,placeholder:"Begins with --- BEGIN CERTIFICATE ---",rows:6,required:!0})),m().createElement(y.InlineField,{label:"Client Key",labelWidth:24,tooltip:null!=(b=null==u?void 0:u.keyLabel)?b:"The client key can be generated from a Certificate Authority or be self-signed",required:!0,htmlFor:"client-auth-client-key-input",interactive:!0,grow:!0,className:(0,h.cx)(g.inlineFieldNoMarginRight,g.inlineFieldWithSecret),disabled:d},m().createElement(y.SecretTextArea,{id:"client-auth-client-key-input",isConfigured:n,onChange:e=>s(e.currentTarget.value),onReset:d?()=>{}:c,placeholder:"Begins with --- RSA PRIVATE KEY CERTIFICATE ---",rows:6,required:!0})))},we=({enabled:e,onToggle:t,readOnly:r})=>m().createElement(ve,{enabled:e,label:"Skip TLS certificate validation",tooltipText:"Skipping TLS certificate validation is not recommended unless absolutely necessary or for testing",onToggle:e=>t(e),readOnly:r});var Te=Object.defineProperty,xe=Object.defineProperties,Ce=Object.getOwnPropertyDescriptors,De=Object.getOwnPropertySymbols,Pe=Object.prototype.hasOwnProperty,Se=Object.prototype.propertyIsEnumerable,Fe=(e,t,r)=>t in e?Te(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Ee=(e,t)=>{for(var r in t||(t={}))Pe.call(t,r)&&Fe(e,r,t[r]);if(De)for(var r of De(t))Se.call(t,r)&&Fe(e,r,t[r]);return e},Ie=(e,t)=>xe(e,Ce(t));const Ne=({selfSignedCertificate:e,TLSClientAuth:t,skipTLSVerification:r,readOnly:n})=>{const{spacing:a}=(0,y.useTheme2)(),o={container:(0,h.css)({marginTop:a(3)})};return m().createElement(ie,{className:o.container,title:"TLS settings",description:"Additional security measures that can be applied on top of authentication"},m().createElement(Oe,Ie(Ee({},e),{readOnly:n})),m().createElement(je,Ie(Ee({},t),{readOnly:n})),m().createElement(we,Ie(Ee({},r),{readOnly:n})))};var ke=Object.defineProperty,Ae=Object.defineProperties,Re=Object.getOwnPropertyDescriptors,qe=Object.getOwnPropertySymbols,Me=Object.prototype.hasOwnProperty,_e=Object.prototype.propertyIsEnumerable,Be=(e,t,r)=>t in e?ke(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Je=(e,t)=>{for(var r in t||(t={}))Me.call(t,r)&&Be(e,r,t[r]);if(qe)for(var r of qe(t))_e.call(t,r)&&Be(e,r,t[r]);return e},Le=(e,t)=>Ae(e,Re(t));const $e=({header:e,onChange:t,onBlur:r,onDelete:n,readOnly:a})=>{const{spacing:o}=(0,y.useTheme2)(),i=Y(),s={container:(0,h.css)({alignItems:"center"}),input:(0,h.css)({minWidth:"100%"}),headerNameField:(0,h.css)({width:"40%",marginRight:0,paddingRight:o(1)}),headerValueField:(0,h.css)({width:"45%",marginRight:0}),removeHeaderBtn:(0,h.css)({margin:"0 0 3px 10px"})};return m().createElement(m().Fragment,null,m().createElement(y.InlineFieldRow,{className:s.container},m().createElement(y.InlineField,{label:"Header",labelWidth:9,grow:!0,className:s.headerNameField,htmlFor:`custom-header-${e.id}-name-input`,disabled:a},m().createElement(y.Input,{id:`custom-header-${e.id}-name-input`,placeholder:"X-Custom-Header",value:e.name,width:12,onChange:r=>t(Le(Je({},e),{name:r.currentTarget.value})),onBlur:r,className:s.input})),m().createElement(y.InlineField,{label:"Value",labelWidth:9,grow:!0,className:(0,h.cx)(i.inlineFieldWithSecret,s.headerValueField),htmlFor:`custom-header-${e.id}-value-input`,disabled:a},m().createElement(y.SecretInput,{id:`custom-header-${e.id}-value-input`,isConfigured:e.configured,placeholder:"Header value",value:e.value,width:12,onChange:r=>t(Le(Je({},e),{value:r.currentTarget.value})),onReset:a?()=>{}:()=>t(Le(Je({},e),{configured:!1,value:""})),onBlur:r,className:s.input})),m().createElement(y.IconButton,{name:"trash-alt",tooltip:"Remove header",tooltipPlacement:"top",className:s.removeHeaderBtn,onClick:n,type:"button",disabled:a})))};var We=Object.defineProperty,Ge=Object.defineProperties,Ue=Object.getOwnPropertyDescriptors,ze=Object.getOwnPropertySymbols,Ve=Object.prototype.hasOwnProperty,He=Object.prototype.propertyIsEnumerable,Qe=(e,t,r)=>t in e?We(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Ke=(e,t)=>{for(var r in t||(t={}))Ve.call(t,r)&&Qe(e,r,t[r]);if(ze)for(var r of ze(t))He.call(t,r)&&Qe(e,r,t[r]);return e},Ye=(e,t)=>Ge(e,Ue(t));const Ze=({headers:e,onChange:t,readOnly:r})=>{const{spacing:n}=(0,y.useTheme2)(),[a,o]=(0,f.useState)(e.map((e=>Ye(Ke({},e),{id:Xe(),value:""}))));(0,f.useEffect)((()=>{o((t=>{let r=!1;const n=t.map((t=>{var n;const a=null==(n=e.find((e=>e.name===t.name)))?void 0:n.configured;return void 0!==a&&t.configured!==a?(r=!0,Ye(Ke({},t),{configured:a})):t}));return r?n:t}))}),[e]);const i=()=>{t(a.map((({name:e,value:t,configured:r})=>({name:e,value:t,configured:r}))))},s={container:(0,h.css)({marginTop:n(3)}),addHeaderButton:(0,h.css)({marginTop:n(1.5)})};return m().createElement("div",{className:s.container},m().createElement(ie,{title:"HTTP headers",description:"Pass along additional context and metadata about the request/response",isCollapsible:!0,isInitiallyOpen:a.length>0},m().createElement("div",null,a.map((e=>m().createElement($e,{key:e.id,header:e,onChange:e=>((e,t)=>{o(a.map((r=>r.id===e?Ke({},t):r)))})(e.id,e),onDelete:()=>(e=>{const r=a.findIndex((t=>t.id===e));if(-1===r)return;const n=[...a];n.splice(r,1),o(n),t(n.map((({name:e,value:t,configured:r})=>({name:e,value:t,configured:r}))))})(e.id),onBlur:i,readOnly:r})))),m().createElement("div",{className:s.addHeaderButton},m().createElement(y.Button,{icon:"plus",variant:"secondary",fill:"outline",onClick:()=>{o([...a,{id:Xe(),name:"",value:"",configured:!1}])},disabled:r},0===a.length?"Add header":"Add another header"))))};function Xe(){return Math.random().toString(16).slice(2)}var et=Object.defineProperty,tt=Object.defineProperties,rt=Object.getOwnPropertyDescriptors,nt=Object.getOwnPropertySymbols,at=Object.prototype.hasOwnProperty,ot=Object.prototype.propertyIsEnumerable,it=(e,t,r)=>t in e?et(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,st=(e,t)=>{for(var r in t||(t={}))at.call(t,r)&&it(e,r,t[r]);if(nt)for(var r of nt(t))ot.call(t,r)&&it(e,r,t[r]);return e},lt=(e,t)=>tt(e,rt(t));const ct=({selectedMethod:e,mostCommonMethod:t,visibleMethods:r,extendedDefaultOptions:n,customMethods:a,onAuthMethodSelect:o,basicAuth:i,TLS:s,customHeaders:l,readOnly:c=!1})=>{const u={container:(0,h.css)({maxWidth:578})};return m().createElement("div",{className:u.container},m().createElement($,{title:"Authentication"},m().createElement(ge,{selectedMethod:e,mostCommonMethod:t,customMethods:a,visibleMethods:r,extendedDefaultOptions:n,onAuthMethodSelect:o,basicAuth:i,readOnly:c}),s&&m().createElement(Ne,lt(st({},s),{readOnly:c})),l&&m().createElement(Ze,lt(st({},l),{readOnly:c}))))};var ut=Object.defineProperty,dt=Object.defineProperties,pt=Object.getOwnPropertyDescriptors,ht=Object.getOwnPropertySymbols,ft=Object.prototype.hasOwnProperty,mt=Object.prototype.propertyIsEnumerable,yt=(e,t,r)=>t in e?ut(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,bt=(e,t)=>{for(var r in t||(t={}))ft.call(t,r)&&yt(e,r,t[r]);if(ht)for(var r of ht(t))mt.call(t,r)&&yt(e,r,t[r]);return e},gt=(e,t)=>dt(e,pt(t));const vt="httpHeaderName",Ot="httpHeaderValue";function jt({config:e,onChange:t}){return{selectedMethod:wt(e),onAuthMethodSelect:Tt(e,t),basicAuth:xt(e,t),TLS:Ct(e,t),customHeaders:Dt(e,t),readOnly:e.readOnly}}function wt(e){return e.basicAuth?se.BasicAuth:e.withCredentials?se.CrossSiteCredentials:e.jsonData.oauthPassThru?se.OAuthForward:se.NoAuth}function Tt(e,t){return r=>{t(gt(bt({},e),{basicAuth:r===se.BasicAuth,withCredentials:r===se.CrossSiteCredentials,jsonData:gt(bt({},e.jsonData),{oauthPassThru:r===se.OAuthForward})}))}}function xt(e,t){return{user:e.basicAuthUser,passwordConfigured:e.secureJsonFields.basicAuthPassword,onUserChange:r=>t(gt(bt({},e),{basicAuthUser:r})),onPasswordChange:r=>t(gt(bt({},e),{secureJsonData:gt(bt({},e.secureJsonData),{basicAuthPassword:r})})),onPasswordReset:()=>t(gt(bt({},e),{secureJsonData:gt(bt({},e.secureJsonData),{basicAuthPassword:""}),secureJsonFields:gt(bt({},e.secureJsonFields),{basicAuthPassword:!1})}))}}function Ct(e,t){return{selfSignedCertificate:{enabled:Boolean(e.jsonData.tlsAuthWithCACert),certificateConfigured:e.secureJsonFields.tlsCACert,onToggle:r=>t(gt(bt({},e),r?{jsonData:gt(bt({},e.jsonData),{tlsAuthWithCACert:r})}:{jsonData:gt(bt({},e.jsonData),{tlsAuthWithCACert:r}),secureJsonData:gt(bt({},e.secureJsonData),{tlsCACert:""}),secureJsonFields:gt(bt({},e.secureJsonFields),{tlsCACert:!1})})),onCertificateChange:r=>t(gt(bt({},e),{secureJsonData:gt(bt({},e.secureJsonData),{tlsCACert:r})})),onCertificateReset:()=>t(gt(bt({},e),{secureJsonData:gt(bt({},e.secureJsonData),{tlsCACert:""}),secureJsonFields:gt(bt({},e.secureJsonFields),{tlsCACert:!1})}))},TLSClientAuth:{enabled:e.jsonData.tlsAuth,serverName:e.jsonData.serverName,clientCertificateConfigured:e.secureJsonFields.tlsClientCert,clientKeyConfigured:e.secureJsonFields.tlsClientKey,onToggle:r=>t(gt(bt({},e),r?{jsonData:gt(bt({},e.jsonData),{tlsAuth:r})}:{jsonData:gt(bt({},e.jsonData),{tlsAuth:r,serverName:""}),secureJsonData:gt(bt({},e.secureJsonData),{tlsClientCert:"",tlsClientKey:""}),secureJsonFields:gt(bt({},e.secureJsonFields),{tlsClientCert:!1,tlsClientKey:!1})})),onServerNameChange:r=>t(gt(bt({},e),{jsonData:gt(bt({},e.jsonData),{serverName:r})})),onClientCertificateChange:r=>t(gt(bt({},e),{secureJsonData:gt(bt({},e.secureJsonData),{tlsClientCert:r})})),onClientCertificateReset:()=>t(gt(bt({},e),{secureJsonData:gt(bt({},e.secureJsonData),{tlsClientCert:""}),secureJsonFields:gt(bt({},e.secureJsonFields),{tlsClientCert:!1})})),onClientKeyChange:r=>t(gt(bt({},e),{secureJsonData:gt(bt({},e.secureJsonData),{tlsClientKey:r})})),onClientKeyReset:()=>t(gt(bt({},e),{secureJsonData:gt(bt({},e.secureJsonData),{tlsClientKey:""}),secureJsonFields:gt(bt({},e.secureJsonFields),{tlsClientKey:!1})}))},skipTLSVerification:{enabled:e.jsonData.tlsSkipVerify,onToggle:r=>t(gt(bt({},e),{jsonData:gt(bt({},e.jsonData),{tlsSkipVerify:r})}))}}}function Dt(e,t){return{headers:Object.keys(e.jsonData).filter((e=>e.startsWith(vt))).sort().map((t=>{var r;const n=t.slice(vt.length);return{name:e.jsonData[t],configured:null!=(r=e.secureJsonFields[`${Ot}${n}`])&&r}})),onChange:r=>{const n=Object.fromEntries(Object.entries(e.jsonData).filter((([e])=>!e.startsWith(vt)))),a=Object.fromEntries(Object.entries(e.secureJsonData||{}).filter((([e])=>!e.startsWith(Ot)))),o=Object.fromEntries(Object.entries(e.secureJsonFields).filter((([e])=>!e.startsWith(Ot))));r.forEach(((e,t)=>{n[`${vt}${t+1}`]=e.name,e.configured?o[`${Ot}${t+1}`]=!0:a[`${Ot}${t+1}`]=e.value})),t(gt(bt({},e),{jsonData:n,secureJsonData:a,secureJsonFields:o}))}}}var Pt=Object.defineProperty,St=Object.defineProperties,Ft=Object.getOwnPropertyDescriptors,Et=Object.getOwnPropertySymbols,It=Object.prototype.hasOwnProperty,Nt=Object.prototype.propertyIsEnumerable,kt=(e,t,r)=>t in e?Pt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,At=(e,t)=>{for(var r in t||(t={}))It.call(t,r)&&kt(e,r,t[r]);if(Et)for(var r of Et(t))Nt.call(t,r)&&kt(e,r,t[r]);return e},Rt=(e,t)=>St(e,Ft(t));const qt=({config:e,onChange:t,className:r})=>{const n={container:(0,h.css)({maxWidth:578})};return m().createElement(ie,{title:"Advanced HTTP settings",className:(0,h.cx)(n.container,r)},m().createElement(y.InlineField,{htmlFor:"advanced-http-cookies",label:"Allowed cookies",labelWidth:24,tooltip:"Grafana proxy deletes forwarded cookies by default. Specify cookies by name that should be forwarded to the data source.",disabled:e.readOnly,grow:!0},m().createElement(y.TagsInput,{id:"advanced-http-cookies",placeholder:"New cookie (hit enter to add)",tags:e.jsonData.keepCookies,onChange:r=>{t(Rt(At({},e),{jsonData:Rt(At({},e.jsonData),{keepCookies:r})}))}})),m().createElement(y.InlineField,{htmlFor:"advanced-http-timeout",label:"Timeout",labelWidth:24,tooltip:"HTTP request timeout in seconds",disabled:e.readOnly,grow:!0},m().createElement(y.Input,{id:"advanced-http-timeout",type:"number",min:0,placeholder:"Timeout in seconds","aria-label":"Timeout in seconds",value:e.jsonData.timeout,onChange:r=>{t(Rt(At({},e),{jsonData:Rt(At({},e.jsonData),{timeout:parseInt(r.currentTarget.value,10)})}))}})))};function Mt(e){const{description:t,suffix:r,feature:n}=e,a=`Learn more about ${n}`,o=(0,y.useStyles2)(_t);return m().createElement("span",{className:o.container},t,m().createElement("a",{"aria-label":a,href:`https://grafana.com/docs/grafana/next/datasources/${r}`,rel:"noreferrer",target:"_blank"},a))}const _t=e=>({container:(0,h.css)({color:e.colors.text.secondary,a:(0,h.css)({color:e.colors.text.link,textDecoration:"underline",marginLeft:"5px","&:hover":{textDecoration:"none"}})})});var Bt=c(531);const Jt=/^(-?\d+(?:\.\d+)?)(ms|[Mwdhmsy])$/,Lt=(e,t)=>!(e.match(t)||!e);function $t(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const Wt=e=>{const t=e.validationRegex||Jt,[r,n]=(0,f.useState)((()=>!!e.value&&Lt(e.value,t)));var a;!function(e,t,r){void 0===t&&(t=0),void 0===r&&(r=[]);var n=function(e,t){void 0===t&&(t=0);var r=(0,f.useRef)(!1),n=(0,f.useRef)(),a=(0,f.useRef)(e),o=(0,f.useCallback)((function(){return r.current}),[]),i=(0,f.useCallback)((function(){r.current=!1,n.current&&clearTimeout(n.current),n.current=setTimeout((function(){r.current=!0,a.current()}),t)}),[t]),s=(0,f.useCallback)((function(){r.current=null,n.current&&clearTimeout(n.current)}),[]);return(0,f.useEffect)((function(){a.current=e}),[e]),(0,f.useEffect)((function(){return i(),s}),[t]),[o,s,i]}(e,t),a=n[0],o=n[1],i=n[2];(0,f.useEffect)(i,r)}((()=>{n(Lt(e.value,t))}),500,[e.value]);const o={labelWidth:26,disabled:null!==(a=e.disabled)&&void 0!==a&&a,invalid:r,error:e.isInvalidError};return e.label&&(o.label=e.label,o.tooltip=e.tooltip||""),(0,p.jsx)(y.InlineField,(i=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){$t(e,t,r[t])}))}return e}({},o),s=null!=(s={children:(0,p.jsx)(y.Input,{type:"text",placeholder:e.placeholder||"0",width:e.width||40,onChange:t=>{e.onChange(t.currentTarget.value)},value:e.value,"aria-label":e.ariaLabel||"interval input"})})?s:{},Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(s)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(s)).forEach((function(e){Object.defineProperty(i,e,Object.getOwnPropertyDescriptor(s,e))})),i));var i,s};function Gt(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Ut(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){Gt(e,t,r[t])}))}return e}function zt(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const Vt=({values:e,onChange:t,id:r})=>{const n=(0,y.useStyles2)(Ht);return(0,p.jsx)("div",{className:n.wrapper,children:e.length?e.map(((a,o)=>(0,p.jsxs)("div",{className:n.pair,children:[(0,p.jsx)(y.SegmentInput,{id:`${r}-key-${o}`,placeholder:"Tag name",value:a.key,onChange:r=>{t(e.map(((e,t)=>t===o?zt(Ut({},e),{key:String(r)}):e)))}}),(0,p.jsx)(y.InlineLabel,{"aria-label":"equals",className:n.operator,children:"as"}),(0,p.jsx)(y.SegmentInput,{id:`${r}-value-${o}`,placeholder:"New name (optional)",value:a.value||"",onChange:r=>{t(e.map(((e,t)=>t===o?zt(Ut({},e),{value:String(r)}):e)))}}),(0,p.jsx)(y.ToolbarButton,{onClick:()=>t([...e.slice(0,o),...e.slice(o+1)]),className:(0,h.cx)(n.removeTag,"query-part"),"aria-label":"Remove tag",type:"button",icon:"times"}),o===e.length-1?(0,p.jsx)(y.ToolbarButton,{onClick:()=>t([...e,{key:"",value:""}]),className:"query-part","aria-label":"Add tag",type:"button",icon:"plus"}):null]},o))):(0,p.jsx)(y.ToolbarButton,{icon:"plus",onClick:()=>t([...e,{key:"",value:""}]),className:"query-part","aria-label":"Add tag",type:"button"})})},Ht=e=>({wrapper:(0,h.css)({display:"flex",flexDirection:"column",gap:`${e.spacing(.5)} 0`}),pair:(0,h.css)({display:"flex",justifyContent:"start",alignItems:"center"}),operator:(0,h.css)({color:e.v1.palette.orange,width:"auto"}),removeTag:(0,h.css)({marginRight:e.spacing(.5)})});function Qt(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Kt(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){Qt(e,t,r[t])}))}return e}function Yt(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function Zt({options:e,onOptionsChange:t}){const r=["loki","elasticsearch","grafana-splunk-datasource","grafana-opensearch-datasource","grafana-falconlogscale-datasource","googlecloud-logging-datasource"],n=(0,f.useMemo)((()=>function(e){var t;if(null==e?void 0:e.tracesToLogsV2)return e.tracesToLogsV2;if(!(null==e?void 0:e.tracesToLogs))return;const r={customQuery:!1};return r.datasourceUid=e.tracesToLogs.datasourceUid,r.tags=e.tracesToLogs.mapTagNamesEnabled?e.tracesToLogs.mappedTags:null===(t=e.tracesToLogs.tags)||void 0===t?void 0:t.map((e=>({key:e}))),r.filterByTraceID=e.tracesToLogs.filterByTraceID,r.filterBySpanID=e.tracesToLogs.filterBySpanID,r.spanStartTimeShift=e.tracesToLogs.spanStartTimeShift,r.spanEndTimeShift=e.tracesToLogs.spanEndTimeShift,r}(e.jsonData)||{customQuery:!1}),[e.jsonData]),{query:a="",tags:o,customQuery:i}=n,s=(0,f.useCallback)((r=>{t(Yt(Kt({},e),{jsonData:Yt(Kt({},e.jsonData),{tracesToLogsV2:Kt({},n,r),tracesToLogs:void 0})}))}),[t,e,n]);return(0,p.jsxs)("div",{className:(0,h.css)({width:"100%"}),children:[(0,p.jsx)(y.InlineFieldRow,{children:(0,p.jsx)(y.InlineField,{tooltip:"The logs data source the trace is going to navigate to",label:"Data source",labelWidth:26,children:(0,p.jsx)(Bt.DataSourcePicker,{inputId:"trace-to-logs-data-source-picker",filter:e=>r.includes(e.type),current:n.datasourceUid,noDefault:!0,width:40,onChange:e=>s({datasourceUid:e.uid})})})}),(0,p.jsx)(y.InlineFieldRow,{children:(0,p.jsx)(Wt,{label:er("start"),tooltip:tr("start","0"),value:n.spanStartTimeShift||"",onChange:e=>{s({spanStartTimeShift:e})},isInvalidError:rr})}),(0,p.jsx)(y.InlineFieldRow,{children:(0,p.jsx)(Wt,{label:er("end"),tooltip:tr("end","0"),value:n.spanEndTimeShift||"",onChange:e=>{s({spanEndTimeShift:e})},isInvalidError:rr})}),(0,p.jsx)(y.InlineFieldRow,{children:(0,p.jsx)(y.InlineField,{tooltip:"Tags that will be used in the query. Default tags: 'cluster', 'hostname', 'namespace', 'pod', 'service.name', 'service.namespace'",label:"Tags",labelWidth:26,children:(0,p.jsx)(Vt,{values:null!=o?o:[],onChange:e=>s({tags:e})})})}),(0,p.jsx)(Xt,{disabled:i,type:"trace",id:"filterByTraceID",value:Boolean(n.filterByTraceID),onChange:e=>s({filterByTraceID:e})}),(0,p.jsx)(Xt,{disabled:i,type:"span",id:"filterBySpanID",value:Boolean(n.filterBySpanID),onChange:e=>s({filterBySpanID:e})}),(0,p.jsx)(y.InlineFieldRow,{children:(0,p.jsx)(y.InlineField,{tooltip:"Use a custom query with the possibility to interpolate variables from the trace or span",label:"Use custom query",labelWidth:26,children:(0,p.jsx)(y.InlineSwitch,{id:"customQuerySwitch",value:i,onChange:e=>s({customQuery:e.currentTarget.checked})})})}),i&&(0,p.jsx)(y.InlineField,{label:"Query",labelWidth:26,tooltip:"The query that will run when navigating from a trace to logs data source. Interpolate tags using the `$__tags` keyword",grow:!0,children:(0,p.jsx)(y.Input,{label:"Query",type:"text",allowFullScreen:!0,value:a,onChange:e=>s({query:e.currentTarget.value})})})]})}function Xt(e){return(0,p.jsx)(y.InlineFieldRow,{children:(0,p.jsx)(y.InlineField,{disabled:e.disabled,label:`Filter by ${e.type} ID`,labelWidth:26,grow:!0,tooltip:`Filters logs by ${e.type} ID, where the ${e.type} ID should be part of the log line`,children:(0,p.jsx)(y.InlineSwitch,{id:e.id,value:e.value,onChange:t=>e.onChange(t.currentTarget.checked)})})})}const er=e=>`Span ${e} time shift`,tr=(e,t)=>`Shifts the ${e} time of the span. Default: ${t} (Time units can be used here, for example: 5s, -1m, 3h)`,rr="Invalid time shift. See tooltip for examples.",nr=({options:e,onOptionsChange:t})=>{let r=e.type;return r+="tempo"===e.type?"/configure-tempo-data-source/#trace-to-logs":"/#trace-to-logs",(0,p.jsx)($,{title:"Trace to logs",description:(0,p.jsx)(Mt,{description:"Navigate from a trace span to the selected data source's logs.",suffix:r,feature:"trace to logs"}),isCollapsible:!0,isInitiallyOpen:!0,children:(0,p.jsx)(Zt,{options:e,onOptionsChange:t})})};function ar(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function or(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){ar(e,t,r[t])}))}return e}function ir(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function sr({options:e,onOptionsChange:t}){var r,n,a,o,i,s,l;const c=(0,y.useStyles2)(cr);var u;return(0,p.jsxs)("div",{className:(0,h.css)({width:"100%"}),children:[(0,p.jsxs)(y.InlineFieldRow,{className:c.row,children:[(0,p.jsx)(y.InlineField,{tooltip:"The Prometheus data source the trace is going to navigate to",label:"Data source",labelWidth:26,children:(0,p.jsx)(Bt.DataSourcePicker,{inputId:"trace-to-metrics-data-source-picker",pluginId:"prometheus",current:null===(r=e.jsonData.tracesToMetrics)||void 0===r?void 0:r.datasourceUid,noDefault:!0,width:40,onChange:r=>(0,d.updateDatasourcePluginJsonDataOption)({onOptionsChange:t,options:e},"tracesToMetrics",ir(or({},e.jsonData.tracesToMetrics),{datasourceUid:r.uid}))})}),(null===(n=e.jsonData.tracesToMetrics)||void 0===n?void 0:n.datasourceUid)?(0,p.jsx)(y.Button,{type:"button",variant:"secondary",size:"sm",fill:"text",onClick:()=>{(0,d.updateDatasourcePluginJsonDataOption)({onOptionsChange:t,options:e},"tracesToMetrics",ir(or({},e.jsonData.tracesToMetrics),{datasourceUid:void 0}))},children:"Clear"}):null]}),(0,p.jsx)(y.InlineFieldRow,{children:(0,p.jsx)(Wt,{label:er("start"),tooltip:tr("start","-2m"),value:(null===(a=e.jsonData.tracesToMetrics)||void 0===a?void 0:a.spanStartTimeShift)||"",onChange:r=>{(0,d.updateDatasourcePluginJsonDataOption)({onOptionsChange:t,options:e},"tracesToMetrics",ir(or({},e.jsonData.tracesToMetrics),{spanStartTimeShift:r}))},placeholder:"-2m",isInvalidError:rr})}),(0,p.jsx)(y.InlineFieldRow,{children:(0,p.jsx)(Wt,{label:er("end"),tooltip:tr("end","2m"),value:(null===(o=e.jsonData.tracesToMetrics)||void 0===o?void 0:o.spanEndTimeShift)||"",onChange:r=>{(0,d.updateDatasourcePluginJsonDataOption)({onOptionsChange:t,options:e},"tracesToMetrics",ir(or({},e.jsonData.tracesToMetrics),{spanEndTimeShift:r}))},placeholder:"2m",isInvalidError:rr})}),(0,p.jsx)(y.InlineFieldRow,{children:(0,p.jsx)(y.InlineField,{tooltip:"Tags that will be used in the metrics query",label:"Tags",labelWidth:26,children:(0,p.jsx)(Vt,{values:null!==(u=null===(i=e.jsonData.tracesToMetrics)||void 0===i?void 0:i.tags)&&void 0!==u?u:[],onChange:r=>(0,d.updateDatasourcePluginJsonDataOption)({onOptionsChange:t,options:e},"tracesToMetrics",ir(or({},e.jsonData.tracesToMetrics),{tags:r}))})})}),null===(l=e.jsonData.tracesToMetrics)||void 0===l||null===(s=l.queries)||void 0===s?void 0:s.map(((r,n)=>(0,p.jsxs)("div",{className:c.queryRow,children:[(0,p.jsx)(y.InlineField,{label:"Link Label",labelWidth:26,tooltip:"Descriptive label for the linked query",children:(0,p.jsx)(y.Input,{label:"Link Label",type:"text",allowFullScreen:!0,value:r.name,width:40,onChange:r=>{var a,o;const i=(null!==(o=null===(a=e.jsonData.tracesToMetrics)||void 0===a?void 0:a.queries)&&void 0!==o?o:[]).map(((e,t)=>t===n?ir(or({},e),{name:r.currentTarget.value}):e));(0,d.updateDatasourcePluginJsonDataOption)({onOptionsChange:t,options:e},"tracesToMetrics",ir(or({},e.jsonData.tracesToMetrics),{queries:i}))}})}),(0,p.jsx)(y.InlineField,{label:"Query",labelWidth:10,tooltip:"The Prometheus query that will run when navigating from a trace to metrics. Interpolate tags using the `$__tags` keyword",grow:!0,children:(0,p.jsx)(y.Input,{label:"Query",type:"text",allowFullScreen:!0,value:r.query,onChange:r=>{var a,o;const i=(null!==(o=null===(a=e.jsonData.tracesToMetrics)||void 0===a?void 0:a.queries)&&void 0!==o?o:[]).map(((e,t)=>t===n?ir(or({},e),{query:r.currentTarget.value}):e));(0,d.updateDatasourcePluginJsonDataOption)({onOptionsChange:t,options:e},"tracesToMetrics",ir(or({},e.jsonData.tracesToMetrics),{queries:i}))}})}),(0,p.jsx)(y.Button,{variant:"destructive",title:"Remove query",icon:"times",type:"button",onClick:()=>{var r;const a=null===(r=e.jsonData.tracesToMetrics)||void 0===r?void 0:r.queries.filter(((e,t)=>t!==n));(0,d.updateDatasourcePluginJsonDataOption)({onOptionsChange:t,options:e},"tracesToMetrics",ir(or({},e.jsonData.tracesToMetrics),{queries:a}))}})]},n))),(0,p.jsx)(y.Button,{variant:"secondary",title:"Add query",icon:"plus",type:"button",onClick:()=>{var r,n;(0,d.updateDatasourcePluginJsonDataOption)({onOptionsChange:t,options:e},"tracesToMetrics",ir(or({},e.jsonData.tracesToMetrics),{queries:[...null!==(n=null===(r=e.jsonData.tracesToMetrics)||void 0===r?void 0:r.queries)&&void 0!==n?n:[],{query:""}]}))},children:"Add query"})]})}const lr=({options:e,onOptionsChange:t})=>{let r=e.type;return r+="tempo"===e.type?"/configure-tempo-data-source/#trace-to-metrics":"/#trace-to-metrics",(0,p.jsx)($,{title:"Trace to metrics",description:(0,p.jsx)(Mt,{description:"Navigate from a trace span to the selected data source's metrics.",suffix:r,feature:"trace to metrics"}),isCollapsible:!0,isInitiallyOpen:!0,children:(0,p.jsx)(sr,{options:e,onOptionsChange:t})})},cr=e=>({infoText:{paddingBottom:e.spacing(2),color:e.colors.text.secondary},row:(0,h.css)({label:"row",alignItems:"baseline"}),queryRow:(0,h.css)({label:"queryRow",display:"flex",flexFlow:"wrap"})});function ur(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function dr({options:e,onOptionsChange:t}){var r;const n=(0,y.useStyles2)(hr);return(0,p.jsx)("div",{className:n.container,children:(0,p.jsx)(y.InlineFieldRow,{className:n.row,children:(0,p.jsx)(y.InlineField,{tooltip:"Displays the node graph above the trace view. Default: disabled",label:"Enable node graph",labelWidth:26,children:(0,p.jsx)(y.InlineSwitch,{id:"enableNodeGraph",value:null===(r=e.jsonData.nodeGraph)||void 0===r?void 0:r.enabled,onChange:r=>{return(0,d.updateDatasourcePluginJsonDataOption)({onOptionsChange:t,options:e},"nodeGraph",(n=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){ur(e,t,r[t])}))}return e}({},e.jsonData.nodeGraph),a=null!=(a={enabled:r.currentTarget.checked})?a:{},Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(a)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(a)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(a,e))})),n));var n,a}})})})})}const pr=({options:e,onOptionsChange:t})=>{let r=e.type;return r+="tempo"===e.type?"/configure-tempo-data-source/#node-graph":"/#node-graph",(0,p.jsx)(ie,{title:"Node graph",description:(0,p.jsx)(Mt,{description:"Show or hide the node graph visualization.",suffix:r,feature:"the node graph"}),children:(0,p.jsx)(dr,{options:e,onOptionsChange:t})})},hr=e=>({infoText:(0,h.css)({label:"infoText",paddingBottom:e.spacing(2),color:e.colors.text.secondary}),container:(0,h.css)({label:"container",width:"100%"}),row:(0,h.css)({label:"row",alignItems:"baseline"})});function fr(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function mr(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){fr(e,t,r[t])}))}return e}function yr(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const br="None",gr="Duration",vr="Tag";function Or({options:e,onOptionsChange:t}){var r,n,a;const o=(0,y.useStyles2)(wr),i=[br,gr,vr].map(d.toOption);return(0,p.jsxs)("div",{className:(0,h.css)({width:"100%"}),children:[(0,p.jsx)(y.InlineFieldRow,{className:o.row,children:(0,p.jsx)(y.InlineField,{label:"Label",labelWidth:26,tooltip:"Default: duration",grow:!0,children:(0,p.jsx)(y.Select,{inputId:"label",options:i,value:(null===(r=e.jsonData.spanBar)||void 0===r?void 0:r.type)||"",onChange:r=>{var n;(0,d.updateDatasourcePluginJsonDataOption)({onOptionsChange:t,options:e},"spanBar",yr(mr({},e.jsonData.spanBar),{type:null!==(n=null==r?void 0:r.value)&&void 0!==n?n:""}))},placeholder:"Duration",isClearable:!0,"aria-label":"select-label-name",width:40})})}),(null===(n=e.jsonData.spanBar)||void 0===n?void 0:n.type)===vr&&(0,p.jsx)(y.InlineFieldRow,{className:o.row,children:(0,p.jsx)(y.InlineField,{label:"Tag key",labelWidth:26,tooltip:"Tag key which will be used to get the tag value. A span's attributes and resources will be searched for the tag key",children:(0,p.jsx)(y.Input,{type:"text",placeholder:"Enter tag key",onChange:r=>(0,d.updateDatasourcePluginJsonDataOption)({onOptionsChange:t,options:e},"spanBar",yr(mr({},e.jsonData.spanBar),{tag:r.currentTarget.value})),value:(null===(a=e.jsonData.spanBar)||void 0===a?void 0:a.tag)||"",width:40})})})]})}const jr=({options:e,onOptionsChange:t})=>{let r=e.type;return r+="tempo"===e.type?"/configure-tempo-data-source/#span-bar":"/#span-bar",(0,p.jsx)(ie,{title:"Span bar",description:(0,p.jsx)(Mt,{description:"Add additional info next to the service and operation on a span bar row in the trace view.",suffix:r,feature:"the span bar"}),children:(0,p.jsx)(Or,{options:e,onOptionsChange:t})})},wr=e=>({infoText:(0,h.css)({label:"infoText",paddingBottom:e.spacing(2),color:e.colors.text.secondary}),row:(0,h.css)({label:"row",alignItems:"baseline"})});function Tr(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function xr(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){Tr(e,t,r[t])}))}return e}const Cr=e=>({container:(0,h.css)({marginBottom:e.spacing(2),maxWidth:"900px"})});var Dr=c(241),Pr=function(e,t){return Pr=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},Pr(e,t)};function Sr(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}Pr(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var Fr=function(){return Fr=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var a in t=arguments[r])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e},Fr.apply(this,arguments)};function Er(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function Ir(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,a,o=r.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(n=o.next()).done;)i.push(n.value)}catch(e){a={error:e}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(a)throw a.error}}return i}function Nr(e,t,r){if(r||2===arguments.length)for(var n,a=0,o=t.length;a<o;a++)!n&&a in t||(n||(n=Array.prototype.slice.call(t,0,a)),n[a]=t[a]);return e.concat(n||Array.prototype.slice.call(t))}function kr(){var e=(0,f.useRef)(!1),t=(0,f.useCallback)((function(){return e.current}),[]);return(0,f.useEffect)((function(){return e.current=!0,function(){e.current=!1}}),[]),t}function Ar(e,t,r){void 0===t&&(t=[]),void 0===r&&(r={loading:!1});var n=(0,f.useRef)(0),a=kr(),o=(0,f.useState)(r),i=o[0],s=o[1],l=(0,f.useCallback)((function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var o=++n.current;return i.loading||s((function(e){return Fr(Fr({},e),{loading:!0})})),e.apply(void 0,t).then((function(e){return a()&&o===n.current&&s({value:e,loading:!1}),e}),(function(e){return a()&&o===n.current&&s({error:e,loading:!1}),e}))}),t);return[i,l]}Object.create,Object.create,"function"==typeof SuppressedError&&SuppressedError;const Rr=function(e){var t;t=function(){e()},(0,f.useEffect)(t,[])};var qr;!function(e){e[e.Error=7e3]="Error",e[e.Info=3e3]="Info",e[e.Success=3e3]="Success",e[e.Warning=5e3]="Warning"}(qr||(qr={}));const Mr={error:7e3,info:3e3,success:3e3,warning:5e3},_r=e=>{const t=(r=(0,y.useTheme2)(),(0,h.css)({position:"absolute",zIndex:r.zIndex.portal,top:0,right:10}));var r;const[n,a]=(0,f.useState)(!1),[o,i]=(0,f.useState)();return(0,f.useEffect)((()=>()=>{o&&clearTimeout(o)}),[o]),(0,f.useEffect)((()=>{if(""!==e.text){a(!0);const t=setTimeout((()=>{a(!1)}),Mr[e.severity]);i(t)}}),[e.severity,e.text]),(0,p.jsx)(p.Fragment,{children:n&&(0,p.jsx)(y.Alert,{className:t,elevated:!0,onRemove:()=>a(!1),severity:e.severity,title:e.text})})},Br="/api/v2";function Jr(e,t,r,n,a,o,i){try{var s=e[o](i),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function Lr(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Jr(o,n,a,i,s,"next",e)}function s(e){Jr(o,n,a,i,s,"throw",e)}i(void 0)}))}}function $r(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Wr(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){$r(e,t,r[t])}))}return e}function Gr(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const Ur=e=>({tracesCascader:(0,h.css)({label:"tracesCascader",marginRight:e.spacing(1)})}),zr=[{label:"No traces found",value:"no_traces",isLeaf:!0}],Vr={"[No traces in time range]":"__NO_TRACES__"};var Hr=c(269);function Qr(e){return"function"==typeof e}var Kr,Yr=((Kr=function(e){var t;t=this,Error.call(t),t.stack=(new Error).stack,this.message=e?e.length+" errors occurred during unsubscription:\n"+e.map((function(e,t){return t+1+") "+e.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=e}).prototype=Object.create(Error.prototype),Kr.prototype.constructor=Kr,Kr);function Zr(e,t){if(e){var r=e.indexOf(t);0<=r&&e.splice(r,1)}}var Xr=function(){function e(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}var t;return e.prototype.unsubscribe=function(){var e,t,r,n,a;if(!this.closed){this.closed=!0;var o=this._parentage;if(o)if(this._parentage=null,Array.isArray(o))try{for(var i=Er(o),s=i.next();!s.done;s=i.next())s.value.remove(this)}catch(t){e={error:t}}finally{try{s&&!s.done&&(t=i.return)&&t.call(i)}finally{if(e)throw e.error}}else o.remove(this);var l=this.initialTeardown;if(Qr(l))try{l()}catch(e){a=e instanceof Yr?e.errors:[e]}var c=this._finalizers;if(c){this._finalizers=null;try{for(var u=Er(c),d=u.next();!d.done;d=u.next()){var p=d.value;try{en(p)}catch(e){a=null!=a?a:[],e instanceof Yr?a=Nr(Nr([],Ir(a)),Ir(e.errors)):a.push(e)}}}catch(e){r={error:e}}finally{try{d&&!d.done&&(n=u.return)&&n.call(u)}finally{if(r)throw r.error}}}if(a)throw new Yr(a)}},e.prototype.add=function(t){var r;if(t&&t!==this)if(this.closed)en(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=null!==(r=this._finalizers)&&void 0!==r?r:[]).push(t)}},e.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},e.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},e.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&Zr(t,e)},e.prototype.remove=function(t){var r=this._finalizers;r&&Zr(r,t),t instanceof e&&t._removeParent(this)},e.EMPTY=((t=new e).closed=!0,t),e}();function en(e){Qr(e)?e():e.unsubscribe()}Xr.EMPTY;var tn=null,rn=null,nn=!1,an=!1,on={setTimeout:function(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];var a=on.delegate;return(null==a?void 0:a.setTimeout)?a.setTimeout.apply(a,Nr([e,t],Ir(r))):setTimeout.apply(void 0,Nr([e,t],Ir(r)))},clearTimeout:function(e){var t=on.delegate;return((null==t?void 0:t.clearTimeout)||clearTimeout)(e)},delegate:void 0};function sn(){}var ln=cn("C",void 0,void 0);function cn(e,t,r){return{kind:e,value:t,error:r}}var un=function(e){function t(t){var r,n=e.call(this)||this;return n.isStopped=!1,t?(n.destination=t,((r=t)instanceof Xr||r&&"closed"in r&&Qr(r.remove)&&Qr(r.add)&&Qr(r.unsubscribe))&&t.add(n)):n.destination=bn,n}return Sr(t,e),t.create=function(e,t,r){return new fn(e,t,r)},t.prototype.next=function(e){this.isStopped?yn(function(e){return cn("N",e,void 0)}(e),this):this._next(e)},t.prototype.error=function(e){this.isStopped?yn(cn("E",void 0,e),this):(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped?yn(ln,this):(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){try{this.destination.error(e)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(Xr),dn=Function.prototype.bind;function pn(e,t){return dn.call(e,t)}var hn=function(){function e(e){this.partialObserver=e}return e.prototype.next=function(e){var t=this.partialObserver;if(t.next)try{t.next(e)}catch(e){mn(e)}},e.prototype.error=function(e){var t=this.partialObserver;if(t.error)try{t.error(e)}catch(e){mn(e)}else mn(e)},e.prototype.complete=function(){var e=this.partialObserver;if(e.complete)try{e.complete()}catch(e){mn(e)}},e}(),fn=function(e){function t(t,r,n){var a,o,i=e.call(this)||this;return Qr(t)||!t?a={next:null!=t?t:void 0,error:null!=r?r:void 0,complete:null!=n?n:void 0}:i&&an?((o=Object.create(t)).unsubscribe=function(){return i.unsubscribe()},a={next:t.next&&pn(t.next,o),error:t.error&&pn(t.error,o),complete:t.complete&&pn(t.complete,o)}):a=t,i.destination=new hn(a),i}return Sr(t,e),t}(un);function mn(e){nn||function(e){on.setTimeout((function(){if(!tn)throw e;tn(e)}))}(e)}function yn(e,t){var r=rn;r&&on.setTimeout((function(){return r(e,t)}))}var bn={closed:!0,next:sn,error:function(e){throw e},complete:sn},gn=function(e){function t(t,r,n,a,o,i){var s=e.call(this,t)||this;return s.onFinalize=o,s.shouldUnsubscribe=i,s._next=r?function(e){try{r(e)}catch(e){t.error(e)}}:e.prototype._next,s._error=a?function(e){try{a(e)}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._error,s._complete=n?function(){try{n()}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._complete,s}return Sr(t,e),t.prototype.unsubscribe=function(){var t;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var r=this.closed;e.prototype.unsubscribe.call(this),!r&&(null===(t=this.onFinalize)||void 0===t||t.call(this))}},t}(un);function vn(e,t){return r=function(r,n){var a=0;r.subscribe(new gn(n,(function(r){n.next(e.call(t,r,a++))}),void 0,void 0,void 0))},function(e){if(function(e){return Qr(null==e?void 0:e.lift)}(e))return e.lift((function(e){try{return r(e,this)}catch(e){this.error(e)}}));throw new TypeError("Unable to lift unknown Observable type")};var r}function On(e,t,r){return{main:`${jn(e)}ms (${jn(e/t*100)}%)`,secondary:`${jn(r)}ms (${jn(r/e*100)}%)`}}function jn(e){return parseFloat(e.toFixed(2))}function wn(e){const t=e.map(Tn),r=new d.MutableDataFrame({fields:[{name:"traceID",type:d.FieldType.string,values:[]},{name:"spanID",type:d.FieldType.string,values:[]},{name:"parentSpanID",type:d.FieldType.string,values:[]},{name:"operationName",type:d.FieldType.string,values:[]},{name:"serviceName",type:d.FieldType.string,values:[]},{name:"serviceTags",type:d.FieldType.other,values:[]},{name:"startTime",type:d.FieldType.number,values:[]},{name:"duration",type:d.FieldType.number,values:[]},{name:"logs",type:d.FieldType.other,values:[]},{name:"tags",type:d.FieldType.other,values:[]}],meta:{preferredVisualisationType:"trace",custom:{traceFormat:"zipkin"}}});for(const e of t)r.add(e);return r}function Tn(e){var t,r,n,a;const o={traceID:e.traceId,spanID:e.id,parentSpanID:e.parentId,operationName:e.name,serviceName:(null===(t=e.localEndpoint)||void 0===t?void 0:t.serviceName)||(null===(r=e.remoteEndpoint)||void 0===r?void 0:r.serviceName)||"unknown",serviceTags:Cn(e),startTime:e.timestamp/1e3,duration:e.duration/1e3,logs:null!==(a=null===(n=e.annotations)||void 0===n?void 0:n.map(xn))&&void 0!==a?a:[],tags:Object.keys(e.tags||{}).reduce(((t,r)=>"error"===r?(t.push({key:"error",value:!0}),t.push({key:"errorValue",value:e.tags.error}),t):(t.push({key:r,value:e.tags[r]}),t)),[])};var i,s;return e.kind&&(o.tags=[{key:"kind",value:e.kind},...null!==(i=o.tags)&&void 0!==i?i:[]]),e.shared&&(o.tags=[{key:"shared",value:e.shared},...null!==(s=o.tags)&&void 0!==s?s:[]]),o}function xn(e){return{timestamp:e.timestamp,fields:[{key:"annotation",value:e.value}]}}function Cn(e){const t=e.localEndpoint||e.remoteEndpoint;return t?[Dn("ipv4",t.ipv4),Dn("ipv6",t.ipv6),Dn("port",t.port),Dn("endpointType",e.localEndpoint?"local":"remote")].filter((e=>Boolean(e))):[]}function Dn(e,t){if(t)return{key:e,value:t}}function Pn(e,t,r,n,a,o,i){try{var s=e[o](i),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function Sn(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Pn(o,n,a,i,s,"next",e)}function s(e){Pn(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Fn(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function En(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){Fn(e,t,r[t])}))}return e}function In(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}class Nn extends d.DataSourceApi{query(e){const t=e.targets[0];if("upload"===t.queryType){if(!this.uploadedJson)return(0,Hr.of)({data:[]});try{var r;const e=JSON.parse(this.uploadedJson);return(0,Hr.of)(kn({data:e},null===(r=this.nodeGraph)||void 0===r?void 0:r.enabled))}catch(e){return(0,Hr.of)({error:{message:"JSON is not valid Zipkin format"},data:[]})}}if(t.query){const r=this.applyVariables(t,e.scopedVars);return this.request(`${Br}/trace/${encodeURIComponent(r.query)}`).pipe(vn((e=>{var t;return kn(e,null===(t=this.nodeGraph)||void 0===t?void 0:t.enabled)})))}return(0,Hr.of)(An)}metadataRequest(e,t){var r=this;return Sn((function*(){return(yield(0,Hr.lastValueFrom)(r.request(e,t,{hideFromInspector:!0}))).data}))()}testDatasource(){var e=this;return Sn((function*(){return yield e.metadataRequest(`${Br}/services`),{status:"success",message:"Data source is working"}}))()}getQueryDisplayText(e){return e.query}interpolateVariablesInQueries(e,t){return e&&0!==e.length?e.map((e=>En(In(En({},e),{datasource:this.getRef()}),this.applyVariables(e,t)))):[]}applyVariables(e,t){const r=En({},e);var n;return In(En({},r),{query:this.templateSrv.replace(null!==(n=e.query)&&void 0!==n?n:"",t)})}request(e,t,r){const n=t?d.urlUtil.serializeParams(t):"",a=`${this.instanceSettings.url}${e}${n.length?`?${n}`:""}`,o=In(En({},r),{url:a});return(0,Bt.getBackendSrv)().fetch(o)}constructor(e,t=(0,Bt.getTemplateSrv)()){super(e),Fn(this,"instanceSettings",void 0),Fn(this,"templateSrv",void 0),Fn(this,"uploadedJson",void 0),Fn(this,"nodeGraph",void 0),Fn(this,"spanBar",void 0),this.instanceSettings=e,this.templateSrv=t,this.uploadedJson=null,this.nodeGraph=e.jsonData.nodeGraph}}function kn(e,t=!1){let r=(null==e?void 0:e.data)?[wn(null==e?void 0:e.data)]:[];return t&&r.push(...function(e){const{nodes:t,edges:r}=function(e){const t=[],r=[],n=function(e){let t=0,r=1/0;for(const n of e)n.timestamp<r&&(r=n.timestamp),n.timestamp+n.duration>t&&(t=n.timestamp+n.duration);return t-r}(e),a=function(e){const t={};let r;for(let n=0;r=e(n),r;n++){t[r.id]?t[r.id].span=r.span:t[r.id]={span:r.span,children:[]};for(const e of r.parentIds)e&&(t[e]?t[e].children.push(r.id):t[e]={span:void 0,children:[r.id]})}return t}((t=>{if(!(t>=e.length))return{span:e[t],id:e[t].id,parentIds:e[t].parentId?[e[t].parentId]:[]}}));for(const l of e){var o,i;const e=((s=a[l.id].children.map((e=>{const t=a[e].span;return[t.timestamp,t.timestamp+t.duration]}))).sort(((e,t)=>e[0]-t[0])),s.reduce(((e,t)=>{if(!e.length)return[t];const r=e.slice(-1)[0],[n,a]=r,[o,i]=t;return i<a?e:o>a?[...e,t]:[...e.slice(0,-1),[n,i]]}),[]).reduce(((e,t)=>e+(t[1]-t[0])),0)),c=l.duration-e,u=On(l.duration/1e3,n/1e3,c/1e3);t.push({[d.NodeGraphDataFrameFieldNames.id]:l.id,[d.NodeGraphDataFrameFieldNames.title]:(null===(o=l.localEndpoint)||void 0===o?void 0:o.serviceName)||(null===(i=l.remoteEndpoint)||void 0===i?void 0:i.serviceName)||"unknown",[d.NodeGraphDataFrameFieldNames.subTitle]:l.name,[d.NodeGraphDataFrameFieldNames.mainStat]:u.main,[d.NodeGraphDataFrameFieldNames.secondaryStat]:u.secondary,[d.NodeGraphDataFrameFieldNames.color]:c/n}),l.parentId&&a[l.parentId].span&&r.push({[d.NodeGraphDataFrameFieldNames.id]:l.parentId+"--"+l.id,[d.NodeGraphDataFrameFieldNames.target]:l.id,[d.NodeGraphDataFrameFieldNames.source]:l.parentId})}var s;return{nodes:t,edges:r}}(e),[n,a]=[new d.MutableDataFrame({fields:[{name:d.NodeGraphDataFrameFieldNames.id,type:d.FieldType.string},{name:d.NodeGraphDataFrameFieldNames.title,type:d.FieldType.string},{name:d.NodeGraphDataFrameFieldNames.subTitle,type:d.FieldType.string},{name:d.NodeGraphDataFrameFieldNames.mainStat,type:d.FieldType.string,config:{displayName:"Total time (% of trace)"}},{name:d.NodeGraphDataFrameFieldNames.secondaryStat,type:d.FieldType.string,config:{displayName:"Self time (% of total)"}},{name:d.NodeGraphDataFrameFieldNames.color,type:d.FieldType.number,config:{color:{mode:"continuous-GrYlRd"},displayName:"Self time / Trace duration"}}],meta:{preferredVisualisationType:"nodeGraph"}}),new d.MutableDataFrame({fields:[{name:d.NodeGraphDataFrameFieldNames.id,type:d.FieldType.string},{name:d.NodeGraphDataFrameFieldNames.target,type:d.FieldType.string},{name:d.NodeGraphDataFrameFieldNames.source,type:d.FieldType.string}],meta:{preferredVisualisationType:"nodeGraph"}})];for(const e of t)n.add(e);for(const e of r)a.add(e);return[n,a]}(null==e?void 0:e.data)),{data:r}}const An={data:[(0,d.createDataFrame)({fields:[{name:"trace",type:d.FieldType.trace,values:[]}],meta:{preferredVisualisationType:"trace",custom:{traceFormat:"zipkin"}}})]},Rn=new d.DataSourcePlugin(Nn).setQueryEditor((({query:e,onChange:t,onRunQuery:r,datasource:n})=>{const[a,o]=(0,f.useState)(!1),[i,s]=(0,f.useState)(""),l=function(e,t){const r=`${Br}/services`,[n,a]=Ar(Lr((function*(){try{const t=yield e.metadataRequest(r);return t?t.sort().map((e=>({label:e,value:e,isLeaf:!1}))):[]}catch(e){const r=`Failed to load spans from Zipkin: ${(e instanceof Error?e:"An unknown error occurred").toString()}`;throw t(r),e}})),[e]);return Rr((()=>{a()})),n}(n,s),c=(0,y.useTheme2)(),u=(0,y.useStyles2)(Ur),{onLoadOptions:d,allOptions:m}=function(e,t){const r=kr(),[n,a]=(0,f.useState)({}),[,o]=Ar((l=Lr((function*(n){const o=`${Br}/spans`;try{const t=yield e.metadataRequest(o,{serviceName:n});r()&&a((e=>{const r=(0,Dr.fromPairs)(t.map((e=>[e,void 0])));return Gr(Wr({},e),{[n]:r})}))}catch(e){const r=`Failed to load spans from Zipkin: ${(e instanceof Error?e:"An unknown error occurred").toString()}`;throw t(r),e}})),function(e){return l.apply(this,arguments)}),[e,n]),[,i]=Ar((s=Lr((function*(n,o){const i=`${Br}/traces`,s={serviceName:n,spanName:o};try{const t=yield e.metadataRequest(i,s);if(r()){const e=t.length?(0,Dr.fromPairs)(t.map((e=>{const t=e.find((e=>!e.parentId));return[`${t.name} [${Math.floor(t.duration/1e3)} ms]`,t.traceId]}))):Vr;a((t=>{const r=t[n];return Gr(Wr({},t),{[n]:Gr(Wr({},r),{[o]:e})})}))}}catch(e){const r=`Failed to load spans from Zipkin: ${(e instanceof Error?e:"An unknown error occurred").toString()}`;throw t(r),e}})),function(e,t){return s.apply(this,arguments)}),[e]);var s,l;return{onLoadOptions:(0,f.useCallback)((e=>{const t=e[0].value;if(1===e.length)o(t);else if(2===e.length){const r=e[1].value;i(t,r)}}),[o,i]),allOptions:n}}(n,s),b=(0,f.useCallback)(((n,a)=>{if(3===a.length){const n=a[2].value;t(Gr(Wr({},e),{query:n})),r()}}),[t,r,e]);(0,f.useEffect)((()=>{e.queryType||t(Gr(Wr({},e),{queryType:"traceID"}))}),[e,t]);let g=function(e,t){return(0,f.useMemo)((()=>{let r=[];return e.value&&e.value.length?r=e.value.map((e=>Gr(Wr({},e),{children:t[e.value]&&Object.keys(t[e.value]).map((r=>({label:r,value:r,isLeaf:!1,children:t[e.value][r]&&Object.keys(t[e.value][r]).map((n=>({label:n,value:t[e.value][r][n]})))})))}))):e.value&&!e.value.length&&(r=zr),r}),[e,t])}(l,m);return(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)(y.Modal,{title:"Upload trace",isOpen:a,onDismiss:()=>o(!1),children:(0,p.jsx)("div",{className:(0,h.css)({padding:c.spacing(2)}),children:(0,p.jsx)(y.FileDropzone,{options:{multiple:!1},onLoad:a=>{n.uploadedJson=a,t(Gr(Wr({},e),{queryType:"upload"})),o(!1),r()}})})}),(0,p.jsx)(y.InlineFieldRow,{children:(0,p.jsx)(y.InlineField,{label:"Query type",grow:!0,children:(0,p.jsxs)(y.HorizontalGroup,{spacing:"sm",align:"center",justify:"space-between",children:[(0,p.jsx)(y.RadioButtonGroup,{options:[{value:"traceID",label:"TraceID"}],value:e.queryType||"traceID",onChange:r=>t(Gr(Wr({},e),{queryType:r})),size:"md"}),(0,p.jsx)(y.Button,{variant:"secondary",size:"sm",onClick:()=>{o(!0)},children:"Import trace"})]})})}),"traceID"===e.queryType&&(0,p.jsxs)(y.InlineFieldRow,{children:[(0,p.jsx)(y.ButtonCascader,{options:g,onChange:b,loadData:d,variant:"secondary",buttonProps:{className:u.tracesCascader},children:"Traces"}),(0,p.jsx)("div",{className:"gf-form gf-form--grow flex-shrink-1 min-width-15",children:(0,p.jsx)(y.QueryField,{query:e.query,onChange:r=>{const n=Gr(Wr({},e),{query:r});t(n)},onRunQuery:r,placeholder:"Insert Trace ID (run with Shift+Enter)",portalOrigin:"zipkin"})})]}),i&&(0,p.jsx)(_r,{text:i,severity:"error"})]})})).setConfigEditor((({options:e,onOptionsChange:t})=>{const r=(0,y.useStyles2)(Cr);return(0,p.jsxs)("div",{className:r.container,children:[(0,p.jsx)(C,{dataSourceName:"Zipkin",docsLink:"https://grafana.com/docs/grafana/latest/datasources/zipkin",hasRequiredFields:!1}),(0,p.jsx)(y.Divider,{spacing:4}),(0,p.jsx)(K,{config:e,onChange:t,urlPlaceholder:"http://localhost:9411"}),(0,p.jsx)(y.Divider,{spacing:4}),(0,p.jsx)(ct,xr({},jt({config:e,onChange:t}))),(0,p.jsx)(y.Divider,{spacing:4}),(0,p.jsx)(nr,{options:e,onOptionsChange:t}),(0,p.jsx)(y.Divider,{spacing:4}),(0,p.jsx)(lr,{options:e,onOptionsChange:t}),(0,p.jsx)(y.Divider,{spacing:4}),(0,p.jsx)($,{title:"Additional settings",description:"Additional settings are optional settings that can be configured for more control over your data source.",isCollapsible:!0,isInitiallyOpen:!1,children:(0,p.jsxs)(y.Stack,{gap:5,direction:"column",children:[(0,p.jsx)(qt,{config:e,onChange:t}),Bt.config.secureSocksDSProxyEnabled&&(0,p.jsx)(y.SecureSocksProxySettings,{options:e,onOptionsChange:t}),(0,p.jsx)(pr,{options:e,onOptionsChange:t}),(0,p.jsx)(jr,{options:e,onOptionsChange:t})]})})]})}));return u})()));
//# sourceMappingURL=module.js.map