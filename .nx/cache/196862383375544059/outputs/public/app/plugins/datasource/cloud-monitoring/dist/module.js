define(["lodash","@grafana/data","@grafana/runtime","@emotion/css","react","@grafana/ui","rxjs"],((e,t,r,n,a,o,l)=>(()=>{var i={872:(e,t,r)=>{var n=r(781),a=r(7),o=r(959),l=r(241),i=function(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}(o);const c="jwt",s="gce",u="Paste JWT button",p="Upload JWT button",y=["private_key","token_uri","client_email","project_id"],d=({onChange:e,showConfigEditor:t,showPaste:r,showUpload:n,isPasting:l,isUploading:c})=>{const[s,y]=o.useState(),d=a.useTheme2(),f=o.useCallback((e=>{y(null),r()}),[r]),b=o.useCallback((e=>{n(),y(null)}),[n]),v=o.useCallback((r=>{if(""!==r.trim()){let n;try{n=JSON.parse(r)}catch(e){y("Invalid JWT token")}const a=m(n);a.isValid?(t(),e({privateKey:n.private_key,tokenUri:n.token_uri,clientEmail:n.client_email,projectId:n.project_id})):y(a.error)}}),[y,e,t]);return i.default.createElement(i.default.Fragment,null,i.default.createElement(a.Field,{label:"JWT token",invalid:Boolean(s),description:l?"Paste JWT token below":"Upload or paste Google JWT token",error:s},i.default.createElement(i.default.Fragment,null,c&&i.default.createElement("div",{"data-testid":"Configuration drop zone"},a.FileDropzone&&i.default.createElement(a.FileDropzone,{options:{multiple:!1,accept:".json"},readAs:"readAsText",onLoad:e=>{v(e)}},i.default.createElement("p",{style:{margin:0,fontSize:`${d.typography.h4.fontSize}`,textAlign:"center"}},"Drop the Google JWT file here",i.default.createElement("br",null),i.default.createElement("br",null),i.default.createElement(a.Button,{fill:"outline"},"Click to browse files")))),l&&i.default.createElement(a.TextArea,{"data-testid":"Configuration text area",autoFocus:!0,invalid:Boolean(s),placeholder:"Paste Google JWT token here",onBlur:e=>v(e.currentTarget.value),rows:12}))),!l&&i.default.createElement(i.default.Fragment,null,i.default.createElement(a.Button,{"data-testid":u,type:"button",fill:"outline",style:{color:`${d.colors.primary.text}`},onClick:f},"Paste JWT Token"),i.default.createElement("span",{style:{paddingRight:"10px",paddingLeft:"10px"}},"or")),l&&i.default.createElement(i.default.Fragment,null,i.default.createElement(a.Button,{"data-testid":p,type:"button",fill:"outline",style:{color:`${d.colors.primary.text}`},onClick:()=>{n()}},"Upload JWT Token"),i.default.createElement("span",{style:{paddingRight:"10px",paddingLeft:"10px"}},"or")),i.default.createElement(a.Button,{"data-testid":"Fill JWT info manually",type:"button",fill:"outline",style:{color:`${d.colors.primary.text}`},onClick:t},"Fill In JWT Token manually"),l&&s&&i.default.createElement(a.Field,null,i.default.createElement(a.Button,{type:"button",fill:"outline",style:{color:`${d.colors.primary.text}`},onClick:b},"Upload JWT Token")))},m=e=>{if(!l.isObject(e))return{isValid:!1,error:"Invalid JWT token"};const t=y.filter((t=>!e[t]));return t.length>0?{isValid:!1,error:`Missing keys: ${t.join(", ")}`}:{isValid:!0}},{SecretFormField:f}=a.LegacyForms;var b;!function(e){e.PATH="path",e.JWT="jwt"}(b||(b={}));const v=({options:e,onReset:t,onOptionsChange:r,showPaste:o,showUpload:l})=>{var c;const[s,y]=i.default.useState((e=>"privateKeyPath"in e&&""!==e.privateKeyPath?b.PATH:b.JWT)(e.jsonData)),d=t=>n.onUpdateDatasourceJsonDataOption({options:e,onOptionsChange:r},t),m=()=>{s===b.JWT?y(b.PATH):y(b.JWT)},v=a.useTheme2(),g=i.default.createElement("span",null,s===b.PATH?i.default.createElement("a",{className:"external-link",onClick:m,"data-testid":"Show private key input"},"Paste private key"):"Paste private key"," ","or  ",s===b.JWT?i.default.createElement("a",{className:"external-link",onClick:m,"data-testid":"Show private key path input"},"provide path to private file"):"provide path to private key file"),h={isConfigured:Boolean(e.secureJsonFields.privateKey),value:(null===(c=e.secureJsonData)||void 0===c?void 0:c.privateKey)||"",placeholder:"Enter Private key",onReset:()=>t(),onChange:n.onUpdateDatasourceSecureJsonDataOption({options:e,onOptionsChange:r},"privateKey"),"data-testid":"Private Key Input"};return i.default.createElement("div",{"data-testid":"JWT form"},i.default.createElement(a.Field,{label:"Project ID"},i.default.createElement(a.Input,{id:"defaultProject",width:60,value:e.jsonData.defaultProject||"",onChange:d("defaultProject")})),i.default.createElement(a.Field,{label:"Client email"},i.default.createElement(a.Input,{width:60,id:"clientEmail",value:e.jsonData.clientEmail||"",onChange:d("clientEmail")})),i.default.createElement(a.Field,{label:"Token URI"},i.default.createElement(a.Input,{width:60,id:"tokenUri",value:e.jsonData.tokenUri||"",onChange:d("tokenUri")})),s===b.PATH&&i.default.createElement(a.Field,{label:"Private key path",description:g},i.default.createElement(a.Input,{width:60,id:"privateKeyPath",value:e.jsonData.privateKeyPath||"",placeholder:"File location of your private key (e.g. /etc/secrets/gce.pem)",onChange:d("privateKeyPath"),"data-testid":"Private Key Path Input"})),s===b.JWT&&i.default.createElement(i.default.Fragment,null,a.SecretInput?i.default.createElement(a.Field,{label:"Private key",description:g},i.default.createElement(a.SecretInput,Object.assign({},h,{width:60}))):i.default.createElement(f,Object.assign({},h,{label:"Private key",labelWidth:10,inputWidth:20}))),i.default.createElement(i.default.Fragment,null,i.default.createElement(a.Button,{"data-testid":u,type:"button",fill:"outline",style:{color:`${v.colors.primary.text}`},onClick:o},"Paste JWT Token"),i.default.createElement("span",{style:{paddingRight:"10px",paddingLeft:"10px"}},"or"),i.default.createElement(a.Button,{"data-testid":p,type:"button",fill:"outline",style:{color:`${v.colors.primary.text}`},onClick:l},"Upload JWT Token")))};function g(e){const{options:t,onOptionsChange:r,authOptions:l}=e,{jsonData:u,secureJsonFields:p,secureJsonData:y}=t,m=()=>Boolean(u.clientEmail&&u.defaultProject&&u.tokenUri&&(p&&p.privateKey||u.privateKeyPath));u.authenticationType||(u.authenticationType=c);const[f,b]=o.useState(h(u.authenticationType)),[g,O]=o.useState(m()),[E,S]=o.useState(!1),[j,T]=o.useState(!0),P=()=>{S(!1),T(!0),O(!1)},I=()=>{S(!0),T(!1),O(!1)};return i.default.createElement(i.default.Fragment,null,i.default.createElement(a.FieldSet,{label:"Authentication"},i.default.createElement(a.Field,{label:"Authentication type"},i.default.createElement(a.RadioButtonGroup,{options:l,value:u.authenticationType||c,onChange:e=>{O(m()),r(Object.assign(Object.assign({},t),{jsonData:Object.assign(Object.assign({},t.jsonData),{authenticationType:e})})),b(h(e))}}))),f&&i.default.createElement(a.FieldSet,{label:"JWT Key Details"},g?i.default.createElement(v,{options:t,onReset:()=>(e=>{const n=Object.assign({},y),a=Object.assign({},t.jsonData);delete a.clientEmail,delete a.defaultProject,delete a.tokenUri,delete a.privateKeyPath,delete n.privateKey,b(!0),O(!1),r(Object.assign(Object.assign({},t),{secureJsonFields:Object.assign(Object.assign({},t.secureJsonFields),{privateKey:!1}),secureJsonData:n,jsonData:a}))})(),onOptionsChange:r,showUpload:P,showPaste:I}):i.default.createElement(d,{showConfigEditor:()=>{O(!0)},showUpload:P,showPaste:I,isPasting:E,isUploading:j,onChange:e=>{r(Object.assign(Object.assign({},t),{secureJsonFields:Object.assign(Object.assign({},p),{privateKey:!0}),secureJsonData:Object.assign(Object.assign({},y),{privateKey:e.privateKey}),jsonData:Object.assign(Object.assign({},u),{clientEmail:e.clientEmail,defaultProject:e.projectId,tokenUri:e.tokenUri})}))}})," "),u.authenticationType===s&&i.default.createElement(a.Field,{label:"Default project"},i.default.createElement(a.Input,{id:"defaultProject",width:60,value:t.jsonData.defaultProject||"",onChange:n.onUpdateDatasourceJsonDataOption(e,"defaultProject")})))}const h=e=>e===c||void 0===e,O=[{label:"Google JWT File",value:c,ariaLabel:"JWT button"},{label:"GCE Default Service Account",value:s,ariaLabel:"GCE button"}];t.ConnectionConfig=e=>{const{options:{jsonData:t}}=e;t.authenticationType||(t.authenticationType=c);const r=t.authenticationType===c||void 0===t.authenticationType;return i.default.createElement(i.default.Fragment,null,i.default.createElement(g,Object.assign({authOptions:O},e)),i.default.createElement("div",{className:"grafana-info-box",style:{marginTop:"16px"},"data-testid":"Configuration help box"},i.default.createElement("p",null,"Don’t know how to get a service account key file or create a service account? Read more"," ",i.default.createElement("a",{className:"external-link",target:"_blank",rel:"noopener noreferrer",href:"https://grafana.com/docs/grafana/latest/datasources/google-cloud-monitoring/google-authentication/"},"in the documentation."))),!r&&i.default.createElement(a.Alert,{title:"",severity:"info"},"Verify GCE default service account by clicking Save & Test"))}},80:(e,t,r)=>{"use strict";e.exports=r(872)},635:e=>{"use strict";e.exports=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=void 0,a=void 0,o=void 0,l=[];return function(){var c=function(e){return"function"==typeof e?e():e}(t),s=(new Date).getTime(),u=!n||s-n>c;n=s;for(var p=arguments.length,y=Array(p),d=0;d<p;d++)y[d]=arguments[d];if(u&&r.leading)return r.accumulate?Promise.resolve(e.call(this,[y])).then((function(e){return e[0]})):Promise.resolve(e.call.apply(e,[this].concat(y)));if(a?clearTimeout(o):a=function(){var e={};return e.promise=new Promise((function(t,r){e.resolve=t,e.reject=r})),e}(),l.push(y),o=setTimeout(i.bind(this),c),r.accumulate){var m=l.length-1;return a.promise.then((function(e){return e[m]}))}return a.promise};function i(){var t=a;clearTimeout(o),Promise.resolve(r.accumulate?e.call(this,l):e.apply(this,l[l.length-1])).then(t.resolve,t.reject),l=[],a=null}}},89:e=>{"use strict";e.exports=n},781:e=>{"use strict";e.exports=t},531:e=>{"use strict";e.exports=r},7:e=>{"use strict";e.exports=o},241:t=>{"use strict";t.exports=e},959:e=>{"use strict";e.exports=a},269:e=>{"use strict";e.exports=l}},c={};function s(e){var t=c[e];if(void 0!==t)return t.exports;var r=c[e]={exports:{}};return i[e](r,r.exports,s),r.exports}s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var r in t)s.o(t,r)&&!s.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var u={};return(()=>{"use strict";s.r(u),s.d(u,{plugin:()=>Rn});var e=s(241),t=s(781),r=s(531),n=s(89),a=s(959),o=s.n(a);class l extends a.PureComponent{render(){return o().createElement("div",null,o().createElement("h2",null,"Cloud Monitoring alias patterns"),o().createElement("div",null,o().createElement("p",null,"Format the legend keys any way you want by using alias patterns. Format the legend keys any way you want by using alias patterns."),"Example:",o().createElement("code",null,"{{metric.name}} - {{metric.label.instance_name}}"),o().createElement("br",null),"Result:   ",o().createElement("code",null,"cpu/usage_time - server1-europe-west-1"),o().createElement("br",null),o().createElement("br",null),o().createElement("span",null,"Patterns:"),o().createElement("br",null),o().createElement("ul",{className:n.css`
              list-style: none;
            `},o().createElement("li",null,o().createElement("code",null,"{{metric.type}}")," = metric type e.g. compute.googleapis.com/instance/cpu/usage_time"),o().createElement("li",null,o().createElement("code",null,"{{metric.name}}")," = name part of metric e.g. instance/cpu/usage_time"),o().createElement("li",null,o().createElement("code",null,"{{metric.service}}")," = service part of metric e.g. compute"),o().createElement("li",null,o().createElement("code",null,"{{metric.label.label_name}}")," = Metric label metadata e.g. metric.label.instance_name"),o().createElement("li",null,o().createElement("code",null,"{{resource.label.label_name}}")," = Resource label metadata e.g. resource.label.zone"),o().createElement("li",null,o().createElement("code",null,"{{metadata.system_labels.name}}")," = Meta data system labels e.g. metadata.system_labels.name. For this to work, the needs to be included in the group by"),o().createElement("li",null,o().createElement("code",null,"{{metadata.user_labels.name}}")," = Meta data user labels e.g. metadata.user_labels.name. For this to work, the needs to be included in the group by"),o().createElement("li",null,o().createElement("code",null,"{{bucket}}")," = bucket boundary for distribution metrics when using a heatmap in Grafana"),o().createElement("li",null,o().createElement("code",null,"{{project}}")," = The project name that was specified in the query editor"),o().createElement("li",null,o().createElement("code",null,"{{service}}")," = The service id that was specified in the SLO query editor"),o().createElement("li",null,o().createElement("code",null,"{{slo}}")," = The SLO id that was specified in the SLO query editor"),o().createElement("li",null,o().createElement("code",null,"{{selector}}")," = The Selector function that was specified in the SLO query editor"))))}}var i=s(7),c=Object.defineProperty,p=Object.defineProperties,y=Object.getOwnPropertyDescriptors,d=Object.getOwnPropertySymbols,m=Object.prototype.hasOwnProperty,f=Object.prototype.propertyIsEnumerable,b=(e,t,r)=>t in e?c(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,v=(e,t)=>{for(var r in t||(t={}))m.call(t,r)&&b(e,r,t[r]);if(d)for(var r of d(t))f.call(t,r)&&b(e,r,t[r]);return e};const g=({dataSourceName:e,docsLink:t,hasRequiredFields:r=!0,className:a})=>{const l=(0,i.useTheme2)(),c={container:(0,n.css)({p:{margin:0},"p + p":{marginTop:l.spacing(2)}}),text:(0,n.css)((s=v({},l.typography.body),u={color:l.colors.text.secondary,a:(0,n.css)({color:l.colors.text.link,textDecoration:"underline","&:hover":{textDecoration:"none"}})},p(s,y(u))))};var s,u;return o().createElement("div",{className:(0,n.cx)(c.container,a)},o().createElement("p",{className:c.text},"Before you can use the ",e," data source, you must configure it below or in the config file. For detailed instructions,"," ",o().createElement("a",{href:t,target:"_blank",rel:"noreferrer"},"view the documentation"),"."),r&&o().createElement("p",{className:c.text},o().createElement("i",null,"Fields marked with * are required")))};var h=Object.defineProperty,O=Object.defineProperties,E=Object.getOwnPropertyDescriptors,S=Object.getOwnPropertySymbols,j=Object.prototype.hasOwnProperty,T=Object.prototype.propertyIsEnumerable,P=(e,t,r)=>t in e?h(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,I=(e,t)=>{for(var r in t||(t={}))j.call(t,r)&&P(e,r,t[r]);if(S)for(var r of S(t))T.call(t,r)&&P(e,r,t[r]);return e};const w=({children:e,title:t,description:r,isCollapsible:l=!1,isInitiallyOpen:c=!0,kind:s="section",className:u})=>{const{colors:p,typography:y,spacing:d}=(0,i.useTheme2)(),[m,f]=(0,a.useState)(!l||c),b=m?"angle-up":"angle-down",v="sub-section"===s,g=`${m?"Collapse":"Expand"} section ${t}`,h={header:(0,n.css)({display:"flex",justifyContent:"space-between",alignItems:"center"}),title:(0,n.css)({margin:0}),subtitle:(0,n.css)({margin:0,fontWeight:y.fontWeightRegular}),descriptionText:(0,n.css)((S=I({marginTop:d(v?.25:.5),marginBottom:0},y.bodySmall),j={color:p.text.secondary},O(S,E(j)))),content:(0,n.css)({marginTop:d(2)})};var S,j;return o().createElement("div",{className:u},o().createElement("div",{className:h.header},"section"===s?o().createElement("h3",{className:h.title},t):o().createElement("h6",{className:h.subtitle},t),l&&o().createElement(i.IconButton,{name:b,onClick:()=>f(!m),type:"button",size:"xl","aria-label":g})),r&&o().createElement("p",{className:h.descriptionText},r),m&&o().createElement("div",{className:h.content},e))};var N=Object.defineProperty,D=Object.defineProperties,L=Object.getOwnPropertyDescriptors,C=Object.getOwnPropertySymbols,_=Object.prototype.hasOwnProperty,A=Object.prototype.propertyIsEnumerable,x=(e,t,r)=>t in e?N(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;const R=e=>{var t,r=e,{children:n}=r,a=((e,t)=>{var r={};for(var n in e)_.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&C)for(var n of C(e))t.indexOf(n)<0&&A.call(e,n)&&(r[n]=e[n]);return r})(r,["children"]);return o().createElement(w,(t=((e,t)=>{for(var r in t||(t={}))_.call(t,r)&&x(e,r,t[r]);if(C)for(var r of C(t))A.call(t,r)&&x(e,r,t[r]);return e})({},a),D(t,L({kind:"section"}))),n)};var U=s(80);function M(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class k extends a.PureComponent{render(){const{options:e,onOptionsChange:t}=this.props;return o().createElement(o().Fragment,null,o().createElement(g,{dataSourceName:"Google Cloud Monitoring",docsLink:"https://grafana.com/docs/grafana/latest/datasources/google-cloud-monitoring/",hasRequiredFields:!0}),o().createElement(i.Divider,null),o().createElement(U.ConnectionConfig,(n=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){M(e,t,r[t])}))}return e}({},this.props),a=null!=(a={onOptionsChange:this.handleOnOptionsChange})?a:{},Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(a)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(a)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(a,e))})),n)),r.config.secureSocksDSProxyEnabled&&o().createElement(o().Fragment,null,o().createElement(i.Divider,null),o().createElement(R,{title:"Additional settings",description:"Additional settings are optional settings that can be configured for more control over your data source. This includes Secure Socks Proxy.",isCollapsible:!0,isInitiallyOpen:void 0!==e.jsonData.enableSecureSocksProxy},o().createElement(i.SecureSocksProxySettings,{options:e,onOptionsChange:t}))));var n,a}constructor(...e){super(...e),M(this,"handleOnOptionsChange",(e=>{(e.jsonData.privateKeyPath||e.secureJsonFields.privateKey)&&(0,r.reportInteraction)("grafana_cloud_monitoring_config_changed",{authenticationType:"JWT",privateKey:e.secureJsonFields.privateKey,privateKeyPath:!!e.jsonData.privateKeyPath}),this.props.onOptionsChange(e)}))}}var G=Object.getOwnPropertySymbols,Q=Object.prototype.hasOwnProperty,B=Object.prototype.propertyIsEnumerable;const q=e=>{var t=e,{children:r}=t,n=((e,t)=>{var r={};for(var n in e)Q.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&G)for(var n of G(e))t.indexOf(n)<0&&B.call(e,n)&&(r[n]=e[n]);return r})(t,["children"]);const l=(0,i.useStyles2)((0,a.useCallback)((e=>F(e,n)),[n]));return o().createElement("div",{className:l.root},r)},F=(e,t)=>{var r,a,o;return{root:(0,n.css)({display:"flex",flexDirection:null!=(r=t.direction)?r:"row",flexWrap:null==(a=t.wrap)||a?"wrap":void 0,alignItems:t.alignItems,gap:e.spacing(null!=(o=t.gap)?o:2),flexGrow:t.flexGrow})}},V=({children:e})=>o().createElement(q,{gap:.5,direction:"column"},e);var K,$,Y,J,W,z;!function(e){e.ANNOTATION="annotation",e.PROMQL="promQL",e.SLO="slo",e.TIME_SERIES_LIST="timeSeriesList",e.TIME_SERIES_QUERY="timeSeriesQuery"}(K||(K={})),function(e){e.Delta="delta",e.None="none",e.Rate="rate"}($||($={})),function(e){e.CUMULATIVE="CUMULATIVE",e.DELTA="DELTA",e.GAUGE="GAUGE",e.METRIC_KIND_UNSPECIFIED="METRIC_KIND_UNSPECIFIED"}(Y||(Y={})),function(e){e.BOOL="BOOL",e.DISTRIBUTION="DISTRIBUTION",e.DOUBLE="DOUBLE",e.INT64="INT64",e.MONEY="MONEY",e.STRING="STRING",e.VALUE_TYPE_UNSPECIFIED="VALUE_TYPE_UNSPECIFIED"}(J||(J={})),function(e){e.ALIGN_COUNT="ALIGN_COUNT",e.ALIGN_COUNT_FALSE="ALIGN_COUNT_FALSE",e.ALIGN_COUNT_TRUE="ALIGN_COUNT_TRUE",e.ALIGN_DELTA="ALIGN_DELTA",e.ALIGN_FRACTION_TRUE="ALIGN_FRACTION_TRUE",e.ALIGN_INTERPOLATE="ALIGN_INTERPOLATE",e.ALIGN_MAX="ALIGN_MAX",e.ALIGN_MEAN="ALIGN_MEAN",e.ALIGN_MIN="ALIGN_MIN",e.ALIGN_NEXT_OLDER="ALIGN_NEXT_OLDER",e.ALIGN_NONE="ALIGN_NONE",e.ALIGN_PERCENTILE_05="ALIGN_PERCENTILE_05",e.ALIGN_PERCENTILE_50="ALIGN_PERCENTILE_50",e.ALIGN_PERCENTILE_95="ALIGN_PERCENTILE_95",e.ALIGN_PERCENTILE_99="ALIGN_PERCENTILE_99",e.ALIGN_PERCENT_CHANGE="ALIGN_PERCENT_CHANGE",e.ALIGN_RATE="ALIGN_RATE",e.ALIGN_STDDEV="ALIGN_STDDEV",e.ALIGN_SUM="ALIGN_SUM"}(W||(W={})),function(e){e.Aggregations="aggregations",e.Aligners="aligners",e.AlignmentPeriods="alignmentPeriods",e.DefaultProject="defaultProject",e.LabelKeys="labelKeys",e.LabelValues="labelValues",e.MetricTypes="metricTypes",e.Projects="projects",e.ResourceTypes="resourceTypes",e.SLO="slo",e.SLOServices="sloServices",e.Selectors="selectors",e.Services="services"}(z||(z={}));const H=e=>{const t=(0,i.useStyles2)((0,a.useCallback)((t=>X(t,e)),[e]));return o().createElement("span",{className:(0,n.cx)(t.wrapper)})};H.defaultProps={v:0,h:0,layout:"block"};const X=(e,t)=>{var r,a;return{wrapper:(0,n.css)([{paddingRight:e.spacing(null!=(r=t.h)?r:0),paddingBottom:e.spacing(null!=(a=t.v)?a:0)},"inline"===t.layout&&{display:"inline-block"},"block"===t.layout&&{display:"block"}])}};var Z=Object.defineProperty,ee=Object.getOwnPropertySymbols,te=Object.prototype.hasOwnProperty,re=Object.prototype.propertyIsEnumerable,ne=(e,t,r)=>t in e?Z(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;const ae=e=>{var t;const r=e,{label:n,optional:l,tooltip:c,tooltipInteractive:s,children:u,width:p}=r,y=((e,t)=>{var r={};for(var n in e)te.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&ee)for(var n of ee(e))t.indexOf(n)<0&&re.call(e,n)&&(r[n]=e[n]);return r})(r,["label","optional","tooltip","tooltipInteractive","children","width"]),d=(0,i.useStyles2)((0,a.useCallback)((e=>oe(e,p)),[p])),m=(null==y?void 0:y.htmlFor)||(null==(t=i.ReactUtils)?void 0:t.getChildId(u)),f=o().createElement(o().Fragment,null,o().createElement("label",{className:d.label,htmlFor:m},n,l&&o().createElement("span",{className:d.optional}," - optional"),c&&o().createElement(i.Tooltip,{placement:"top",content:c,theme:"info",interactive:s},o().createElement(i.Icon,{tabIndex:0,name:"info-circle",size:"sm",className:d.icon}))),o().createElement(H,{v:.5}));return o().createElement("div",{className:d.root},o().createElement(i.Field,((e,t)=>{for(var r in t||(t={}))te.call(t,r)&&ne(e,r,t[r]);if(ee)for(var r of ee(t))re.call(t,r)&&ne(e,r,t[r]);return e})({className:d.field,label:f},y),u))},oe=(e,t)=>({root:(0,n.css)({minWidth:e.spacing(null!=t?t:0)}),label:(0,n.css)({fontSize:12,fontWeight:e.typography.fontWeightMedium}),optional:(0,n.css)({fontStyle:"italic",color:e.colors.text.secondary}),field:(0,n.css)({marginBottom:0}),icon:(0,n.css)({color:e.colors.text.secondary,marginLeft:e.spacing(1),":hover":{color:e.colors.text.primary}})}),le=({refId:t,value:r="",onChange:n})=>{const[l,c]=(0,a.useState)(null!=r?r:""),s=(0,e.debounce)(n,1e3);return o().createElement(ae,{label:"Alias by"},o().createElement(i.Input,{id:`${t}-alias-by`,value:l,onChange:e=>{c(e.currentTarget.value),s(e.currentTarget.value)}}))},ie=({children:e})=>{const t=(0,i.useStyles2)(ce);return o().createElement("div",{className:t.root},o().createElement(q,{gap:2},e))},ce=e=>({root:(0,n.css)({padding:e.spacing(1),backgroundColor:e.colors.background.secondary,borderRadius:e.shape.borderRadius(1)})}),se=[{text:"none",value:"ALIGN_NONE",valueTypes:[J.INT64,J.DOUBLE,J.MONEY,J.DISTRIBUTION,J.STRING,J.VALUE_TYPE_UNSPECIFIED,J.BOOL],metricKinds:[Y.GAUGE]},{text:"delta",value:"ALIGN_DELTA",valueTypes:[J.INT64,J.DOUBLE,J.MONEY,J.DISTRIBUTION],metricKinds:[Y.CUMULATIVE,Y.DELTA]},{text:"rate",value:"ALIGN_RATE",valueTypes:[J.INT64,J.DOUBLE,J.MONEY],metricKinds:[Y.CUMULATIVE,Y.DELTA]},{text:"interpolate",value:"ALIGN_INTERPOLATE",valueTypes:[J.INT64,J.DOUBLE,J.MONEY],metricKinds:[Y.GAUGE]},{text:"next older",value:"ALIGN_NEXT_OLDER",valueTypes:[J.INT64,J.DOUBLE,J.MONEY,J.DISTRIBUTION,J.STRING,J.VALUE_TYPE_UNSPECIFIED,J.BOOL],metricKinds:[Y.GAUGE]},{text:"min",value:"ALIGN_MIN",valueTypes:[J.INT64,J.DOUBLE,J.MONEY],metricKinds:[Y.GAUGE,Y.DELTA]},{text:"max",value:"ALIGN_MAX",valueTypes:[J.INT64,J.DOUBLE,J.MONEY],metricKinds:[Y.GAUGE,Y.DELTA]},{text:"mean",value:"ALIGN_MEAN",valueTypes:[J.INT64,J.DOUBLE,J.MONEY],metricKinds:[Y.GAUGE,Y.DELTA]},{text:"count",value:"ALIGN_COUNT",valueTypes:[J.INT64,J.DOUBLE,J.MONEY,J.BOOL],metricKinds:[Y.GAUGE,Y.DELTA]},{text:"sum",value:"ALIGN_SUM",valueTypes:[J.INT64,J.DOUBLE,J.MONEY,J.DISTRIBUTION],metricKinds:[Y.GAUGE,Y.DELTA]},{text:"stddev",value:"ALIGN_STDDEV",valueTypes:[J.INT64,J.DOUBLE,J.MONEY],metricKinds:[Y.GAUGE,Y.DELTA]},{text:"count true",value:"ALIGN_COUNT_TRUE",valueTypes:[J.BOOL],metricKinds:[Y.GAUGE]},{text:"count false",value:"ALIGN_COUNT_FALSE",valueTypes:[J.BOOL],metricKinds:[Y.GAUGE]},{text:"fraction true",value:"ALIGN_FRACTION_TRUE",valueTypes:[J.BOOL],metricKinds:[Y.GAUGE]},{text:"percentile 99",value:"ALIGN_PERCENTILE_99",valueTypes:[J.DISTRIBUTION],metricKinds:[Y.GAUGE,Y.DELTA]},{text:"percentile 95",value:"ALIGN_PERCENTILE_95",valueTypes:[J.DISTRIBUTION],metricKinds:[Y.GAUGE,Y.DELTA]},{text:"percentile 50",value:"ALIGN_PERCENTILE_50",valueTypes:[J.DISTRIBUTION],metricKinds:[Y.GAUGE,Y.DELTA]},{text:"percentile 05",value:"ALIGN_PERCENTILE_05",valueTypes:[J.DISTRIBUTION],metricKinds:[Y.GAUGE,Y.DELTA]},{text:"percent change",value:"ALIGN_PERCENT_CHANGE",valueTypes:[J.INT64,J.DOUBLE,J.MONEY],metricKinds:[Y.GAUGE,Y.DELTA]}],ue=[{text:"none",value:"REDUCE_NONE",valueTypes:[J.INT64,J.DOUBLE,J.MONEY,J.DISTRIBUTION,J.BOOL,J.STRING],metricKinds:[Y.GAUGE,Y.DELTA,Y.CUMULATIVE,Y.METRIC_KIND_UNSPECIFIED]},{text:"mean",value:"REDUCE_MEAN",valueTypes:[J.INT64,J.DOUBLE,J.MONEY,J.DISTRIBUTION],metricKinds:[Y.GAUGE,Y.DELTA,Y.CUMULATIVE]},{text:"min",value:"REDUCE_MIN",valueTypes:[J.INT64,J.DOUBLE,J.MONEY],metricKinds:[Y.GAUGE,Y.DELTA,Y.CUMULATIVE,Y.METRIC_KIND_UNSPECIFIED]},{text:"max",value:"REDUCE_MAX",valueTypes:[J.INT64,J.DOUBLE,J.MONEY],metricKinds:[Y.GAUGE,Y.DELTA,Y.CUMULATIVE,Y.METRIC_KIND_UNSPECIFIED]},{text:"sum",value:"REDUCE_SUM",valueTypes:[J.INT64,J.DOUBLE,J.MONEY,J.DISTRIBUTION],metricKinds:[Y.GAUGE,Y.DELTA,Y.CUMULATIVE,Y.METRIC_KIND_UNSPECIFIED]},{text:"std. dev.",value:"REDUCE_STDDEV",valueTypes:[J.INT64,J.DOUBLE,J.MONEY,J.DISTRIBUTION],metricKinds:[Y.GAUGE,Y.DELTA,Y.CUMULATIVE,Y.METRIC_KIND_UNSPECIFIED]},{text:"count",value:"REDUCE_COUNT",valueTypes:[J.INT64,J.DOUBLE,J.MONEY,J.DISTRIBUTION,J.BOOL,J.STRING],metricKinds:[Y.GAUGE,Y.DELTA,Y.CUMULATIVE]},{text:"count true",value:"REDUCE_COUNT_TRUE",valueTypes:[J.BOOL],metricKinds:[Y.GAUGE,Y.DELTA]},{text:"count false",value:"REDUCE_COUNT_FALSE",valueTypes:[J.BOOL],metricKinds:[Y.GAUGE,Y.DELTA]},{text:"99th percentile",value:"REDUCE_PERCENTILE_99",valueTypes:[J.INT64,J.DOUBLE,J.MONEY,J.DISTRIBUTION],metricKinds:[Y.GAUGE,Y.DELTA,Y.CUMULATIVE]},{text:"95th percentile",value:"REDUCE_PERCENTILE_95",valueTypes:[J.INT64,J.DOUBLE,J.MONEY,J.DISTRIBUTION],metricKinds:[Y.GAUGE,Y.DELTA,Y.CUMULATIVE]},{text:"50th percentile",value:"REDUCE_PERCENTILE_50",valueTypes:[J.INT64,J.DOUBLE,J.MONEY,J.DISTRIBUTION],metricKinds:[Y.GAUGE,Y.DELTA,Y.CUMULATIVE]},{text:"5th percentile",value:"REDUCE_PERCENTILE_05",valueTypes:[J.INT64,J.DOUBLE,J.MONEY,J.DISTRIBUTION],metricKinds:[Y.GAUGE,Y.DELTA,Y.CUMULATIVE]}],pe=[{text:"grafana auto",value:"grafana-auto"},{text:"stackdriver auto",value:"stackdriver-auto",hidden:!0},{text:"cloud monitoring auto",value:"cloud-monitoring-auto"},{text:"1m",value:"+60s"},{text:"2m",value:"+120s"},{text:"5m",value:"+300s"},{text:"10m",value:"+600s"},{text:"30m",value:"+1800s"},{text:"1h",value:"+3600s"},{text:"3h",value:"+7200s"},{text:"6h",value:"+21600s"},{text:"1d",value:"+86400s"},{text:"3d",value:"+259200s"},{text:"1w",value:"+604800s"}],ye=[{text:"auto",value:"auto"},{text:"1m",value:"1m"},{text:"2m",value:"2m"},{text:"5m",value:"5m"},{text:"10m",value:"10m"},{text:"30m",value:"30m"},{text:"1h",value:"1h"},{text:"3h",value:"3h"},{text:"6h",value:"6h"},{text:"1d",value:"1d"},{text:"3d",value:"3d"},{text:"1w",value:"1w"}],de=[{text:"1m",value:"1m"},{text:"2m",value:"2m"},{text:"5m",value:"5m"},{text:"10m",value:"10m"},{text:"30m",value:"30m"},{text:"1h",value:"1h"},{text:"3h",value:"3h"},{text:"6h",value:"6h"},{text:"24h",value:"24h"},{text:"72h",value:"72h"}],me=["metadata.system_labels.cloud_account","metadata.system_labels.name","metadata.system_labels.region","metadata.system_labels.state","metadata.system_labels.instance_group","metadata.system_labels.node_name","metadata.system_labels.service_name","metadata.system_labels.top_level_controller_type","metadata.system_labels.top_level_controller_name","metadata.system_labels.container_image"],fe="select_slo_burn_rate",be=[{label:"SLI Value",value:"select_slo_health"},{label:"SLO Compliance",value:"select_slo_compliance"},{label:"SLO Error Budget Remaining",value:"select_slo_budget_fraction"},{label:"SLO Burn Rate",value:fe}],ve=[{label:"Builder",value:K.TIME_SERIES_LIST},{label:"MQL",value:K.TIME_SERIES_QUERY},{label:"Service Level Objectives (SLO)",value:K.SLO},{label:"PromQL",value:K.PROMQL}];function ge({refId:e,projectName:t,datasource:r,onChange:n,templateVariableOptions:l}){const[c,s]=(0,a.useState)([]);(0,a.useEffect)((()=>{r.getProjects().then((e=>s(e)))}),[r]);const u=(0,a.useMemo)((()=>[{label:"Template Variables",options:l},...c]),[c,l]);return o().createElement(ae,{label:"Project"},o().createElement(i.Select,{width:"auto",allowCustomValue:!0,formatCreateLabel:e=>`Use project: ${e}`,onChange:({value:e})=>n(e),options:u,value:{value:t,label:t},placeholder:"Select Project",inputId:`${e}-project`}))}const he=({children:e})=>o().createElement(q,{gap:1},e);function Oe(e,t,r,n,a,o,l){try{var i=e[o](l),c=i.value}catch(e){return void r(e)}i.done?t(c):Promise.resolve(c).then(n,a)}function Ee(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const Se=t=>(0,e.uniqBy)(t,"service"),je=(e,t)=>e.filter((e=>e.service===t)),Te=(e,t,r,n)=>{const a=je(e,n).map((e=>({value:e.type,name:e.displayName}))),o=a.some((e=>e.value===r)),l=a.length?a[0].value:"";return{metricTypes:a,selectedMetricType:o?t:l}},Pe=(e,t,r)=>(r&&r===$.Rate&&(t=Y.GAUGE),e?se.filter((r=>-1!==r.valueTypes.indexOf(e)&&-1!==r.metricKinds.indexOf(t))):[]),Ie=(e,t)=>t?ue.filter((r=>-1!==r.valueTypes.indexOf(e)&&-1!==r.metricKinds.indexOf(t))):[],we=(Ne=function*(e,t,r){const n=yield e.getLabels(t,"handleLabelKeysQuery",r);return[...Object.keys(n),...me]},De=function(){var e=this,t=arguments;return new Promise((function(r,n){var a=Ne.apply(e,t);function o(e){Oe(a,r,n,o,l,"next",e)}function l(e){Oe(a,r,n,o,l,"throw",e)}o(void 0)}))},function(e,t,r){return De.apply(this,arguments)});var Ne,De;const Le=(e=J.DOUBLE,t=Y.GAUGE,n=W.ALIGN_MEAN,a)=>{const o=(0,r.getTemplateSrv)(),l=Pe(e,t,a).map((e=>{return t=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){Ee(e,t,r[t])}))}return e}({},e),r=null!=(r={label:e.text})?r:{},Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})),t;var t,r}));return l.some((e=>e.value===o.replace(n)))||(n=l.length>0?l[0].value:W.ALIGN_MEAN),{alignOptions:l,perSeriesAligner:n}},Ce=t=>{const r=t.reduce(((t,r)=>{const n=r.split(".").map(e.startCase),a=(2===n.length?n:(0,e.initial)(n)).join(" "),o={value:r,label:r};return t[a]?t[a]=[...t[a],o]:t[a]=[o],t}),{});return Object.entries(r).map((([e,t])=>({label:e,options:t,expanded:!0})),[])},_e=(e,r)=>{const{perSeriesAligner:n,alignmentPeriod:a}=e;if(!a||!n)return"";const o=se.find((e=>e.value===r.templateSrv.replace(n))),l=parseInt(a,10);var i;return`${t.rangeUtil.secondsToHms(l)} interval (${null!==(i=null==o?void 0:o.text)&&void 0!==i?i:""})`},Ae=e=>{var t,r;const n=null==e||null===(t=e.filters)||void 0===t?void 0:t.findIndex((e=>"metric.type"===e));return(null==e||null===(r=e.filters)||void 0===r?void 0:r[n+2])||""},xe=(e,t)=>{var r;if(!e.filters)return e.filters=["metric.type","=",t],e;const n=null==e||null===(r=e.filters)||void 0===r?void 0:r.findIndex((e=>"metric.type"===e));return-1===n?e.filters.push("metric.type","=",t):e.filters[n+2]=t,e};function Re(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const Ue=e=>{const t=Me(e),r=ke(t,e);return o().createElement(ae,{label:"Group by function","data-testid":"cloud-monitoring-aggregation"},o().createElement(i.Select,{width:"auto",onChange:({value:t})=>e.onChange(t),value:r,options:[{label:"Template Variables",options:e.templateVariableOptions},{label:"Aggregations",expanded:!0,options:t}],placeholder:"Select Reducer",inputId:`${e.refId}-group-by-function`,menuPlacement:"top"}))},Me=({metricDescriptor:e})=>{const t=null==e?void 0:e.valueType,r=null==e?void 0:e.metricKind;return(0,a.useMemo)((()=>t&&r?Ie(t,r).map((e=>{return t=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){Re(e,t,r[t])}))}return e}({},e),r=null!=(r={label:e.text})?r:{},Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})),t;var t,r})):[]),[t,r])},ke=(e,t)=>(0,a.useMemo)((()=>[...e,...t.templateVariableOptions].find((e=>e.value===t.crossSeriesReducer))),[e,t.crossSeriesReducer,t.templateVariableOptions]);function Ge(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Qe(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){Ge(e,t,r[t])}))}return e}function Be(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const qe=({refId:e,labels:t=[],query:r,onChange:n,variableOptionGroup:l,metricDescriptor:c})=>{const s=(0,a.useMemo)((()=>[l,...Ce([...t,...me])]),[t,l]);var u,p;return o().createElement(he,null,o().createElement(ae,{label:"Group by",tooltip:"You can reduce the amount of data returned for a metric by combining different time series. To combine multiple time series, you can specify a grouping and a function. Grouping is done on the basis of labels. The grouping function is used to combine the time series in the group into a single time series."},o().createElement(i.MultiSelect,{allowCustomValue:!0,inputId:`${e}-group-by`,width:"auto",placeholder:"Choose label",options:s,value:null!==(u=r.groupBys)&&void 0!==u?u:[],onChange:e=>{n(Be(Qe({},r),{groupBys:e.map((e=>e.value))}))},menuPlacement:"top"})),o().createElement(Ue,{metricDescriptor:c,templateVariableOptions:l.options,crossSeriesReducer:r.crossSeriesReducer,groupBys:null!==(p=r.groupBys)&&void 0!==p?p:[],onChange:e=>n(Be(Qe({},r),{crossSeriesReducer:e})),refId:e}))};function Fe(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const Ve=({inputId:e,query:t,templateVariableOptions:r,onChange:n,metricDescriptor:l,preprocessor:c})=>{const{perSeriesAligner:s}=t;let{valueType:u,metricKind:p}=l||{};const{perSeriesAligner:y,alignOptions:d}=(0,a.useMemo)((()=>Le(u,p,s,c)),[u,p,s,c]);return o().createElement(i.Select,{onChange:({value:e})=>{return n((r=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){Fe(e,t,r[t])}))}return e}({},t),a=null!=(a={perSeriesAligner:e})?a:{},Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(a)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(a)).forEach((function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(a,e))})),r));var r,a},value:[...d,...r].find((e=>e.value===y)),options:[{label:"Template Variables",options:r},{label:"Alignment options",expanded:!0,options:d}],placeholder:"Select Alignment",inputId:e,menuPlacement:"top"})};function Ke(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function $e({inputId:e,templateVariableOptions:t,onChange:r,current:n,disabled:l,aligmentPeriods:c}){const s=(0,a.useMemo)((()=>c.map((e=>{return t=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){Ke(e,t,r[t])}))}return e}({},e),r=null!=(r={label:e.text})?r:{},Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})),t;var t,r}))),[c]),u=(0,a.useMemo)((()=>s.filter((e=>!e.hidden))),[s]);return o().createElement(i.Select,{width:"auto",onChange:({value:e})=>r(e),value:[...s,...t].find((e=>e.value===n)),options:[{label:"Template Variables",options:t},{label:"Aggregations",expanded:!0,options:u}],placeholder:"Select Period",inputId:e,disabled:l,allowCustomValue:!0,menuPlacement:"top"})}function Ye(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Je(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){Ye(e,t,r[t])}))}return e}const We=({refId:e,templateVariableOptions:t,onChange:r,query:n,customMetaData:l,datasource:i,metricDescriptor:c,preprocessor:s})=>{const u=(0,a.useMemo)((()=>_e(l,i)),[l,i]);return o().createElement(he,null,o().createElement(ae,{label:"Alignment function",tooltip:"The process of alignment consists of collecting all data points received in a fixed length of time, applying a function to combine those data points, and assigning a timestamp to the result."},o().createElement(Ve,{inputId:`${e}-alignment-function`,templateVariableOptions:t,query:n,onChange:e=>r(Je({},n,e)),metricDescriptor:c,preprocessor:s})),o().createElement(ae,{label:"Alignment period",tooltip:u},o().createElement($e,{inputId:`${e}-alignment-period`,templateVariableOptions:t,current:n.alignmentPeriod,onChange:e=>{return r((t=Je({},n),a=null!=(a={alignmentPeriod:e})?a:{},Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(a)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})),t));var t,a},aligmentPeriods:pe})))};var ze=Object.defineProperty,He=Object.defineProperties,Xe=Object.getOwnPropertyDescriptors,Ze=Object.getOwnPropertySymbols,et=Object.prototype.hasOwnProperty,tt=Object.prototype.propertyIsEnumerable,rt=(e,t,r)=>t in e?ze(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;const nt=e=>{var t=e,{className:r}=t,a=((e,t)=>{var r={};for(var n in e)et.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&Ze)for(var n of Ze(e))t.indexOf(n)<0&&tt.call(e,n)&&(r[n]=e[n]);return r})(t,["className"]);const l=(0,i.useStyles2)(at);return o().createElement(i.Button,(c=((e,t)=>{for(var r in t||(t={}))et.call(t,r)&&rt(e,r,t[r]);if(Ze)for(var r of Ze(t))tt.call(t,r)&&rt(e,r,t[r]);return e})({},a),s={className:(0,n.cx)(r,l.button)},He(c,Xe(s))));var c,s},at=e=>({button:(0,n.css)({paddingLeft:e.spacing(1.5),paddingRight:e.spacing(1.5)})}),ot=o().forwardRef((function({items:e,renderItem:t,onChange:r},n){return o().createElement(q,null,e.map(((n,a)=>o().createElement("div",{key:a},t(n,(t=>((t,n)=>{const a=[...e];a[t]=n,r(a)})(a,t)),(()=>(t=>{const n=[...e];n.splice(t,1),r(n)})(a)))))),o().createElement(i.Button,{ref:n,onClick:()=>{const t=[...e,{}];r(t)},variant:"secondary",size:"md",icon:"plus","aria-label":"Add",type:"button"}))})),lt="=",it="AND",ct=["=","!=","=~","!=~"].map(t.toOption),st=["metric.type"],ut=({labels:r={},filters:n,onChange:l,variableOptionGroup:c})=>{const s=(t=>(0,e.chunk)(t,4).map((([e,t,r,n="AND"])=>({key:e,operator:t,value:r,condition:n}))))(n),u=s.filter((({key:e})=>!st.includes(e))),p=s.filter((({key:e})=>st.includes(e))),y=(0,a.useMemo)((()=>[c,...Ce(Object.keys(r))]),[r,c]),d=({key:e="",value:n=""})=>{y.some((t=>t.options?y.some((t=>t.label===e)):t.label===e))||y.push({label:e,value:e});const a=r.hasOwnProperty(e)?[c,...r[e].map(t.toOption)]:[c];return a.some((e=>e.label===n))||a.push({label:n,value:n}),{options:y,valueOptions:a}};return o().createElement(ie,null,o().createElement(ae,{label:"Filter",tooltip:"To reduce the amount of data charted, apply a filter. A filter has three components: a label, a comparison, and a value. The comparison can be an equality, inequality, or regular expression."},o().createElement(ot,{items:u,renderItem:(e,t,r)=>{const{key:n="",operator:a=lt,value:l="",condition:c=it}=e,{options:s,valueOptions:u}=d(e);return o().createElement(i.HorizontalGroup,{spacing:"xs",width:"auto"},o().createElement(i.Select,{"aria-label":"Filter label key",formatCreateLabel:e=>`Use label key: ${e}`,allowCustomValue:!0,value:n,options:s,onChange:({value:e=""})=>t({key:e,operator:a,value:l,condition:c})}),o().createElement(i.Select,{value:a,options:ct,onChange:({value:e=lt})=>t({key:n,operator:e,value:l,condition:c})}),o().createElement(i.Select,{"aria-label":"Filter label value",placeholder:"add filter value",formatCreateLabel:e=>`Use label value: ${e}`,allowCustomValue:!0,value:l,options:u,onChange:({value:e=""})=>t({key:n,operator:a,value:e,condition:c})}),o().createElement(nt,{"aria-label":"Remove",icon:"times",variant:"secondary",onClick:r,type:"button"}))},onChange:e=>{const t=e.concat(p).map((({key:e,operator:t,value:r,condition:n})=>({key:e||"",operator:t||lt,value:r||"",condition:n||it})));l((e=>e.flatMap((({key:e,operator:t,value:r,condition:n})=>[e,t,r,n])).slice(0,-1))(t))}})))},pt=()=>o().createElement("div",{className:"grafana-info-box alert-info"},o().createElement("div",null,o().createElement("h5",null,"Annotation Query Format"),o().createElement("p",null,"An annotation is an event that is overlaid on top of graphs. Annotation rendering is expensive so it is important to limit the number of rows returned."," "),o().createElement("p",null,"The Title and Text fields support templating and can use data returned from the query. For example, the Title field could have the following text:"),o().createElement("code",null,"{{metric.type}}"," has value: ","{{metric.value}}"),o().createElement("p",null,"Example Result: ",o().createElement("code",null,"monitoring.googleapis.com/uptime_check/http_status has this value: 502")),o().createElement("span",null,"Patterns:"),o().createElement("p",null,o().createElement("code",null,"{{metric.value}}")," = value of the metric/point"),o().createElement("p",null,o().createElement("code",null,"{{metric.type}}")," = metric type e.g. compute.googleapis.com/instance/cpu/usage_time"),o().createElement("p",null,o().createElement("code",null,"{{metric.name}}")," = name part of metric e.g. instance/cpu/usage_time"),o().createElement("p",null,o().createElement("code",null,"{{metric.service}}")," = service part of metric e.g. compute"),o().createElement("p",null,o().createElement("code",null,"{{metric.label.label_name}}")," = Metric label metadata e.g. metric.label.instance_name"),o().createElement("p",null,o().createElement("code",null,"{{resource.label.label_name}}")," = Resource label metadata e.g. resource.label.zone")));function yt(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const dt=({refId:e,current:t,templateVariableOptions:r,onChange:n})=>{const a=de.map((e=>{return t=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){yt(e,t,r[t])}))}return e}({},e),r=null!=(r={label:e.text})?r:{},Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})),t;var t,r}));t&&!a.find((e=>e.value===t))&&a.push({label:t,text:t,value:t,hidden:!1});const l=a.filter((e=>!e.hidden));return o().createElement(ae,{label:"Lookback period",htmlFor:`${e}-lookback-period`},o().createElement(i.Select,{inputId:`${e}-lookback-period`,width:"auto",allowCustomValue:!0,value:[...a,...r].find((e=>e.value===t)),options:[{label:"Template Variables",options:r},{label:"Predefined periods",expanded:!0,options:l}],onChange:({value:e})=>n(e)}))};function mt(e,t,r,n,a,o,l){try{var i=e[o](l),c=i.value}catch(e){return void r(e)}i.done?t(c):Promise.resolve(c).then(n,a)}function ft(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const bt=({refId:e,query:t,templateVariableOptions:r,onChange:n,datasource:l})=>{const[c,s]=(0,a.useState)([]),{projectName:u,serviceId:p}=t;return(0,a.useEffect)((()=>{u&&p&&l.getServiceLevelObjectives(u,p).then((e=>{s([{label:"Template Variables",options:r},...e])}))}),[l,u,p,r]),o().createElement(ae,{label:"SLO"},o().createElement(i.Select,{inputId:`${e}-slo`,width:"auto",allowCustomValue:!0,value:(null==t?void 0:t.sloId)&&{value:null==t?void 0:t.sloId,label:(null==t?void 0:t.sloName)||(null==t?void 0:t.sloId)},placeholder:"Select SLO",options:c,onChange:function(){var e=function(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function l(e){mt(o,n,a,l,i,"next",e)}function i(e){mt(o,n,a,l,i,"throw",e)}l(void 0)}))}}((function*({value:e="",label:r=""}){const a=(yield l.getServiceLevelObjectives(u,p)).find((({value:t})=>t===l.templateSrv.replace(e)));var o,i;n((o=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){ft(e,t,r[t])}))}return e}({},t),i=null!=(i={sloId:e,sloName:r,goal:null==a?void 0:a.goal})?i:{},Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(i)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(i)).forEach((function(e){Object.defineProperty(o,e,Object.getOwnPropertyDescriptor(i,e))})),o))}));return function(t){return e.apply(this,arguments)}}()}))};function vt(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const gt=({refId:e,query:t,templateVariableOptions:r,onChange:n,datasource:a})=>o().createElement(ae,{label:"Selector",htmlFor:`${e}-slo-selector`},o().createElement(i.Select,{inputId:`${e}-slo-selector`,width:"auto",allowCustomValue:!0,value:[...be,...r].find((e=>{var r;return null!==(r=e.value===(null==t?void 0:t.selectorName))&&void 0!==r?r:""})),options:[{label:"Template Variables",options:r},...be],onChange:({value:e})=>{return n((r=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){vt(e,t,r[t])}))}return e}({},t),a=null!=(a={selectorName:null!=e?e:""})?a:{},Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(a)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(a)).forEach((function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(a,e))})),r));var r,a}}));function ht(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const Ot=({refId:e,query:t,templateVariableOptions:r,onChange:n,datasource:l})=>{const[c,s]=(0,a.useState)([]),{projectName:u}=t;return(0,a.useEffect)((()=>{u&&l.getSLOServices(u).then((e=>{s([{label:"Template Variables",options:r},...e])}))}),[l,u,r]),o().createElement(ae,{label:"Service"},o().createElement(i.Select,{inputId:`${e}-slo-service`,width:"auto",allowCustomValue:!0,value:(null==t?void 0:t.serviceId)&&{value:null==t?void 0:t.serviceId,label:(null==t?void 0:t.serviceName)||(null==t?void 0:t.serviceId)},placeholder:"Select service",options:c,onChange:({value:e="",label:r=""})=>{return n((a=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){ht(e,t,r[t])}))}return e}({},t),o=null!=(o={serviceId:e,serviceName:r,sloId:""})?o:{},Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(o)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(o)).forEach((function(e){Object.defineProperty(a,e,Object.getOwnPropertyDescriptor(o,e))})),a));var a,o}}))};function Et(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function St(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){Et(e,t,r[t])}))}return e}function jt(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function Tt({refId:e,query:t,datasource:r,onChange:n,variableOptionGroup:l,customMetaData:i,aliasBy:c,onChangeAliasBy:s}){const u=(0,a.useMemo)((()=>_e(i,r)),[i,r]);return o().createElement(o().Fragment,null,o().createElement(ie,null,o().createElement(ge,{refId:e,templateVariableOptions:l.options,projectName:t.projectName,datasource:r,onChange:e=>n(jt(St({},t),{projectName:e}))}),o().createElement(Ot,{refId:e,datasource:r,templateVariableOptions:l.options,query:t,onChange:n}),o().createElement(bt,{refId:e,datasource:r,templateVariableOptions:l.options,query:t,onChange:n}),o().createElement(gt,{refId:e,datasource:r,templateVariableOptions:l.options,query:t,onChange:n}),t.selectorName===fe&&o().createElement(dt,{refId:e,onChange:e=>n(jt(St({},t),{lookbackPeriod:e})),current:t.lookbackPeriod,templateVariableOptions:l.options}),o().createElement(he,null,o().createElement(ae,{label:"Alignment period",tooltip:u},o().createElement($e,{inputId:`${e}-alignment-period`,templateVariableOptions:l.options,current:t.alignmentPeriod,onChange:e=>n(jt(St({},t),{alignmentPeriod:e})),aligmentPeriods:pe}))),o().createElement(le,{refId:e,value:c,onChange:s})))}function Pt({query:e,onChange:t,onRunQuery:r}){return o().createElement(o().Fragment,null,o().createElement(i.TextArea,{name:"Query",className:"slate-query-field",value:e,rows:10,placeholder:"Enter a Cloud Monitoring MQL query (Run with Shift+Enter)",onBlur:r,onChange:e=>t(e.currentTarget.value),onKeyDown:e=>{"Enter"===e.key&&(e.shiftKey||e.ctrlKey)&&(e.preventDefault(),r())}}))}const It=({label:e,onChange:t,value:r,options:n,allowCustomValue:a=!1})=>o().createElement(i.Field,{label:e},o().createElement(i.Select,{width:25,allowCustomValue:a,value:r,onChange:({value:e})=>t(e),options:n}));var wt=s(635),Nt=s.n(wt);function Dt(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const Lt={label:"None",value:$.None},Ct=({query:e,metricDescriptor:t,onChange:r})=>{const n=_t(t);var a;return o().createElement(ae,{label:"Pre-processing",tooltip:"Preprocessing options are displayed when the selected metric has a metric kind of delta or cumulative. The specific options available are determined by the metric's value type. If you select 'Rate', data points are aligned and converted to a rate per time series. If you select 'Delta', data points are aligned by their delta (difference) per time series"},o().createElement(i.RadioButtonGroup,{onChange:n=>{const{perSeriesAligner:a}=e,{valueType:o,metricKind:l}=null!=t?t:{},{perSeriesAligner:i}=Le(o,l,a,n);var c,s;r((c=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){Dt(e,t,r[t])}))}return e}({},e),s=null!=(s={preprocessor:n,perSeriesAligner:i})?s:{},Object.getOwnPropertyDescriptors?Object.defineProperties(c,Object.getOwnPropertyDescriptors(s)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(s)).forEach((function(e){Object.defineProperty(c,e,Object.getOwnPropertyDescriptor(s,e))})),c))},value:null!==(a=e.preprocessor)&&void 0!==a?a:$.None,options:n}))},_t=e=>{const t=null==e?void 0:e.metricKind,r=null==e?void 0:e.valueType;return(0,a.useMemo)((()=>{if(!t||t===Y.GAUGE||r===J.DISTRIBUTION)return[Lt];const e=[Lt,{label:"Rate",value:$.Rate,description:"Data points are aligned and converted to a rate per time series"}];return t===Y.CUMULATIVE?[...e,{label:"Delta",value:$.Delta,description:"Data points are aligned by their delta (difference) per time series"}]:e}),[t,r])};function At(e,t,r,n,a,o,l){try{var i=e[o](l),c=i.value}catch(e){return void r(e)}i.done?t(c):Promise.resolve(c).then(n,a)}function xt(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function l(e){At(o,n,a,l,i,"next",e)}function i(e){At(o,n,a,l,i,"throw",e)}l(void 0)}))}}function Rt(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Ut(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){Rt(e,t,r[t])}))}return e}function Mt(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function kt({refId:t,onChange:n,datasource:l,query:c,variableOptionGroup:s,customMetaData:u,aliasBy:p,onChangeAliasBy:y,range:d}){const[m,f]=(0,a.useState)({}),[b,v]=(0,a.useState)([]),[g,h]=(0,a.useState)(),[O,E]=(0,a.useState)([]),[S,j]=(0,a.useState)([]),[T,P]=(0,a.useState)(""),[I,w]=(0,a.useState)(Ut({},d));var N;N=d,null===I||I.raw.from.toString()===N.raw.from.toString()&&I.raw.to.toString()===N.raw.to.toString()||w(Ut({},N));const D=(0,i.useTheme2)(),L=(0,i.getSelectStyles)(D),C=(0,i.useStyles2)(Gt),{projectName:_,groupBys:A,crossSeriesReducer:x}=c,R=Ae(c),{templateSrv:U}=l,M=(0,a.useCallback)(((e,t)=>e.find((e=>e.type===U.replace(t)))),[U]);(0,a.useEffect)((()=>{_&&R&&l.getLabels(R,t,_,{groupBys:A,crossSeriesReducer:x},I).then((e=>f(e)))}),[l,A,R,_,t,x,I]),(0,a.useEffect)((()=>{const e=function(){var e=xt((function*(){if(_){const e=yield l.getMetricTypes(_);(0,r.reportInteraction)("cloud-monitoring-metric-descriptors-loaded",{count:e.length});const t=k(e);v(e),j(t)}}));return function(){return e.apply(this,arguments)}}();e()}),[l,_,C,L.optionDescription]),(0,a.useEffect)((()=>{const e=(e=>{const t=M(e,R);return t?e.filter((e=>e.service===t.service)).map((e=>({service:e.service,value:e.type,label:e.displayName,component:function(){return o().createElement("div",null,o().createElement("div",{className:C},e.type),o().createElement("div",{className:L.optionDescription},e.description))}}))):[]})(b),t=e.length>0?e[0].service:"",r=M(b,R);h(r),E(e),P(t)}),[b,M,R,C,L.optionDescription]);const k=t=>{const r=t.map((t=>({value:t.service,label:(0,e.startCase)(t.serviceShortName)})));return r.length>0?(0,e.uniqBy)(r,(e=>e.value)):[]},G=function(){var e=xt((function*(e){const t=(yield l.filterMetricsByType(_,T)).filter((t=>t.type.includes(e.toLowerCase()))).map((e=>({value:e.type,label:e.displayName,component:function(){return o().createElement("div",null,o().createElement("div",{className:C},e.type),o().createElement("div",{className:L.optionDescription},e.description))}})));return[{label:"Template Variables",options:s.options},...t]}));return function(t){return e.apply(this,arguments)}}(),Q=Nt()(G,400),B=({value:e})=>{const t=M(b,e);h(t);const{metricKind:r,valueType:a}=t,o=r===Y.GAUGE||a===J.DISTRIBUTION?$.None:$.Rate,{perSeriesAligner:i}=Le(a,r,c.perSeriesAligner,o);Object.assign(c,Mt(Ut({},Kt(l)),{projectName:c.projectName,filters:c.filters})),n(Mt(Ut({},xe(Mt(Ut({},c),{perSeriesAligner:i}),e)),{preprocessor:o}))};return o().createElement(o().Fragment,null,o().createElement(ie,null,o().createElement(he,null,o().createElement(ge,{refId:t,templateVariableOptions:s.options,projectName:_,datasource:l,onChange:e=>{n(Mt(Ut({},c),{projectName:e}))}}),o().createElement(ae,{label:"Service",width:"auto"},o().createElement(i.Select,{width:"auto",onChange:({value:e})=>{const t=b.filter((t=>t.service===U.replace(e))).map((e=>({service:e.service,value:e.type,label:e.displayName,description:e.description})));c.filters=[],t.length>0&&!t.some((e=>e.value===U.replace(R)))?(B(t[0]),P(e),E(t)):(P(e),E(t))},isLoading:0===S.length,value:[...S,...s.options].find((e=>e.value===T)),options:[{label:"Template Variables",options:s.options},...S],placeholder:"Select Services",inputId:`${t}-service`})),o().createElement(ae,{label:"Metric name",width:"auto",htmlFor:`${t}-select-metric`},o().createElement("span",{title:""===T?"Select a service first":"Type to search metrics"},o().createElement(i.AsyncSelect,{width:"auto",onChange:B,value:[...O,...s.options].find((e=>e.value===R)),loadOptions:Q,defaultOptions:[{label:"Template Variables",options:s.options},...O.slice(0,100)],placeholder:"Select Metric",inputId:`${t}-select-metric`,disabled:""===T}))))),o().createElement(o().Fragment,null,o().createElement(ut,{labels:m,filters:c.filters,onChange:e=>n(Mt(Ut({},c),{filters:e})),variableOptionGroup:s}),o().createElement(ie,null,o().createElement(Ct,{metricDescriptor:g,query:c,onChange:n}),o().createElement(qe,{refId:t,labels:Object.keys(m),query:c,onChange:n,variableOptionGroup:s,metricDescriptor:g}),o().createElement(We,{refId:t,datasource:l,templateVariableOptions:s.options,query:c,customMetaData:u,onChange:n,metricDescriptor:g,preprocessor:c.preprocessor}),o().createElement(le,{refId:t,value:p,onChange:y}))))}const Gt=e=>n.css`
  label: grafana-select-option-description;
  font-weight: normal;
  font-style: italic;
  color: ${e.colors.text.secondary};
`,Qt=o().memo(kt),Bt=({refId:e,onChange:t,graphPeriod:r,variableOptionGroup:n})=>o().createElement(ie,null,o().createElement(ae,{label:"Graph period",htmlFor:`${e}-graph-period`,tooltip:o().createElement(o().Fragment,null,"Set ",o().createElement("code",null,"graph_period")," which forces a preferred period between points. Automatically set to the current interval if left blank.")},o().createElement(i.HorizontalGroup,null,o().createElement(i.Switch,{"data-testid":`${e}-switch-graph-period`,value:"disabled"!==r,onChange:e=>t(e.currentTarget.checked?"":"disabled")}),o().createElement($e,{inputId:`${e}-graph-period`,templateVariableOptions:n.options,current:r,onChange:t,disabled:"disabled"===r,aligmentPeriods:ye}))));function qt(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Ft(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){qt(e,t,r[t])}))}return e}function Vt(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const Kt=e=>({projectName:e.getDefaultProject(),crossSeriesReducer:"REDUCE_NONE",alignmentPeriod:"cloud-monitoring-auto",perSeriesAligner:W.ALIGN_MEAN,groupBys:[],filters:[]}),$t=e=>({projectName:e.getDefaultProject(),query:""});function Yt({refId:e,query:t,datasource:r,onChange:n,onRunQuery:l,customMetaData:i,variableOptionGroup:c,range:s}){const u=(0,a.useCallback)((e=>{let r=!0;if((null==e?void 0:e.filters)&&e.filters.length>0)for(const t of e.filters)if(""===t){r=!1;break}n(Vt(Ft({},t),{timeSeriesList:e})),r&&l()}),[n,l,t]),p=(0,a.useCallback)((e=>{n(Vt(Ft({},t),{timeSeriesQuery:e})),l()}),[n,l,t]);return(0,a.useEffect)((()=>{t.queryType!==K.TIME_SERIES_LIST||t.timeSeriesList||n({refId:t.refId,datasource:t.datasource,queryType:K.TIME_SERIES_LIST,timeSeriesList:Kt(r),aliasBy:t.aliasBy}),t.queryType!==K.TIME_SERIES_QUERY||t.timeSeriesQuery||n({refId:t.refId,datasource:t.datasource,queryType:K.TIME_SERIES_QUERY,timeSeriesQuery:$t(r),aliasBy:t.aliasBy})}),[n,t,r]),o().createElement(V,null,(t.queryType===K.ANNOTATION||t.queryType===K.TIME_SERIES_LIST)&&t.timeSeriesList&&o().createElement(Qt,{refId:e,variableOptionGroup:c,customMetaData:i,onChange:u,datasource:r,query:t.timeSeriesList,aliasBy:t.aliasBy,onChangeAliasBy:e=>n(Vt(Ft({},t),{aliasBy:e})),range:s}),t.queryType===K.TIME_SERIES_QUERY&&t.timeSeriesQuery&&o().createElement(o().Fragment,null,o().createElement(q,{gap:1,direction:"row"},o().createElement(ge,{refId:e,datasource:r,onChange:e=>p(Vt(Ft({},t.timeSeriesQuery),{projectName:e})),templateVariableOptions:c.options,projectName:t.timeSeriesQuery.projectName}),o().createElement(le,{refId:e,value:t.aliasBy,onChange:e=>n(Vt(Ft({},t),{aliasBy:e}))})),o().createElement(Pt,{onChange:e=>p(Vt(Ft({},t.timeSeriesQuery),{query:e})),onRunQuery:l,query:t.timeSeriesQuery.query}),o().createElement(Bt,{onChange:e=>p(Vt(Ft({},t.timeSeriesQuery),{graphPeriod:e})),graphPeriod:t.timeSeriesQuery.graphPeriod,refId:e,variableOptionGroup:c})))}const Jt=o().memo(Yt);function Wt(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function zt(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){Wt(e,t,r[t])}))}return e}function Ht(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function Xt({refId:e,query:t,datasource:r,onChange:n,variableOptionGroup:a,onRunQuery:l}){function c(e){"Enter"===e.key&&e.shiftKey&&(l(),e.preventDefault(),e.stopPropagation())}var s;return o().createElement(o().Fragment,null,o().createElement(ie,null,o().createElement(ge,{refId:e,templateVariableOptions:a.options,projectName:t.projectName,datasource:r,onChange:e=>n(Ht(zt({},t),{projectName:e}))}),o().createElement(i.TextArea,{name:"Query",className:"slate-query-field",value:t.expr,rows:10,placeholder:"Enter a Cloud Monitoring Prometheus query (Run with Shift+Enter)",onBlur:l,onKeyDown:c,onChange:e=>n(Ht(zt({},t),{expr:e.currentTarget.value}))}),o().createElement(ae,{label:"Min step",tooltip:"Time units and built-in variables can be used here, for example: $__interval, $__rate_interval, 5s, 1m, 3h, 1d, 1y (Default if no unit is specified: 10s)"},o().createElement(i.Input,{type:"string",placeholder:"auto",onChange:e=>n(Ht(zt({},t),{step:e.currentTarget.value})),onKeyDown:c,value:null!==(s=t.step)&&void 0!==s?s:""}))))}const Zt=({children:e})=>{const t=(0,i.useStyles2)(er);return o().createElement("div",{className:t.root},e)},er=e=>({root:(0,n.css)({display:"flex",flexWrap:"wrap",alignItems:"center",gap:e.spacing(3),minHeight:e.spacing(4)})});var tr=Object.defineProperty,rr=Object.defineProperties,nr=Object.getOwnPropertyDescriptors,ar=Object.getOwnPropertySymbols,or=Object.prototype.hasOwnProperty,lr=Object.prototype.propertyIsEnumerable,ir=(e,t,r)=>t in e?tr(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,cr=(e,t)=>{for(var r in t||(t={}))or.call(t,r)&&ir(e,r,t[r]);if(ar)for(var r of ar(t))lr.call(t,r)&&ir(e,r,t[r]);return e},sr=(e,t)=>rr(e,nr(t));function ur(e){var t=e,{label:r}=t,n=((e,t)=>{var r={};for(var n in e)or.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&ar)for(var n of ar(e))t.indexOf(n)<0&&lr.call(e,n)&&(r[n]=e[n]);return r})(t,["label"]);const l=(0,i.useStyles2)(dr),[c]=(0,a.useState)((()=>Math.random().toString(16).slice(2))),s={SelectContainer:pr,ValueContainer:yr,SingleValue:yr};return o().createElement("div",{className:l.root},r&&o().createElement("label",{className:l.label,htmlFor:c},r,":"," "),o().createElement(i.Select,sr(cr({openMenuOnFocus:!0,inputId:c},n),{components:s})))}const pr=e=>{const{children:t}=e,r=(0,i.useStyles2)(dr);return o().createElement(i.SelectContainer,sr(cr({},e),{className:(0,n.cx)(e.className,r.container)}),t)},yr=e=>{const{className:t,children:r}=e,a=(0,i.useStyles2)(dr);return o().createElement("div",{className:(0,n.cx)(t,a.valueContainer)},r)},dr=e=>({root:(0,n.css)({display:"flex",fontSize:12,alignItems:"center"}),label:(0,n.css)({color:e.colors.text.secondary,whiteSpace:"nowrap"}),container:(0,n.css)({background:"none",borderColor:"transparent"}),valueContainer:(0,n.css)({display:"flex",alignItems:"center",flex:"initial",color:e.colors.text.secondary,fontSize:12})}),mr=({grow:e,shrink:t})=>o().createElement("div",{style:{display:"block",flexGrow:e,flexShrink:t}});function fr(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const br=e=>{const{query:t,onChange:r,onRunQuery:n}=e,{queryType:a}=t;return o().createElement(Zt,null,o().createElement(ur,{label:"Query type",options:ve,value:a,onChange:({value:e})=>{var a,o;r((a=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){fr(e,t,r[t])}))}return e}({},t),o=null!=(o={queryType:e})?o:{},Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(o)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(o)).forEach((function(e){Object.defineProperty(a,e,Object.getOwnPropertyDescriptor(o,e))})),a)),n()}}),o().createElement(mr,{grow:1}))};function vr(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function gr(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){vr(e,t,r[t])}))}return e}function hr(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function Or(e,t,r,n,a,o,l){try{var i=e[o](l),c=i.value}catch(e){return void r(e)}i.done?t(c):Promise.resolve(c).then(n,a)}function Er(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function l(e){Or(o,n,a,l,i,"next",e)}function i(e){Or(o,n,a,l,i,"throw",e)}l(void 0)}))}}function Sr(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function jr(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){Sr(e,t,r[t])}))}return e}function Tr(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}class Pr extends a.PureComponent{componentDidMount(){var e=this;return Er((function*(){yield e.props.datasource.ensureGCEDefaultProject();const t=e.props.query.projectName||e.props.datasource.getDefaultProject(),n=yield e.props.datasource.getProjects(),a=yield e.props.datasource.getMetricTypes(e.props.query.projectName||e.props.datasource.getDefaultProject()),o=Se(a).map((e=>({value:e.service,label:e.serviceShortName})));let l="";o.some((t=>t.value===(0,r.getTemplateSrv)().replace(e.state.selectedService)))?l=e.state.selectedService:o&&o.length>0&&(l=o[0].value);const{metricTypes:i,selectedMetricType:c}=Te(a,e.state.selectedMetricType,(0,r.getTemplateSrv)().replace(e.state.selectedMetricType),(0,r.getTemplateSrv)().replace(l)),s=yield e.props.datasource.getSLOServices(t),u=Tr(jr({services:o,selectedService:l,metricTypes:i,selectedMetricType:c,metricDescriptors:a,projects:n},yield e.getLabels(c,t)),{sloServices:s,loading:!1,projectName:t});e.setState(u,(()=>e.onPropsChange()))}))()}onQueryTypeChange(e){var t=this;return Er((function*(){const r=jr({selectedQueryType:e},yield t.getLabels(t.state.selectedMetricType,t.state.projectName,e));t.setState(r)}))()}onProjectChange(e){var t=this;return Er((function*(){const n=yield t.props.datasource.getMetricTypes(e),a=yield t.getLabels(t.state.selectedMetricType,e),{metricTypes:o,selectedMetricType:l}=Te(n,t.state.selectedMetricType,(0,r.getTemplateSrv)().replace(t.state.selectedMetricType),(0,r.getTemplateSrv)().replace(t.state.selectedService)),i=yield t.props.datasource.getSLOServices(e);t.setState(Tr(jr({},a),{metricTypes:o,selectedMetricType:l,metricDescriptors:n,projectName:e,sloServices:i}),(()=>t.onPropsChange()))}))()}onServiceChange(e){var t=this;return Er((function*(){const{metricTypes:n,selectedMetricType:a}=Te(t.state.metricDescriptors,t.state.selectedMetricType,(0,r.getTemplateSrv)().replace(t.state.selectedMetricType),(0,r.getTemplateSrv)().replace(e)),o=jr({selectedService:e,metricTypes:n,selectedMetricType:a},yield t.getLabels(a,t.state.projectName));t.setState(o,(()=>t.onPropsChange()))}))()}onMetricTypeChange(e){var t=this;return Er((function*(){const n=jr({selectedMetricType:e},yield t.getLabels((0,r.getTemplateSrv)().replace(e),t.state.projectName));t.setState(n,(()=>t.onPropsChange()))}))()}onLabelKeyChange(e){this.setState({labelKey:e},(()=>this.onPropsChange()))}componentDidUpdate(e,t){const r=t.selectedQueryType!==this.state.selectedQueryType,n=this.state.selectedSLOService!==t.selectedSLOService;(r||n)&&this.onPropsChange()}getLabels(e,t,n=this.state.selectedQueryType){var a=this;return Er((function*(){let o={labels:a.state.labels,labelKey:a.state.labelKey};if(e&&n===z.LabelValues){const n=yield we(a.props.datasource,e,t),l=n.some((e=>e===(0,r.getTemplateSrv)().replace(a.state.labelKey)))?a.state.labelKey:n[0];o={labels:n,labelKey:l}}return o}))()}renderQueryTypeSwitch(e){const t={label:"Template Variables",expanded:!1,options:(0,r.getTemplateSrv)().getVariables().map((e=>({value:`$${e.name}`,label:`$${e.name}`})))};switch(e){case z.MetricTypes:return o().createElement(o().Fragment,null,o().createElement(It,{allowCustomValue:!0,value:this.state.projectName,options:[t,...this.state.projects],onChange:e=>this.onProjectChange(e),label:"Project"}),o().createElement(It,{value:this.state.selectedService,options:[t,...this.state.services],onChange:e=>this.onServiceChange(e),label:"Service"}));case z.LabelKeys:case z.LabelValues:case z.ResourceTypes:return o().createElement(o().Fragment,null,o().createElement(It,{allowCustomValue:!0,value:this.state.projectName,options:[t,...this.state.projects],onChange:e=>this.onProjectChange(e),label:"Project"}),o().createElement(It,{value:this.state.selectedService,options:[t,...this.state.services],onChange:e=>this.onServiceChange(e),label:"Service"}),o().createElement(It,{value:this.state.selectedMetricType,options:[t,...this.state.metricTypes.map((({value:e,name:t})=>({value:e,label:t})))],onChange:e=>this.onMetricTypeChange(e),label:"Metric Type"}),e===z.LabelValues&&o().createElement(It,{value:this.state.labelKey,options:[t,...this.state.labels.map((e=>({value:e,label:e})))],onChange:e=>this.onLabelKeyChange(e),label:"Label Key"}));case z.Aligners:case z.Aggregations:return o().createElement(o().Fragment,null,o().createElement(It,{value:this.state.selectedService,options:[t,...this.state.services],onChange:e=>this.onServiceChange(e),label:"Service"}),o().createElement(It,{value:this.state.selectedMetricType,options:[t,...this.state.metricTypes.map((({value:e,name:t})=>({value:e,label:t})))],onChange:e=>this.onMetricTypeChange(e),label:"Metric Type"}));case z.Services:case z.SLOServices:return o().createElement(o().Fragment,null,o().createElement(It,{allowCustomValue:!0,value:this.state.projectName,options:[t,...this.state.projects],onChange:e=>this.onProjectChange(e),label:"Project"}));case z.SLO:return o().createElement(o().Fragment,null,o().createElement(It,{allowCustomValue:!0,value:this.state.projectName,options:[t,...this.state.projects],onChange:e=>this.onProjectChange(e),label:"Project"}),o().createElement(It,{value:this.state.selectedSLOService,options:[t,...this.state.sloServices],onChange:e=>{this.setState(Tr(jr({},this.state),{selectedSLOService:e}))},label:"SLO Service"}));default:return""}}render(){return this.state.loading?o().createElement(It,{value:"loading",options:[{value:"loading",label:"Loading..."}],onChange:e=>null,label:"Query Type"}):o().createElement(o().Fragment,null,o().createElement(It,{value:this.state.selectedQueryType,options:this.queryTypes,onChange:e=>this.onQueryTypeChange(e),label:"Query Type"}),this.renderQueryTypeSwitch(this.state.selectedQueryType))}constructor(e){super(e),Sr(this,"queryTypes",[{value:z.Projects,label:"Projects"},{value:z.Services,label:"Services"},{value:z.MetricTypes,label:"Metric Types"},{value:z.LabelKeys,label:"Label Keys"},{value:z.LabelValues,label:"Label Values"},{value:z.ResourceTypes,label:"Resource Types"},{value:z.Aggregations,label:"Aggregations"},{value:z.Aligners,label:"Aligners"},{value:z.AlignmentPeriods,label:"Alignment Periods"},{value:z.Selectors,label:"Selectors"},{value:z.SLOServices,label:"SLO Services"},{value:z.SLO,label:"Service Level Objectives (SLO)"}]),Sr(this,"defaults",{selectedQueryType:this.queryTypes[0].value,metricDescriptors:[],selectedService:"",selectedMetricType:"",labels:[],labelKey:"",metricTypes:[],services:[],sloServices:[],selectedSLOService:"",projects:[],projectName:"",loading:!0}),Sr(this,"onPropsChange",(()=>{const e=this.state,{metricDescriptors:t,labels:r,metricTypes:n,services:a}=e,o=function(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}(e,["metricDescriptors","labels","metricTypes","services"]);this.props.onChange(Tr(jr({},o),{refId:"CloudMonitoringVariableQueryEditor-VariableQuery"}))})),this.state=Object.assign(this.defaults,this.props.query)}}var Ir=s(269);function wr(e){return"function"==typeof e}function Nr(e){return function(t){if(function(e){return wr(null==e?void 0:e.lift)}(t))return t.lift((function(t){try{return e(t,this)}catch(e){this.error(e)}}));throw new TypeError("Unable to lift unknown Observable type")}}var Dr=function(e,t){return Dr=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},Dr(e,t)};function Lr(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}Dr(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}function Cr(e,t){var r,n,a,o,l={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function i(i){return function(c){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,i[0]&&(l=0)),l;)try{if(r=1,n&&(a=2&i[0]?n.return:i[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,i[1])).done)return a;switch(n=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return l.label++,{value:i[1],done:!1};case 5:l.label++,n=i[1],i=[0];continue;case 7:i=l.ops.pop(),l.trys.pop();continue;default:if(!((a=(a=l.trys).length>0&&a[a.length-1])||6!==i[0]&&2!==i[0])){l=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){l.label=i[1];break}if(6===i[0]&&l.label<a[1]){l.label=a[1],a=i;break}if(a&&l.label<a[2]){l.label=a[2],l.ops.push(i);break}a[2]&&l.ops.pop(),l.trys.pop();continue}i=t.call(e,l)}catch(e){i=[6,e],n=0}finally{r=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}}function _r(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function Ar(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,a,o=r.call(e),l=[];try{for(;(void 0===t||t-- >0)&&!(n=o.next()).done;)l.push(n.value)}catch(e){a={error:e}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(a)throw a.error}}return l}function xr(e,t,r){if(r||2===arguments.length)for(var n,a=0,o=t.length;a<o;a++)!n&&a in t||(n||(n=Array.prototype.slice.call(t,0,a)),n[a]=t[a]);return e.concat(n||Array.prototype.slice.call(t))}function Rr(e){return this instanceof Rr?(this.v=e,this):new Rr(e)}Object.create,Object.create,"function"==typeof SuppressedError&&SuppressedError;var Ur,Mr=((Ur=function(e){var t;t=this,Error.call(t),t.stack=(new Error).stack,this.message=e?e.length+" errors occurred during unsubscription:\n"+e.map((function(e,t){return t+1+") "+e.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=e}).prototype=Object.create(Error.prototype),Ur.prototype.constructor=Ur,Ur);function kr(e,t){if(e){var r=e.indexOf(t);0<=r&&e.splice(r,1)}}var Gr=function(){function e(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}var t;return e.prototype.unsubscribe=function(){var e,t,r,n,a;if(!this.closed){this.closed=!0;var o=this._parentage;if(o)if(this._parentage=null,Array.isArray(o))try{for(var l=_r(o),i=l.next();!i.done;i=l.next())i.value.remove(this)}catch(t){e={error:t}}finally{try{i&&!i.done&&(t=l.return)&&t.call(l)}finally{if(e)throw e.error}}else o.remove(this);var c=this.initialTeardown;if(wr(c))try{c()}catch(e){a=e instanceof Mr?e.errors:[e]}var s=this._finalizers;if(s){this._finalizers=null;try{for(var u=_r(s),p=u.next();!p.done;p=u.next()){var y=p.value;try{Br(y)}catch(e){a=null!=a?a:[],e instanceof Mr?a=xr(xr([],Ar(a)),Ar(e.errors)):a.push(e)}}}catch(e){r={error:e}}finally{try{p&&!p.done&&(n=u.return)&&n.call(u)}finally{if(r)throw r.error}}}if(a)throw new Mr(a)}},e.prototype.add=function(t){var r;if(t&&t!==this)if(this.closed)Br(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=null!==(r=this._finalizers)&&void 0!==r?r:[]).push(t)}},e.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},e.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},e.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&kr(t,e)},e.prototype.remove=function(t){var r=this._finalizers;r&&kr(r,t),t instanceof e&&t._removeParent(this)},e.EMPTY=((t=new e).closed=!0,t),e}();function Qr(e){return e instanceof Gr||e&&"closed"in e&&wr(e.remove)&&wr(e.add)&&wr(e.unsubscribe)}function Br(e){wr(e)?e():e.unsubscribe()}Gr.EMPTY;var qr={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},Fr={setTimeout:function(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];var a=Fr.delegate;return(null==a?void 0:a.setTimeout)?a.setTimeout.apply(a,xr([e,t],Ar(r))):setTimeout.apply(void 0,xr([e,t],Ar(r)))},clearTimeout:function(e){var t=Fr.delegate;return((null==t?void 0:t.clearTimeout)||clearTimeout)(e)},delegate:void 0};function Vr(e){Fr.setTimeout((function(){var t=qr.onUnhandledError;if(!t)throw e;t(e)}))}function Kr(){}var $r=Yr("C",void 0,void 0);function Yr(e,t,r){return{kind:e,value:t,error:r}}var Jr=null,Wr=function(e){function t(t){var r=e.call(this)||this;return r.isStopped=!1,t?(r.destination=t,Qr(t)&&t.add(r)):r.destination=rn,r}return Lr(t,e),t.create=function(e,t,r){return new Zr(e,t,r)},t.prototype.next=function(e){this.isStopped?tn(function(e){return Yr("N",e,void 0)}(e),this):this._next(e)},t.prototype.error=function(e){this.isStopped?tn(Yr("E",void 0,e),this):(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped?tn($r,this):(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){try{this.destination.error(e)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(Gr),zr=Function.prototype.bind;function Hr(e,t){return zr.call(e,t)}var Xr=function(){function e(e){this.partialObserver=e}return e.prototype.next=function(e){var t=this.partialObserver;if(t.next)try{t.next(e)}catch(e){en(e)}},e.prototype.error=function(e){var t=this.partialObserver;if(t.error)try{t.error(e)}catch(e){en(e)}else en(e)},e.prototype.complete=function(){var e=this.partialObserver;if(e.complete)try{e.complete()}catch(e){en(e)}},e}(),Zr=function(e){function t(t,r,n){var a,o,l=e.call(this)||this;return wr(t)||!t?a={next:null!=t?t:void 0,error:null!=r?r:void 0,complete:null!=n?n:void 0}:l&&qr.useDeprecatedNextContext?((o=Object.create(t)).unsubscribe=function(){return l.unsubscribe()},a={next:t.next&&Hr(t.next,o),error:t.error&&Hr(t.error,o),complete:t.complete&&Hr(t.complete,o)}):a=t,l.destination=new Xr(a),l}return Lr(t,e),t}(Wr);function en(e){var t;qr.useDeprecatedSynchronousErrorHandling?(t=e,qr.useDeprecatedSynchronousErrorHandling&&Jr&&(Jr.errorThrown=!0,Jr.error=t)):Vr(e)}function tn(e,t){var r=qr.onStoppedNotification;r&&Fr.setTimeout((function(){return r(e,t)}))}var rn={closed:!0,next:Kr,error:function(e){throw e},complete:Kr};function nn(e,t,r,n,a){return new an(e,t,r,n,a)}var an=function(e){function t(t,r,n,a,o,l){var i=e.call(this,t)||this;return i.onFinalize=o,i.shouldUnsubscribe=l,i._next=r?function(e){try{r(e)}catch(e){t.error(e)}}:e.prototype._next,i._error=a?function(e){try{a(e)}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._error,i._complete=n?function(){try{n()}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._complete,i}return Lr(t,e),t.prototype.unsubscribe=function(){var t;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var r=this.closed;e.prototype.unsubscribe.call(this),!r&&(null===(t=this.onFinalize)||void 0===t||t.call(this))}},t}(Wr);function on(e,t){return Nr((function(r,n){var a=0;r.subscribe(nn(n,(function(r){n.next(e.call(t,r,a++))})))}))}var ln=function(e){return e&&"number"==typeof e.length&&"function"!=typeof e},cn="function"==typeof Symbol&&Symbol.observable||"@@observable";function sn(e){return e}var un=function(){function e(e){e&&(this._subscribe=e)}return e.prototype.lift=function(t){var r=new e;return r.source=this,r.operator=t,r},e.prototype.subscribe=function(e,t,r){var n,a=this,o=(n=e)&&n instanceof Wr||function(e){return e&&wr(e.next)&&wr(e.error)&&wr(e.complete)}(n)&&Qr(n)?e:new Zr(e,t,r);return function(e){if(qr.useDeprecatedSynchronousErrorHandling){var t=!Jr;if(t&&(Jr={errorThrown:!1,error:null}),e(),t){var r=Jr,n=r.errorThrown,a=r.error;if(Jr=null,n)throw a}}else e()}((function(){var e=a,t=e.operator,r=e.source;o.add(t?t.call(o,r):r?a._subscribe(o):a._trySubscribe(o))})),o},e.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){e.error(t)}},e.prototype.forEach=function(e,t){var r=this;return new(t=pn(t))((function(t,n){var a=new Zr({next:function(t){try{e(t)}catch(e){n(e),a.unsubscribe()}},error:n,complete:t});r.subscribe(a)}))},e.prototype._subscribe=function(e){var t;return null===(t=this.source)||void 0===t?void 0:t.subscribe(e)},e.prototype[cn]=function(){return this},e.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return(0===(r=e).length?sn:1===r.length?r[0]:function(e){return r.reduce((function(e,t){return t(e)}),e)})(this);var r},e.prototype.toPromise=function(e){var t=this;return new(e=pn(e))((function(e,r){var n;t.subscribe((function(e){return n=e}),(function(e){return r(e)}),(function(){return e(n)}))}))},e.create=function(t){return new e(t)},e}();function pn(e){var t;return null!==(t=null!=e?e:qr.Promise)&&void 0!==t?t:Promise}var yn="function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator";function dn(e){if(e instanceof un)return e;if(null!=e){if(function(e){return wr(e[cn])}(e))return o=e,new un((function(e){var t=o[cn]();if(wr(t.subscribe))return t.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")}));if(ln(e))return a=e,new un((function(e){for(var t=0;t<a.length&&!e.closed;t++)e.next(a[t]);e.complete()}));if(wr(null==(n=e)?void 0:n.then))return r=e,new un((function(e){r.then((function(t){e.closed||(e.next(t),e.complete())}),(function(t){return e.error(t)})).then(null,Vr)}));if(function(e){return Symbol.asyncIterator&&wr(null==e?void 0:e[Symbol.asyncIterator])}(e))return mn(e);if(function(e){return wr(null==e?void 0:e[yn])}(e))return t=e,new un((function(e){var r,n;try{for(var a=_r(t),o=a.next();!o.done;o=a.next()){var l=o.value;if(e.next(l),e.closed)return}}catch(e){r={error:e}}finally{try{o&&!o.done&&(n=a.return)&&n.call(a)}finally{if(r)throw r.error}}e.complete()}));if(function(e){return wr(null==e?void 0:e.getReader)}(e))return mn(function(e){return function(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n,a=r.apply(e,t||[]),o=[];return n={},l("next"),l("throw"),l("return"),n[Symbol.asyncIterator]=function(){return this},n;function l(e){a[e]&&(n[e]=function(t){return new Promise((function(r,n){o.push([e,t,r,n])>1||i(e,t)}))})}function i(e,t){try{(r=a[e](t)).value instanceof Rr?Promise.resolve(r.value.v).then(c,s):u(o[0][2],r)}catch(e){u(o[0][3],e)}var r}function c(e){i("next",e)}function s(e){i("throw",e)}function u(e,t){e(t),o.shift(),o.length&&i(o[0][0],o[0][1])}}(this,arguments,(function(){var t,r,n;return Cr(this,(function(a){switch(a.label){case 0:t=e.getReader(),a.label=1;case 1:a.trys.push([1,,9,10]),a.label=2;case 2:return[4,Rr(t.read())];case 3:return r=a.sent(),n=r.value,r.done?[4,Rr(void 0)]:[3,5];case 4:return[2,a.sent()];case 5:return[4,Rr(n)];case 6:return[4,a.sent()];case 7:return a.sent(),[3,2];case 8:return[3,10];case 9:return t.releaseLock(),[7];case 10:return[2]}}))}))}(e))}var t,r,n,a,o;throw function(e){return new TypeError("You provided "+(null!==e&&"object"==typeof e?"an invalid object":"'"+e+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}(e)}function mn(e){return new un((function(t){(function(e,t){var r,n,a,o,l,i,c,s;return l=this,i=void 0,s=function(){var l,i;return Cr(this,(function(c){switch(c.label){case 0:c.trys.push([0,5,6,11]),r=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,r=e[Symbol.asyncIterator];return r?r.call(e):(e=_r(e),t={},n("next"),n("throw"),n("return"),t[Symbol.asyncIterator]=function(){return this},t);function n(r){t[r]=e[r]&&function(t){return new Promise((function(n,a){!function(e,t,r,n){Promise.resolve(n).then((function(t){e({value:t,done:r})}),t)}(n,a,(t=e[r](t)).done,t.value)}))}}}(e),c.label=1;case 1:return[4,r.next()];case 2:if((n=c.sent()).done)return[3,4];if(l=n.value,t.next(l),t.closed)return[2];c.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return i=c.sent(),a={error:i},[3,11];case 6:return c.trys.push([6,,9,10]),n&&!n.done&&(o=r.return)?[4,o.call(r)]:[3,8];case 7:c.sent(),c.label=8;case 8:return[3,10];case 9:if(a)throw a.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}}))},new((c=void 0)||(c=Promise))((function(e,t){function r(e){try{a(s.next(e))}catch(e){t(e)}}function n(e){try{a(s.throw(e))}catch(e){t(e)}}function a(t){var a;t.done?e(t.value):(a=t.value,a instanceof c?a:new c((function(e){e(a)}))).then(r,n)}a((s=s.apply(l,i||[])).next())}))})(e,t).catch((function(e){return t.error(e)}))}))}function fn(e,t,r){return void 0===r&&(r=1/0),wr(t)?fn((function(r,n){return on((function(e,a){return t(r,e,n,a)}))(dn(e(r,n)))}),r):("number"==typeof t&&(r=t),Nr((function(t,n){return function(e,t,r,n,a,o,l,i){var c=[],s=0,u=0,p=!1,y=function(){!p||c.length||s||t.complete()},d=function(e){return s<n?m(e):c.push(e)},m=function(e){s++;var a=!1;dn(r(e,u++)).subscribe(nn(t,(function(e){t.next(e)}),(function(){a=!0}),void 0,(function(){if(a)try{s--;for(var e=function(){var e=c.shift();m(e)};c.length&&s<n;)e();y()}catch(e){t.error(e)}})))};return e.subscribe(nn(t,d,(function(){p=!0,y()}))),function(){}}(t,n,e,r)})))}function bn(e,t,r){void 0===t&&(t=0),void 0===r&&(r=[]);var n=function(e,t){void 0===t&&(t=0);var r=(0,a.useRef)(!1),n=(0,a.useRef)(),o=(0,a.useRef)(e),l=(0,a.useCallback)((function(){return r.current}),[]),i=(0,a.useCallback)((function(){r.current=!1,n.current&&clearTimeout(n.current),n.current=setTimeout((function(){r.current=!0,o.current()}),t)}),[t]),c=(0,a.useCallback)((function(){r.current=null,n.current&&clearTimeout(n.current)}),[]);return(0,a.useEffect)((function(){o.current=e}),[e]),(0,a.useEffect)((function(){return i(),c}),[t]),[l,c,i]}(e,t),o=n[0],l=n[1],i=n[2];return(0,a.useEffect)(i,r),[o,l]}function vn(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function gn(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){vn(e,t,r[t])}))}return e}function hn(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const On=e=>{const{datasource:r,query:n,onRunQuery:l,data:c,onChange:s,range:u}=e,p=(null==c?void 0:c.series.length)?null==c?void 0:c.series[0].meta:{};var y;const d=null!==(y=null==p?void 0:p.custom)&&void 0!==y?y:{},m=gn({},(e=>hn(gn({},Kt(e)),{title:"",text:""}))(r),n.timeSeriesList),[f,b]=(0,a.useState)(m.title||""),[v,g]=(0,a.useState)(m.text||""),h={label:"Template Variables",options:r.getVariables().map(t.toOption)};return bn((()=>{s(hn(gn({},n),{timeSeriesList:hn(gn({},m),{title:f})}))}),1e3,[f,s]),bn((()=>{s(hn(gn({},n),{timeSeriesList:hn(gn({},m),{text:v})}))}),1e3,[v,s]),(0,a.useEffect)((()=>{n.queryType&&Object.values(K).includes(n.queryType)||s(hn(gn({},n),{queryType:K.TIME_SERIES_LIST}))})),o().createElement(V,null,o().createElement(o().Fragment,null,o().createElement(Jt,{refId:n.refId,variableOptionGroup:h,customMetaData:d,onChange:s,onRunQuery:l,datasource:r,query:n,range:u||(0,t.getDefaultTimeRange)()}),o().createElement(ae,{label:"Title",htmlFor:"annotation-query-title"},o().createElement(i.Input,{id:"annotation-query-title",value:f,onChange:e=>{b(e.target.value)}})),o().createElement(ae,{label:"Text",htmlFor:"annotation-query-text"},o().createElement(i.Input,{id:"annotation-query-text",value:v,onChange:e=>{g(e.target.value)}}))),o().createElement(pt,null))};function En(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const Sn=e=>({prepareAnnotation:t=>{if(!(e=>{var t,r;return void 0!==(null===(t=e.target)||void 0===t?void 0:t.title)||void 0!==(null===(r=e.target)||void 0===r?void 0:r.text)})(t))return t;const{enable:r,name:n,iconColor:a}=t,{target:o}=t;return{datasource:t.datasource,enable:r,name:n,iconColor:a,target:{intervalMs:e.intervalMs,refId:(null==o?void 0:o.refId)||"annotationQuery",queryType:K.ANNOTATION,timeSeriesList:{projectName:(null==o?void 0:o.projectName)||e.getDefaultProject(),filters:(null==o?void 0:o.filters)||[],crossSeriesReducer:"REDUCE_NONE",perSeriesAligner:W.ALIGN_NONE,title:(null==o?void 0:o.title)||"",text:(null==o?void 0:o.text)||""}}}},prepareQuery:e=>{if(e.target)return t=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){En(e,t,r[t])}))}return e}({},e.target),r=null!=(r={queryType:K.ANNOTATION,type:"annotationQuery"})?r:{},Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})),t;var t,r},QueryEditor:On});function jn(e,t,r,n,a,o,l){try{var i=e[o](l),c=i.value}catch(e){return void r(e)}i.done?t(c):Promise.resolve(c).then(n,a)}function Tn(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function l(e){jn(o,n,a,l,i,"next",e)}function i(e){jn(o,n,a,l,i,"throw",e)}l(void 0)}))}}function Pn(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class In{execute(e){var t=this;return Tn((function*(){try{switch(e.projectName||(e.projectName=t.datasource.getDefaultProject()),e.selectedQueryType){case z.Projects:return t.handleProjectsQuery();case z.Services:return t.handleServiceQuery(e);case z.MetricTypes:return t.handleMetricTypesQuery(e);case z.LabelKeys:return t.handleLabelKeysQuery(e);case z.LabelValues:return t.handleLabelValuesQuery(e);case z.ResourceTypes:return t.handleResourceTypeQuery(e);case z.Aligners:return t.handleAlignersQuery(e);case z.AlignmentPeriods:return t.handleAlignmentPeriodQuery();case z.Aggregations:return t.handleAggregationQuery(e);case z.SLOServices:return t.handleSLOServicesQuery(e);case z.SLO:return t.handleSLOQuery(e);case z.Selectors:return t.handleSelectorQuery();default:return[]}}catch(t){return console.error(`Could not run CloudMonitoringMetricFindQuery ${e}`,t),[]}}))()}handleProjectsQuery(){var e=this;return Tn((function*(){return(yield e.datasource.getProjects()).map((e=>({text:e.label,value:e.value,expandable:!0})))}))()}handleServiceQuery({projectName:e}){var t=this;return Tn((function*(){const r=yield t.datasource.getMetricTypes(e);return Se(r).map((e=>({text:e.serviceShortName,value:e.service,expandable:!0})))}))()}handleMetricTypesQuery({selectedService:e,projectName:t}){var r=this;return Tn((function*(){if(!e)return[];const n=yield r.datasource.getMetricTypes(t);return je(n,r.datasource.templateSrv.replace(e)).map((e=>({text:e.displayName,value:e.type,expandable:!0})))}))()}handleLabelKeysQuery({selectedMetricType:e,projectName:t}){var r=this;return Tn((function*(){return e?(yield we(r.datasource,e,t)).map(r.toFindQueryResult):[]}))()}handleLabelValuesQuery({selectedMetricType:e,labelKey:t,projectName:r}){var n=this;return Tn((function*(){if(!e)return[];const a=yield n.datasource.getLabels(e,"handleLabelValuesQuery",r,{groupBys:[t],crossSeriesReducer:"REDUCE_MEAN"}),o=n.datasource.templateSrv.replace(t);return(a.hasOwnProperty(o)?a[o]:[]).map(n.toFindQueryResult)}))()}handleResourceTypeQuery({selectedMetricType:e,projectName:t}){var r=this;return Tn((function*(){var n,a;return e&&null!==(a=null===(n=(yield r.datasource.getLabels(e,"handleResourceTypeQueryQueryType",t))["resource.type"])||void 0===n?void 0:n.map(r.toFindQueryResult))&&void 0!==a?a:[]}))()}handleAlignersQuery({selectedMetricType:e,projectName:t}){var r=this;return Tn((function*(){if(!e)return[];const n=(yield r.datasource.getMetricTypes(t)).find((t=>t.type===r.datasource.templateSrv.replace(e)));return n?Pe(n.valueType,n.metricKind).map(r.toFindQueryResult):[]}))()}handleAggregationQuery({selectedMetricType:e,projectName:t}){var r=this;return Tn((function*(){if(!e)return[];const n=(yield r.datasource.getMetricTypes(t)).find((t=>t.type===r.datasource.templateSrv.replace(e)));return n?Ie(n.valueType,n.metricKind).map(r.toFindQueryResult):[]}))()}handleSLOServicesQuery({projectName:e}){var t=this;return Tn((function*(){return(yield t.datasource.getSLOServices(e)).map(t.toFindQueryResult)}))()}handleSLOQuery({selectedSLOService:e,projectName:t}){var r=this;return Tn((function*(){return(yield r.datasource.getServiceLevelObjectives(t,e)).map(r.toFindQueryResult)}))()}handleSelectorQuery(){var e=this;return Tn((function*(){return be.map(e.toFindQueryResult)}))()}handleAlignmentPeriodQuery(){return pe.map(this.toFindQueryResult)}toFindQueryResult(t){return(0,e.isString)(t)?{text:t,expandable:!0}:(r=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){Pn(e,t,r[t])}))}return e}({},t),n=null!=(n={expandable:!0})?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(n)).forEach((function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(n,e))})),r);var r,n}constructor(e){Pn(this,"datasource",void 0),this.datasource=e}}function wn(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class Nn extends t.CustomVariableSupport{query(e){const t=(0,Ir.from)(this.metricFindQuery.execute(e.targets[0]));return(0,Ir.from)(this.datasource.ensureGCEDefaultProject()).pipe(fn((()=>t)),on((e=>({data:e}))))}constructor(e){super(),wn(this,"datasource",void 0),wn(this,"metricFindQuery",void 0),wn(this,"editor",void 0),this.datasource=e,this.editor=Pr,this.metricFindQuery=new In(e)}}function Dn(e,t,r,n,a,o,l){try{var i=e[o](l),c=i.value}catch(e){return void r(e)}i.done?t(c):Promise.resolve(c).then(n,a)}function Ln(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function l(e){Dn(o,n,a,l,i,"next",e)}function i(e){Dn(o,n,a,l,i,"throw",e)}l(void 0)}))}}function Cn(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _n(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){Cn(e,t,r[t])}))}return e}function An(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}class xn extends r.DataSourceWithBackend{getVariables(){return this.templateSrv.getVariables().map((e=>`$${e.name}`))}query(e){return e.targets=e.targets.map((t=>An(_n({},this.migrateQuery(t)),{intervalMs:e.intervalMs}))),super.query(e)}applyTemplateVariables(e,t){const{timeSeriesList:r,timeSeriesQuery:n,sloQuery:a,promQLQuery:o}=e;return An(_n({},e),{datasource:this.getRef(),intervalMs:this.intervalMs,timeSeriesList:r&&An(_n({},this.interpolateProps(r,t)),{projectName:this.templateSrv.replace(r.projectName?r.projectName:this.getDefaultProject(),t),filters:this.interpolateFilters(r.filters||[],t),groupBys:this.interpolateGroupBys(r.groupBys||[],t),view:r.view||"FULL"}),timeSeriesQuery:n&&An(_n({},this.interpolateProps(n,t)),{projectName:this.templateSrv.replace(n.projectName?n.projectName:this.getDefaultProject(),t)}),sloQuery:a&&this.interpolateProps(a,t),promQLQuery:o&&this.interpolateProps(o,t,{expr:this.interpolatePromQLQuery})})}getLabels(e,n,a,o,l){var i=this;return Ln((function*(){var c;const s={targets:[{refId:n,datasource:i.getRef(),queryType:K.TIME_SERIES_LIST,timeSeriesList:xe({projectName:i.templateSrv.replace(a),groupBys:i.interpolateGroupBys((null==o?void 0:o.groupBys)||[],{}),crossSeriesReducer:null!==(c=null==o?void 0:o.crossSeriesReducer)&&void 0!==c?c:"REDUCE_NONE",view:"HEADERS"},i.templateSrv.replace(e))}],range:l||(0,t.getDefaultTimeRange)()},u=s.targets;return u.length?(0,Ir.lastValueFrom)((0,Ir.from)(i.ensureGCEDefaultProject()).pipe(fn((()=>i.backendSrv.fetch({url:"/api/ds/query",method:"POST",headers:i.getRequestHeaders(),data:{from:s.range.from.valueOf().toString(),to:s.range.to.valueOf().toString(),queries:u}}))),on((({data:e})=>{const t=(0,r.toDataQueryResponse)({data:e}),n=null==t?void 0:t.data.map((e=>{var t,r;return null===(r=e.meta)||void 0===r||null===(t=r.custom)||void 0===t?void 0:t.labels})).filter((e=>!!e)).reduce(((e,t)=>{for(let r in t)e[r]||(e[r]=new Set),t[r]&&e[r].add(t[r]);return e}),{});return Object.fromEntries(Object.entries(n).map((([e,t])=>[e,Array.from(t)])))})))):(0,Ir.lastValueFrom)((0,Ir.of)({results:[]}))}))()}getGCEDefaultProject(){var e=this;return Ln((function*(){return e.getResource("gceDefaultProject")}))()}getDefaultProject(){const{defaultProject:e,authenticationType:t,gceDefaultProject:r}=this.instanceSettings.jsonData;return"gce"===t?r||"":e||""}ensureGCEDefaultProject(){var e=this;return Ln((function*(){const{authenticationType:t,gceDefaultProject:r}=e.instanceSettings.jsonData;"gce"!==t||r||(e.instanceSettings.jsonData.gceDefaultProject=yield e.getGCEDefaultProject())}))()}getMetricTypes(e){var t=this;return Ln((function*(){return e?t.getResource(`metricDescriptors/v3/projects/${t.templateSrv.replace(e)}/metricDescriptors`):[]}))()}filterMetricsByType(e,t){var r=this;return Ln((function*(){return e?r.getResource(`metricDescriptors/v3/projects/${r.templateSrv.replace(e)}/metricDescriptors`,{filter:`metric.type : "${t}"`}):[]}))()}getSLOServices(e){var t=this;return Ln((function*(){return t.getResource(`services/v3/projects/${t.templateSrv.replace(e)}/services?pageSize=1000`)}))()}getServiceLevelObjectives(e,t){var r=this;return Ln((function*(){if(!t)return Promise.resolve([]);let{projectName:n,serviceId:a}=r.interpolateProps({projectName:e,serviceId:t});return r.getResource(`slo-services/v3/projects/${n}/services/${a}/serviceLevelObjectives`)}))()}getProjects(){return this.getResource("projects")}migrateMetricTypeFilter(e,t){const r=["metric.type","=",e];return(null==t?void 0:t.length)?t.concat("AND",r):r}migrateQuery(t){const{hide:r,refId:n,datasource:a,key:o,queryType:l,maxLines:i,metric:c,intervalMs:s,type:u}=t,p=function(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}(t,["hide","refId","datasource","key","queryType","maxLines","metric","intervalMs","type"]);if(!(t.hasOwnProperty("metricQuery")||t.hasOwnProperty("sloQuery")||t.hasOwnProperty("timeSeriesQuery")||t.hasOwnProperty("timeSeriesList")))return{datasource:a,key:o,refId:n,intervalMs:s,hide:r,queryType:"annotationQuery"===u?K.ANNOTATION:K.TIME_SERIES_LIST,timeSeriesList:An(_n({},p),{view:p.view||"FULL"})};var y;if((0,e.has)(t,"metricQuery")&&["metrics",K.ANNOTATION].includes(null!==(y=t.queryType)&&void 0!==y?y:"")){const r=(0,e.get)(t,"metricQuery");"mql"===r.editorMode?(t.timeSeriesQuery={projectName:r.projectName,query:r.query,graphPeriod:r.graphPeriod},t.queryType=K.TIME_SERIES_QUERY):(t.timeSeriesList={projectName:r.projectName,crossSeriesReducer:r.crossSeriesReducer,alignmentPeriod:r.alignmentPeriod,perSeriesAligner:r.perSeriesAligner,groupBys:r.groupBys,filters:r.filters,view:r.view,preprocessor:r.preprocessor},t.queryType=K.TIME_SERIES_LIST,r.metricType&&(t.timeSeriesList.filters=this.migrateMetricTypeFilter(r.metricType,t.timeSeriesList.filters))),t.aliasBy=r.aliasBy,t=(0,e.omit)(t,"metricQuery")}return t.queryType===K.SLO&&(0,e.has)(t,"sloQuery.aliasBy")&&(t.aliasBy=(0,e.get)(t,"sloQuery.aliasBy"),t=(0,e.omit)(t,"sloQuery.aliasBy")),t}interpolatePromQLQuery(t,r){return(0,e.isArray)(t)?t.join("|"):t}interpolateProps(t,r={},n){return Object.entries(t).reduce(((t,[a,o])=>{let l=o;return o&&(0,e.isString)(o)&&(l=this.templateSrv.replace(o,r,n&&n[a])),An(_n({},t),{[a]:l})}),{})}filterQuery(e){if(e.hide)return!1;const t=this.migrateQuery(e);if(t.queryType===K.SLO){if(!t.sloQuery)return!1;const{selectorName:e,serviceId:r,sloId:n,projectName:a,lookbackPeriod:o}=t.sloQuery;return!(!e||!r||!n||!a||e===fe&&!o)}return t.queryType===K.TIME_SERIES_QUERY?!!t.timeSeriesQuery&&!!t.timeSeriesQuery.projectName&&!!t.timeSeriesQuery.query:t.queryType&&[K.TIME_SERIES_LIST,K.ANNOTATION].includes(t.queryType)?!!t.timeSeriesList&&!!t.timeSeriesList.projectName&&!!Ae(t.timeSeriesList):t.queryType===K.PROMQL&&!!(t.promQLQuery&&t.promQLQuery.projectName&&t.promQLQuery.expr&&t.promQLQuery.step)}interpolateVariablesInQueries(e,t){return e.map((e=>this.applyTemplateVariables(this.migrateQuery(e),t)))}interpolateFilters(t,r){const n=(0,e.chunk)(t,4).map((([e,t,r,n])=>_n({key:e,operator:t,value:r},n&&{condition:n}))).filter((e=>e.value));return(0,e.flatten)(n.map((({key:t,operator:n,value:a,condition:o})=>[this.templateSrv.replace(t,r||{}),n,this.templateSrv.replace(a,r||{},(t=>(0,e.isArray)(t)&&t.length?`(${t.join("|")})`:t)),...o?[o]:[]])))||[]}interpolateGroupBys(e,t){let r=[];return(e||[]).forEach((e=>{const n=this.templateSrv.replace(e,t||{},"csv").split(",");Array.isArray(n)?r=r.concat(n):r.push(n)})),r}constructor(e,t=(0,r.getTemplateSrv)()){super(e),Cn(this,"instanceSettings",void 0),Cn(this,"templateSrv",void 0),Cn(this,"authenticationType",void 0),Cn(this,"intervalMs",void 0),Cn(this,"backendSrv",void 0),this.instanceSettings=e,this.templateSrv=t,this.authenticationType=e.jsonData.authenticationType||"jwt",this.variables=new Nn(this),this.intervalMs=0,this.annotations=Sn(this),this.backendSrv=(0,r.getBackendSrv)()}}const Rn=new t.DataSourcePlugin(xn).setQueryEditorHelp(l).setQueryEditor((r=>{var n,l;const{datasource:c,query:s,onRunQuery:u,onChange:p,range:y}=r,[d,m]=(0,a.useState)(!1),[f,b]=(0,a.useState)(!1),v=(0,a.useMemo)((()=>{if(!f){b(!0);const e=c.migrateQuery(s);return p(gr({},e)),e}return s}),[s,c,p,f]),[g,h]=(0,a.useState)(v),[O,E]=(0,a.useState)(!1),S=gr({},{projectName:c.getDefaultProject(),alignmentPeriod:"cloud-monitoring-auto",perSeriesAligner:W.ALIGN_MEAN,aliasBy:"",selectorName:"select_slo_health",serviceId:"",serviceName:"",sloId:"",sloName:"",lookbackPeriod:""},v.sloQuery),j=gr({},{projectName:c.getDefaultProject(),expr:"",step:"10s"},v.promQLQuery),T=(null===(n=r.data)||void 0===n?void 0:n.series.length)?null===(l=r.data)||void 0===l?void 0:l.series[0].meta:{};var P;const I=null!==(P=null==T?void 0:T.custom)&&void 0!==P?P:{},w={label:"Template Variables",expanded:!1,options:c.getVariables().map(t.toOption)};(0,a.useEffect)((()=>{v.queryType&&Object.values(K).includes(v.queryType)||p(hr(gr({},v),{queryType:K.TIME_SERIES_LIST}))}));const N=v.queryType;return o().createElement(V,null,o().createElement(i.ConfirmModal,{"data-testid":"switch-query-type-modal",title:"Warning",body:"By switching your query type, your current query will be lost.",isOpen:d,onConfirm:()=>{m(!1),p(g),E(!1)},confirmText:"Confirm",onDismiss:()=>{m(!1),h(v)}}),o().createElement(br,{query:v,onChange:e=>{!O||g.queryType!==K.TIME_SERIES_LIST&&g.queryType!==K.TIME_SERIES_QUERY?p(e):g.queryType!==e.queryType&&m(!0),h(e)},onRunQuery:u}),N===K.PROMQL&&o().createElement(Xt,{refId:v.refId,variableOptionGroup:w,onChange:e=>{p(hr(gr({},v),{promQLQuery:e}))},onRunQuery:u,datasource:c,query:j}),N!==K.SLO&&o().createElement(Jt,{refId:v.refId,variableOptionGroup:w,customMetaData:I,onChange:t=>{(t.queryType===K.TIME_SERIES_LIST&&!(0,e.isEqual)(t.timeSeriesList,Kt(c))||t.queryType===K.TIME_SERIES_QUERY&&!(0,e.isEqual)(t.timeSeriesQuery,$t(c)))&&E(!0),p(t)},onRunQuery:u,datasource:c,query:v,range:y||(0,t.getDefaultTimeRange)()}),N===K.SLO&&o().createElement(Tt,{refId:v.refId,variableOptionGroup:w,customMetaData:I,onChange:e=>{p(hr(gr({},v),{sloQuery:e})),u()},onRunQuery:u,datasource:c,query:S,aliasBy:v.aliasBy,onChangeAliasBy:e=>p(hr(gr({},v),{aliasBy:e}))}))})).setConfigEditor(k).setVariableQueryEditor(Pr);(0,r.getAppEvents)().subscribe(t.DashboardLoadedEvent,(({payload:{dashboardId:t,orgId:n,grafanaVersion:a,queries:o}})=>{const l=o.stackdriver;let i={[K.TIME_SERIES_QUERY]:0,[K.TIME_SERIES_LIST]:0,[K.SLO]:0,[K.ANNOTATION]:0,[K.PROMQL]:0};var c;l.forEach((t=>{t.queryType===K.TIME_SERIES_QUERY||t.queryType===K.TIME_SERIES_LIST||t.queryType===K.SLO||t.queryType===K.ANNOTATION||t.queryType===K.PROMQL?i[t.queryType]++:"metrics"===t.queryType&&(t.hasOwnProperty("type")&&"annotationQuery"===(0,e.get)(t,"type")&&i.annotation++,"mql"===(0,e.get)(t,"metricQuery.editorMode")?i.timeSeriesQuery++:i.timeSeriesList++)})),l&&l.length>0&&(c={grafana_version:a,dashboard_id:t,org_id:n,mql_queries:i[K.TIME_SERIES_QUERY],time_series_filter_queries:i[K.TIME_SERIES_LIST],slo_queries:i[K.SLO],annotation_queries:i[K.ANNOTATION],promQL_queries:i[K.PROMQL]},(0,r.reportInteraction)("grafana_ds_cloudmonitoring_dashboard_loaded",c))}))})(),u})()));
//# sourceMappingURL=module.js.map