define(["@grafana/data","@emotion/css","react","@grafana/runtime","@grafana/ui","lodash","rxjs"],((e,t,r,n,a,o,i)=>(()=>{"use strict";var s={89:e=>{e.exports=t},781:t=>{t.exports=e},531:e=>{e.exports=n},7:e=>{e.exports=a},241:e=>{e.exports=o},959:e=>{e.exports=r},269:e=>{e.exports=i}},l={};function c(e){var t=l[e];if(void 0!==t)return t.exports;var r=l[e]={exports:{}};return s[e](r,r.exports,c),r.exports}c.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return c.d(t,{a:t}),t},c.d=(e,t)=>{for(var r in t)c.o(t,r)&&!c.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},c.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),c.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var u={};return(()=>{c.r(u),c.d(u,{plugin:()=>_t});var e=c(781),t=c(89),r=c(959),n=c.n(r),a=c(7),o=Object.defineProperty,i=Object.defineProperties,s=Object.getOwnPropertyDescriptors,l=Object.getOwnPropertySymbols,p=Object.prototype.hasOwnProperty,d=Object.prototype.propertyIsEnumerable,f=(e,t,r)=>t in e?o(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,m=(e,t)=>{for(var r in t||(t={}))p.call(t,r)&&f(e,r,t[r]);if(l)for(var r of l(t))d.call(t,r)&&f(e,r,t[r]);return e};const y=({dataSourceName:e,docsLink:r,hasRequiredFields:o=!0,className:l})=>{const c=(0,a.useTheme2)(),u={container:(0,t.css)({p:{margin:0},"p + p":{marginTop:c.spacing(2)}}),text:(0,t.css)((p=m({},c.typography.body),d={color:c.colors.text.secondary,a:(0,t.css)({color:c.colors.text.link,textDecoration:"underline","&:hover":{textDecoration:"none"}})},i(p,s(d))))};var p,d;return n().createElement("div",{className:(0,t.cx)(u.container,l)},n().createElement("p",{className:u.text},"Before you can use the ",e," data source, you must configure it below or in the config file. For detailed instructions,"," ",n().createElement("a",{href:r,target:"_blank",rel:"noreferrer"},"view the documentation"),"."),o&&n().createElement("p",{className:u.text},n().createElement("i",null,"Fields marked with * are required")))};var h=Object.defineProperty,v=Object.defineProperties,g=Object.getOwnPropertyDescriptors,b=Object.getOwnPropertySymbols,O=Object.prototype.hasOwnProperty,w=Object.prototype.propertyIsEnumerable,E=(e,t,r)=>t in e?h(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,j=(e,t)=>{for(var r in t||(t={}))O.call(t,r)&&E(e,r,t[r]);if(b)for(var r of b(t))w.call(t,r)&&E(e,r,t[r]);return e};const T=({children:e,title:o,description:i,isCollapsible:s=!1,isInitiallyOpen:l=!0,kind:c="section",className:u})=>{const{colors:p,typography:d,spacing:f}=(0,a.useTheme2)(),[m,y]=(0,r.useState)(!s||l),h=m?"angle-up":"angle-down",b="sub-section"===c,O=`${m?"Collapse":"Expand"} section ${o}`,w={header:(0,t.css)({display:"flex",justifyContent:"space-between",alignItems:"center"}),title:(0,t.css)({margin:0}),subtitle:(0,t.css)({margin:0,fontWeight:d.fontWeightRegular}),descriptionText:(0,t.css)((E=j({marginTop:f(b?.25:.5),marginBottom:0},d.bodySmall),T={color:p.text.secondary},v(E,g(T)))),content:(0,t.css)({marginTop:f(2)})};var E,T;return n().createElement("div",{className:u},n().createElement("div",{className:w.header},"section"===c?n().createElement("h3",{className:w.title},o):n().createElement("h6",{className:w.subtitle},o),s&&n().createElement(a.IconButton,{name:h,onClick:()=>y(!m),type:"button",size:"xl","aria-label":O})),i&&n().createElement("p",{className:w.descriptionText},i),m&&n().createElement("div",{className:w.content},e))};var D=Object.defineProperty,S=Object.defineProperties,P=Object.getOwnPropertyDescriptors,F=Object.getOwnPropertySymbols,I=Object.prototype.hasOwnProperty,x=Object.prototype.propertyIsEnumerable,k=(e,t,r)=>t in e?D(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;const N=e=>{var t,r=e,{children:a}=r,o=((e,t)=>{var r={};for(var n in e)I.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&F)for(var n of F(e))t.indexOf(n)<0&&x.call(e,n)&&(r[n]=e[n]);return r})(r,["children"]);return n().createElement(T,(t=((e,t)=>{for(var r in t||(t={}))I.call(t,r)&&k(e,r,t[r]);if(F)for(var r of F(t))x.call(t,r)&&k(e,r,t[r]);return e})({},o),S(t,P({kind:"section"}))),a)};function C(e){const{description:t,suffix:r,feature:o}=e,i=`Learn more about ${o}`,s=(0,a.useStyles2)(q);return n().createElement("span",{className:s.container},t,n().createElement("a",{"aria-label":i,href:`https://grafana.com/docs/grafana/next/datasources/${r}`,rel:"noreferrer",target:"_blank"},i))}const q=e=>({container:(0,t.css)({color:e.colors.text.secondary,a:(0,t.css)({color:e.colors.text.link,textDecoration:"underline",marginLeft:"5px","&:hover":{textDecoration:"none"}})})});var _=c(531);const R=/^(-?\d+(?:\.\d+)?)(ms|[Mwdhmsy])$/,M=(e,t)=>!(e.match(t)||!e),B=e=>{const t=e.validationRegex||R,[o,i]=(0,r.useState)((()=>!!e.value&&M(e.value,t)));var s;!function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=[]);var a=function(e,t){void 0===t&&(t=0);var n=(0,r.useRef)(!1),a=(0,r.useRef)(),o=(0,r.useRef)(e),i=(0,r.useCallback)((function(){return n.current}),[]),s=(0,r.useCallback)((function(){n.current=!1,a.current&&clearTimeout(a.current),a.current=setTimeout((function(){n.current=!0,o.current()}),t)}),[t]),l=(0,r.useCallback)((function(){n.current=null,a.current&&clearTimeout(a.current)}),[]);return(0,r.useEffect)((function(){o.current=e}),[e]),(0,r.useEffect)((function(){return s(),l}),[t]),[i,l,s]}(e,t),o=a[0],i=a[1],s=a[2];(0,r.useEffect)(s,n)}((()=>{i(M(e.value,t))}),500,[e.value]);const l={labelWidth:26,disabled:null!==(s=e.disabled)&&void 0!==s&&s,invalid:o,error:e.isInvalidError};return e.label&&(l.label=e.label,l.tooltip=e.tooltip||""),n().createElement(a.InlineField,l,n().createElement(a.Input,{type:"text",placeholder:e.placeholder||"0",width:e.width||40,onChange:t=>{e.onChange(t.currentTarget.value)},value:e.value,"aria-label":e.ariaLabel||"interval input"}))};function $(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function G(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){$(e,t,r[t])}))}return e}function L(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const A=({values:e,onChange:r,id:o})=>{const i=(0,a.useStyles2)(z);return n().createElement("div",{className:i.wrapper},e.length?e.map(((s,l)=>n().createElement("div",{className:i.pair,key:l},n().createElement(a.SegmentInput,{id:`${o}-key-${l}`,placeholder:"Tag name",value:s.key,onChange:t=>{r(e.map(((e,r)=>r===l?L(G({},e),{key:String(t)}):e)))}}),n().createElement(a.InlineLabel,{"aria-label":"equals",className:i.operator},"as"),n().createElement(a.SegmentInput,{id:`${o}-value-${l}`,placeholder:"New name (optional)",value:s.value||"",onChange:t=>{r(e.map(((e,r)=>r===l?L(G({},e),{value:String(t)}):e)))}}),n().createElement(a.ToolbarButton,{onClick:()=>r([...e.slice(0,l),...e.slice(l+1)]),className:(0,t.cx)(i.removeTag,"query-part"),"aria-label":"Remove tag",type:"button",icon:"times"}),l===e.length-1?n().createElement(a.ToolbarButton,{onClick:()=>r([...e,{key:"",value:""}]),className:"query-part","aria-label":"Add tag",type:"button",icon:"plus"}):null))):n().createElement(a.ToolbarButton,{icon:"plus",onClick:()=>r([...e,{key:"",value:""}]),className:"query-part","aria-label":"Add tag",type:"button"}))},z=e=>({wrapper:(0,t.css)({display:"flex",flexDirection:"column",gap:`${e.spacing(.5)} 0`}),pair:(0,t.css)({display:"flex",justifyContent:"start",alignItems:"center"}),operator:(0,t.css)({color:e.v1.palette.orange,width:"auto"}),removeTag:(0,t.css)({marginRight:e.spacing(.5)})});function J(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function U(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){J(e,t,r[t])}))}return e}function W(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function Q({options:e,onOptionsChange:o}){const i=["loki","elasticsearch","grafana-splunk-datasource","grafana-opensearch-datasource","grafana-falconlogscale-datasource","googlecloud-logging-datasource"],s=(0,r.useMemo)((()=>function(e){var t;if(null==e?void 0:e.tracesToLogsV2)return e.tracesToLogsV2;if(!(null==e?void 0:e.tracesToLogs))return;const r={customQuery:!1};return r.datasourceUid=e.tracesToLogs.datasourceUid,r.tags=e.tracesToLogs.mapTagNamesEnabled?e.tracesToLogs.mappedTags:null===(t=e.tracesToLogs.tags)||void 0===t?void 0:t.map((e=>({key:e}))),r.filterByTraceID=e.tracesToLogs.filterByTraceID,r.filterBySpanID=e.tracesToLogs.filterBySpanID,r.spanStartTimeShift=e.tracesToLogs.spanStartTimeShift,r.spanEndTimeShift=e.tracesToLogs.spanEndTimeShift,r}(e.jsonData)||{customQuery:!1}),[e.jsonData]),{query:l="",tags:c,customQuery:u}=s,p=(0,r.useCallback)((t=>{o(W(U({},e),{jsonData:W(U({},e.jsonData),{tracesToLogsV2:U({},s,t),tracesToLogs:void 0})}))}),[o,e,s]);return n().createElement("div",{className:(0,t.css)({width:"100%"})},n().createElement(a.InlineFieldRow,null,n().createElement(a.InlineField,{tooltip:"The logs data source the trace is going to navigate to",label:"Data source",labelWidth:26},n().createElement(_.DataSourcePicker,{inputId:"trace-to-logs-data-source-picker",filter:e=>i.includes(e.type),current:s.datasourceUid,noDefault:!0,width:40,onChange:e=>p({datasourceUid:e.uid})}))),n().createElement(a.InlineFieldRow,null,n().createElement(B,{label:Z("start"),tooltip:Y("start","0"),value:s.spanStartTimeShift||"",onChange:e=>{p({spanStartTimeShift:e})},isInvalidError:H})),n().createElement(a.InlineFieldRow,null,n().createElement(B,{label:Z("end"),tooltip:Y("end","0"),value:s.spanEndTimeShift||"",onChange:e=>{p({spanEndTimeShift:e})},isInvalidError:H})),n().createElement(a.InlineFieldRow,null,n().createElement(a.InlineField,{tooltip:"Tags that will be used in the query. Default tags: 'cluster', 'hostname', 'namespace', 'pod', 'service.name', 'service.namespace'",label:"Tags",labelWidth:26},n().createElement(A,{values:null!=c?c:[],onChange:e=>p({tags:e})}))),n().createElement(V,{disabled:u,type:"trace",id:"filterByTraceID",value:Boolean(s.filterByTraceID),onChange:e=>p({filterByTraceID:e})}),n().createElement(V,{disabled:u,type:"span",id:"filterBySpanID",value:Boolean(s.filterBySpanID),onChange:e=>p({filterBySpanID:e})}),n().createElement(a.InlineFieldRow,null,n().createElement(a.InlineField,{tooltip:"Use a custom query with the possibility to interpolate variables from the trace or span",label:"Use custom query",labelWidth:26},n().createElement(a.InlineSwitch,{id:"customQuerySwitch",value:u,onChange:e=>p({customQuery:e.currentTarget.checked})}))),u&&n().createElement(a.InlineField,{label:"Query",labelWidth:26,tooltip:"The query that will run when navigating from a trace to logs data source. Interpolate tags using the `$__tags` keyword",grow:!0},n().createElement(a.Input,{label:"Query",type:"text",allowFullScreen:!0,value:l,onChange:e=>p({query:e.currentTarget.value})})))}function V(e){return n().createElement(a.InlineFieldRow,null,n().createElement(a.InlineField,{disabled:e.disabled,label:`Filter by ${e.type} ID`,labelWidth:26,grow:!0,tooltip:`Filters logs by ${e.type} ID`},n().createElement(a.InlineSwitch,{id:e.id,value:e.value,onChange:t=>e.onChange(t.currentTarget.checked)})))}const Z=e=>`Span ${e} time shift`,Y=(e,t)=>`Shifts the ${e} time of the span. Default: ${t} (Time units can be used here, for example: 5s, -1m, 3h)`,H="Invalid time shift. See tooltip for examples.",K=({options:e,onOptionsChange:t})=>{let r=e.type;return r+="tempo"===e.type?"/configure-tempo-data-source/#trace-to-logs":"/#trace-to-logs",n().createElement(N,{title:"Trace to logs",description:n().createElement(C,{description:"Navigate from a trace span to the selected data source's logs.",suffix:r,feature:"trace to logs"}),isCollapsible:!0,isInitiallyOpen:!0},n().createElement(Q,{options:e,onOptionsChange:t}))};function X(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function ee(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){X(e,t,r[t])}))}return e}function te(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function re({options:r,onOptionsChange:o}){var i,s,l,c,u,p,d;const f=(0,a.useStyles2)(ae);var m;return n().createElement("div",{className:(0,t.css)({width:"100%"})},n().createElement(a.InlineFieldRow,{className:f.row},n().createElement(a.InlineField,{tooltip:"The Prometheus data source the trace is going to navigate to",label:"Data source",labelWidth:26},n().createElement(_.DataSourcePicker,{inputId:"trace-to-metrics-data-source-picker",pluginId:"prometheus",current:null===(i=r.jsonData.tracesToMetrics)||void 0===i?void 0:i.datasourceUid,noDefault:!0,width:40,onChange:t=>(0,e.updateDatasourcePluginJsonDataOption)({onOptionsChange:o,options:r},"tracesToMetrics",te(ee({},r.jsonData.tracesToMetrics),{datasourceUid:t.uid}))})),(null===(s=r.jsonData.tracesToMetrics)||void 0===s?void 0:s.datasourceUid)?n().createElement(a.Button,{type:"button",variant:"secondary",size:"sm",fill:"text",onClick:()=>{(0,e.updateDatasourcePluginJsonDataOption)({onOptionsChange:o,options:r},"tracesToMetrics",te(ee({},r.jsonData.tracesToMetrics),{datasourceUid:void 0}))}},"Clear"):null),n().createElement(a.InlineFieldRow,null,n().createElement(B,{label:Z("start"),tooltip:Y("start","-2m"),value:(null===(l=r.jsonData.tracesToMetrics)||void 0===l?void 0:l.spanStartTimeShift)||"",onChange:t=>{(0,e.updateDatasourcePluginJsonDataOption)({onOptionsChange:o,options:r},"tracesToMetrics",te(ee({},r.jsonData.tracesToMetrics),{spanStartTimeShift:t}))},placeholder:"-2m",isInvalidError:H})),n().createElement(a.InlineFieldRow,null,n().createElement(B,{label:Z("end"),tooltip:Y("end","2m"),value:(null===(c=r.jsonData.tracesToMetrics)||void 0===c?void 0:c.spanEndTimeShift)||"",onChange:t=>{(0,e.updateDatasourcePluginJsonDataOption)({onOptionsChange:o,options:r},"tracesToMetrics",te(ee({},r.jsonData.tracesToMetrics),{spanEndTimeShift:t}))},placeholder:"2m",isInvalidError:H})),n().createElement(a.InlineFieldRow,null,n().createElement(a.InlineField,{tooltip:"Tags that will be used in the metrics query",label:"Tags",labelWidth:26},n().createElement(A,{values:null!==(m=null===(u=r.jsonData.tracesToMetrics)||void 0===u?void 0:u.tags)&&void 0!==m?m:[],onChange:t=>(0,e.updateDatasourcePluginJsonDataOption)({onOptionsChange:o,options:r},"tracesToMetrics",te(ee({},r.jsonData.tracesToMetrics),{tags:t}))}))),null===(d=r.jsonData.tracesToMetrics)||void 0===d||null===(p=d.queries)||void 0===p?void 0:p.map(((t,i)=>n().createElement("div",{key:i,className:f.queryRow},n().createElement(a.InlineField,{label:"Link Label",labelWidth:26,tooltip:"Descriptive label for the linked query"},n().createElement(a.Input,{label:"Link Label",type:"text",allowFullScreen:!0,value:t.name,width:40,onChange:t=>{var n,a;const s=(null!==(a=null===(n=r.jsonData.tracesToMetrics)||void 0===n?void 0:n.queries)&&void 0!==a?a:[]).map(((e,r)=>r===i?te(ee({},e),{name:t.currentTarget.value}):e));(0,e.updateDatasourcePluginJsonDataOption)({onOptionsChange:o,options:r},"tracesToMetrics",te(ee({},r.jsonData.tracesToMetrics),{queries:s}))}})),n().createElement(a.InlineField,{label:"Query",labelWidth:10,tooltip:"The Prometheus query that will run when navigating from a trace to metrics. Interpolate tags using the `$__tags` keyword",grow:!0},n().createElement(a.Input,{label:"Query",type:"text",allowFullScreen:!0,value:t.query,onChange:t=>{var n,a;const s=(null!==(a=null===(n=r.jsonData.tracesToMetrics)||void 0===n?void 0:n.queries)&&void 0!==a?a:[]).map(((e,r)=>r===i?te(ee({},e),{query:t.currentTarget.value}):e));(0,e.updateDatasourcePluginJsonDataOption)({onOptionsChange:o,options:r},"tracesToMetrics",te(ee({},r.jsonData.tracesToMetrics),{queries:s}))}})),n().createElement(a.Button,{variant:"destructive",title:"Remove query",icon:"times",type:"button",onClick:()=>{var t;const n=null===(t=r.jsonData.tracesToMetrics)||void 0===t?void 0:t.queries.filter(((e,t)=>t!==i));(0,e.updateDatasourcePluginJsonDataOption)({onOptionsChange:o,options:r},"tracesToMetrics",te(ee({},r.jsonData.tracesToMetrics),{queries:n}))}})))),n().createElement(a.Button,{variant:"secondary",title:"Add query",icon:"plus",type:"button",onClick:()=>{var t,n;(0,e.updateDatasourcePluginJsonDataOption)({onOptionsChange:o,options:r},"tracesToMetrics",te(ee({},r.jsonData.tracesToMetrics),{queries:[...null!==(n=null===(t=r.jsonData.tracesToMetrics)||void 0===t?void 0:t.queries)&&void 0!==n?n:[],{query:""}]}))}},"Add query"))}const ne=({options:e,onOptionsChange:t})=>{let r=e.type;return r+="tempo"===e.type?"/configure-tempo-data-source/#trace-to-metrics":"/#trace-to-metrics",n().createElement(N,{title:"Trace to metrics",description:n().createElement(C,{description:"Navigate from a trace span to the selected data source's metrics.",suffix:r,feature:"trace to metrics"}),isCollapsible:!0,isInitiallyOpen:!0},n().createElement(re,{options:e,onOptionsChange:t}))},ae=e=>({infoText:{paddingBottom:e.spacing(2),color:e.colors.text.secondary},row:(0,t.css)({label:"row",alignItems:"baseline"}),queryRow:(0,t.css)({label:"queryRow",display:"flex",flexFlow:"wrap"})});var oe=Object.defineProperty,ie=Object.defineProperties,se=Object.getOwnPropertyDescriptors,le=Object.getOwnPropertySymbols,ce=Object.prototype.hasOwnProperty,ue=Object.prototype.propertyIsEnumerable,pe=(e,t,r)=>t in e?oe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;const de=e=>{var t,r=e,{children:a}=r,o=((e,t)=>{var r={};for(var n in e)ce.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&le)for(var n of le(e))t.indexOf(n)<0&&ue.call(e,n)&&(r[n]=e[n]);return r})(r,["children"]);return n().createElement(T,(t=((e,t)=>{for(var r in t||(t={}))ce.call(t,r)&&pe(e,r,t[r]);if(le)for(var r of le(t))ue.call(t,r)&&pe(e,r,t[r]);return e})({},o),ie(t,se({kind:"sub-section"}))),a)};function fe(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function me({options:t,onOptionsChange:r}){var o;const i=(0,a.useStyles2)(he);return n().createElement("div",{className:i.container},n().createElement(a.InlineFieldRow,{className:i.row},n().createElement(a.InlineField,{tooltip:"Displays the node graph above the trace view. Default: disabled",label:"Enable node graph",labelWidth:26},n().createElement(a.InlineSwitch,{id:"enableNodeGraph",value:null===(o=t.jsonData.nodeGraph)||void 0===o?void 0:o.enabled,onChange:n=>{return(0,e.updateDatasourcePluginJsonDataOption)({onOptionsChange:r,options:t},"nodeGraph",(a=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){fe(e,t,r[t])}))}return e}({},t.jsonData.nodeGraph),o=null!=(o={enabled:n.currentTarget.checked})?o:{},Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(o)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(o)).forEach((function(e){Object.defineProperty(a,e,Object.getOwnPropertyDescriptor(o,e))})),a));var a,o}}))))}const ye=({options:e,onOptionsChange:t})=>{let r=e.type;return r+="tempo"===e.type?"/configure-tempo-data-source/#node-graph":"/#node-graph",n().createElement(de,{title:"Node graph",description:n().createElement(C,{description:"Show or hide the node graph visualization.",suffix:r,feature:"the node graph"})},n().createElement(me,{options:e,onOptionsChange:t}))},he=e=>({infoText:(0,t.css)({label:"infoText",paddingBottom:e.spacing(2),color:e.colors.text.secondary}),container:(0,t.css)({label:"container",width:"100%"}),row:(0,t.css)({label:"row",alignItems:"baseline"})});function ve(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function ge(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){ve(e,t,r[t])}))}return e}function be(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const Oe="None",we="Duration",Ee="Tag";function je({options:r,onOptionsChange:o}){var i,s,l;const c=(0,a.useStyles2)(De),u=[Oe,we,Ee].map(e.toOption);return n().createElement("div",{className:(0,t.css)({width:"100%"})},n().createElement(a.InlineFieldRow,{className:c.row},n().createElement(a.InlineField,{label:"Label",labelWidth:26,tooltip:"Default: duration",grow:!0},n().createElement(a.Select,{inputId:"label",options:u,value:(null===(i=r.jsonData.spanBar)||void 0===i?void 0:i.type)||"",onChange:t=>{var n;(0,e.updateDatasourcePluginJsonDataOption)({onOptionsChange:o,options:r},"spanBar",be(ge({},r.jsonData.spanBar),{type:null!==(n=null==t?void 0:t.value)&&void 0!==n?n:""}))},placeholder:"Duration",isClearable:!0,"aria-label":"select-label-name",width:40}))),(null===(s=r.jsonData.spanBar)||void 0===s?void 0:s.type)===Ee&&n().createElement(a.InlineFieldRow,{className:c.row},n().createElement(a.InlineField,{label:"Tag key",labelWidth:26,tooltip:"Tag key which will be used to get the tag value. A span's attributes and resources will be searched for the tag key"},n().createElement(a.Input,{type:"text",placeholder:"Enter tag key",onChange:t=>(0,e.updateDatasourcePluginJsonDataOption)({onOptionsChange:o,options:r},"spanBar",be(ge({},r.jsonData.spanBar),{tag:t.currentTarget.value})),value:(null===(l=r.jsonData.spanBar)||void 0===l?void 0:l.tag)||"",width:40}))))}const Te=({options:e,onOptionsChange:t})=>{let r=e.type;return r+="tempo"===e.type?"/configure-tempo-data-source/#span-bar":"/#span-bar",n().createElement(de,{title:"Span bar",description:n().createElement(C,{description:"Add additional info next to the service and operation on a span bar row in the trace view.",suffix:r,feature:"the span bar"})},n().createElement(je,{options:e,onOptionsChange:t}))},De=e=>({infoText:(0,t.css)({label:"infoText",paddingBottom:e.spacing(2),color:e.colors.text.secondary}),row:(0,t.css)({label:"row",alignItems:"baseline"})}),Se=e=>({container:t.css`
    label: container;
    margin-bottom: ${e.spacing(2)};
    max-width: 900px;
  `});var Pe=c(241),Fe=function(e,t){return Fe=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},Fe(e,t)};function Ie(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}Fe(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var xe=function(){return xe=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var a in t=arguments[r])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e},xe.apply(this,arguments)};function ke(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function Ne(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,a,o=r.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(n=o.next()).done;)i.push(n.value)}catch(e){a={error:e}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(a)throw a.error}}return i}function Ce(e,t,r){if(r||2===arguments.length)for(var n,a=0,o=t.length;a<o;a++)!n&&a in t||(n||(n=Array.prototype.slice.call(t,0,a)),n[a]=t[a]);return e.concat(n||Array.prototype.slice.call(t))}function qe(){var e=(0,r.useRef)(!1),t=(0,r.useCallback)((function(){return e.current}),[]);return(0,r.useEffect)((function(){return e.current=!0,function(){e.current=!1}}),[]),t}function _e(e,t,n){void 0===t&&(t=[]),void 0===n&&(n={loading:!1});var a=(0,r.useRef)(0),o=qe(),i=(0,r.useState)(n),s=i[0],l=i[1],c=(0,r.useCallback)((function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var n=++a.current;return s.loading||l((function(e){return xe(xe({},e),{loading:!0})})),e.apply(void 0,t).then((function(e){return o()&&n===a.current&&l({value:e,loading:!1}),e}),(function(e){return o()&&n===a.current&&l({error:e,loading:!1}),e}))}),t);return[s,c]}Object.create,Object.create,"function"==typeof SuppressedError&&SuppressedError;const Re=function(e){var t;t=function(){e()},(0,r.useEffect)(t,[])};var Me;!function(e){e[e.Error=7e3]="Error",e[e.Info=3e3]="Info",e[e.Success=3e3]="Success",e[e.Warning=5e3]="Warning"}(Me||(Me={}));const Be={error:7e3,info:3e3,success:3e3,warning:5e3},$e=e=>{const o=(i=(0,a.useTheme2)(),(0,t.css)({position:"absolute",zIndex:i.zIndex.portal,top:0,right:10}));var i;const[s,l]=(0,r.useState)(!1),[c,u]=(0,r.useState)();return(0,r.useEffect)((()=>()=>{c&&clearTimeout(c)}),[c]),(0,r.useEffect)((()=>{if(""!==e.text){l(!0);const t=setTimeout((()=>{l(!1)}),Be[e.severity]);u(t)}}),[e.severity,e.text]),n().createElement(n().Fragment,null,s&&n().createElement(a.Alert,{className:o,elevated:!0,title:e.text,severity:e.severity}))},Ge="/api/v2";function Le(e,t,r,n,a,o,i){try{var s=e[o](i),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function Ae(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Le(o,n,a,i,s,"next",e)}function s(e){Le(o,n,a,i,s,"throw",e)}i(void 0)}))}}function ze(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Je(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){ze(e,t,r[t])}))}return e}function Ue(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const We=e=>({tracesCascader:(0,t.css)({label:"tracesCascader",marginRight:e.spacing(1)})}),Qe=[{label:"No traces found",value:"no_traces",isLeaf:!0}],Ve={"[No traces in time range]":"__NO_TRACES__"};var Ze=c(269);function Ye(e){return"function"==typeof e}var He,Ke=((He=function(e){var t;t=this,Error.call(t),t.stack=(new Error).stack,this.message=e?e.length+" errors occurred during unsubscription:\n"+e.map((function(e,t){return t+1+") "+e.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=e}).prototype=Object.create(Error.prototype),He.prototype.constructor=He,He);function Xe(e,t){if(e){var r=e.indexOf(t);0<=r&&e.splice(r,1)}}var et=function(){function e(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}var t;return e.prototype.unsubscribe=function(){var e,t,r,n,a;if(!this.closed){this.closed=!0;var o=this._parentage;if(o)if(this._parentage=null,Array.isArray(o))try{for(var i=ke(o),s=i.next();!s.done;s=i.next())s.value.remove(this)}catch(t){e={error:t}}finally{try{s&&!s.done&&(t=i.return)&&t.call(i)}finally{if(e)throw e.error}}else o.remove(this);var l=this.initialTeardown;if(Ye(l))try{l()}catch(e){a=e instanceof Ke?e.errors:[e]}var c=this._finalizers;if(c){this._finalizers=null;try{for(var u=ke(c),p=u.next();!p.done;p=u.next()){var d=p.value;try{tt(d)}catch(e){a=null!=a?a:[],e instanceof Ke?a=Ce(Ce([],Ne(a)),Ne(e.errors)):a.push(e)}}}catch(e){r={error:e}}finally{try{p&&!p.done&&(n=u.return)&&n.call(u)}finally{if(r)throw r.error}}}if(a)throw new Ke(a)}},e.prototype.add=function(t){var r;if(t&&t!==this)if(this.closed)tt(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=null!==(r=this._finalizers)&&void 0!==r?r:[]).push(t)}},e.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},e.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},e.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&Xe(t,e)},e.prototype.remove=function(t){var r=this._finalizers;r&&Xe(r,t),t instanceof e&&t._removeParent(this)},e.EMPTY=((t=new e).closed=!0,t),e}();function tt(e){Ye(e)?e():e.unsubscribe()}et.EMPTY;var rt=null,nt=null,at=!1,ot=!1,it={setTimeout:function(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];var a=it.delegate;return(null==a?void 0:a.setTimeout)?a.setTimeout.apply(a,Ce([e,t],Ne(r))):setTimeout.apply(void 0,Ce([e,t],Ne(r)))},clearTimeout:function(e){var t=it.delegate;return((null==t?void 0:t.clearTimeout)||clearTimeout)(e)},delegate:void 0};function st(){}var lt=ct("C",void 0,void 0);function ct(e,t,r){return{kind:e,value:t,error:r}}var ut=function(e){function t(t){var r,n=e.call(this)||this;return n.isStopped=!1,t?(n.destination=t,((r=t)instanceof et||r&&"closed"in r&&Ye(r.remove)&&Ye(r.add)&&Ye(r.unsubscribe))&&t.add(n)):n.destination=vt,n}return Ie(t,e),t.create=function(e,t,r){return new mt(e,t,r)},t.prototype.next=function(e){this.isStopped?ht(function(e){return ct("N",e,void 0)}(e),this):this._next(e)},t.prototype.error=function(e){this.isStopped?ht(ct("E",void 0,e),this):(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped?ht(lt,this):(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){try{this.destination.error(e)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(et),pt=Function.prototype.bind;function dt(e,t){return pt.call(e,t)}var ft=function(){function e(e){this.partialObserver=e}return e.prototype.next=function(e){var t=this.partialObserver;if(t.next)try{t.next(e)}catch(e){yt(e)}},e.prototype.error=function(e){var t=this.partialObserver;if(t.error)try{t.error(e)}catch(e){yt(e)}else yt(e)},e.prototype.complete=function(){var e=this.partialObserver;if(e.complete)try{e.complete()}catch(e){yt(e)}},e}(),mt=function(e){function t(t,r,n){var a,o,i=e.call(this)||this;return Ye(t)||!t?a={next:null!=t?t:void 0,error:null!=r?r:void 0,complete:null!=n?n:void 0}:i&&ot?((o=Object.create(t)).unsubscribe=function(){return i.unsubscribe()},a={next:t.next&&dt(t.next,o),error:t.error&&dt(t.error,o),complete:t.complete&&dt(t.complete,o)}):a=t,i.destination=new ft(a),i}return Ie(t,e),t}(ut);function yt(e){at||function(e){it.setTimeout((function(){if(!rt)throw e;rt(e)}))}(e)}function ht(e,t){var r=nt;r&&it.setTimeout((function(){return r(e,t)}))}var vt={closed:!0,next:st,error:function(e){throw e},complete:st},gt=function(e){function t(t,r,n,a,o,i){var s=e.call(this,t)||this;return s.onFinalize=o,s.shouldUnsubscribe=i,s._next=r?function(e){try{r(e)}catch(e){t.error(e)}}:e.prototype._next,s._error=a?function(e){try{a(e)}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._error,s._complete=n?function(){try{n()}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._complete,s}return Ie(t,e),t.prototype.unsubscribe=function(){var t;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var r=this.closed;e.prototype.unsubscribe.call(this),!r&&(null===(t=this.onFinalize)||void 0===t||t.call(this))}},t}(ut);function bt(e,t){return r=function(r,n){var a=0;r.subscribe(new gt(n,(function(r){n.next(e.call(t,r,a++))}),void 0,void 0,void 0))},function(e){if(function(e){return Ye(null==e?void 0:e.lift)}(e))return e.lift((function(e){try{return r(e,this)}catch(e){this.error(e)}}));throw new TypeError("Unable to lift unknown Observable type")};var r}function Ot(e,t,r){return{main:`${wt(e)}ms (${wt(e/t*100)}%)`,secondary:`${wt(r)}ms (${wt(r/e*100)}%)`}}function wt(e){return parseFloat(e.toFixed(2))}function Et(t){const r=t.map(jt),n=new e.MutableDataFrame({fields:[{name:"traceID",type:e.FieldType.string,values:[]},{name:"spanID",type:e.FieldType.string,values:[]},{name:"parentSpanID",type:e.FieldType.string,values:[]},{name:"operationName",type:e.FieldType.string,values:[]},{name:"serviceName",type:e.FieldType.string,values:[]},{name:"serviceTags",type:e.FieldType.other,values:[]},{name:"startTime",type:e.FieldType.number,values:[]},{name:"duration",type:e.FieldType.number,values:[]},{name:"logs",type:e.FieldType.other,values:[]},{name:"tags",type:e.FieldType.other,values:[]}],meta:{preferredVisualisationType:"trace",custom:{traceFormat:"zipkin"}}});for(const e of r)n.add(e);return n}function jt(e){var t,r,n,a;const o={traceID:e.traceId,spanID:e.id,parentSpanID:e.parentId,operationName:e.name,serviceName:(null===(t=e.localEndpoint)||void 0===t?void 0:t.serviceName)||(null===(r=e.remoteEndpoint)||void 0===r?void 0:r.serviceName)||"unknown",serviceTags:Dt(e),startTime:e.timestamp/1e3,duration:e.duration/1e3,logs:null!==(a=null===(n=e.annotations)||void 0===n?void 0:n.map(Tt))&&void 0!==a?a:[],tags:Object.keys(e.tags||{}).reduce(((t,r)=>"error"===r?(t.push({key:"error",value:!0}),t.push({key:"errorValue",value:e.tags.error}),t):(t.push({key:r,value:e.tags[r]}),t)),[])};var i,s;return e.kind&&(o.tags=[{key:"kind",value:e.kind},...null!==(i=o.tags)&&void 0!==i?i:[]]),e.shared&&(o.tags=[{key:"shared",value:e.shared},...null!==(s=o.tags)&&void 0!==s?s:[]]),o}function Tt(e){return{timestamp:e.timestamp,fields:[{key:"annotation",value:e.value}]}}function Dt(e){const t=e.localEndpoint||e.remoteEndpoint;return t?[St("ipv4",t.ipv4),St("ipv6",t.ipv6),St("port",t.port),St("endpointType",e.localEndpoint?"local":"remote")].filter((e=>Boolean(e))):[]}function St(e,t){if(t)return{key:e,value:t}}function Pt(e,t,r,n,a,o,i){try{var s=e[o](i),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function Ft(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Pt(o,n,a,i,s,"next",e)}function s(e){Pt(o,n,a,i,s,"throw",e)}i(void 0)}))}}function It(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function xt(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){It(e,t,r[t])}))}return e}function kt(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}class Nt extends e.DataSourceApi{query(e){const t=e.targets[0];if("upload"===t.queryType){if(!this.uploadedJson)return(0,Ze.of)({data:[]});try{var r;const e=JSON.parse(this.uploadedJson);return(0,Ze.of)(Ct({data:e},null===(r=this.nodeGraph)||void 0===r?void 0:r.enabled))}catch(e){return(0,Ze.of)({error:{message:"JSON is not valid Zipkin format"},data:[]})}}if(t.query){const r=this.applyVariables(t,e.scopedVars);return this.request(`${Ge}/trace/${encodeURIComponent(r.query)}`).pipe(bt((e=>{var t;return Ct(e,null===(t=this.nodeGraph)||void 0===t?void 0:t.enabled)})))}return(0,Ze.of)(qt)}metadataRequest(e,t){var r=this;return Ft((function*(){return(yield(0,Ze.lastValueFrom)(r.request(e,t,{hideFromInspector:!0}))).data}))()}testDatasource(){var e=this;return Ft((function*(){return yield e.metadataRequest(`${Ge}/services`),{status:"success",message:"Data source is working"}}))()}getQueryDisplayText(e){return e.query}interpolateVariablesInQueries(e,t){return e&&0!==e.length?e.map((e=>xt(kt(xt({},e),{datasource:this.getRef()}),this.applyVariables(e,t)))):[]}applyVariables(e,t){const r=xt({},e);var n;return kt(xt({},r),{query:this.templateSrv.replace(null!==(n=e.query)&&void 0!==n?n:"",t)})}request(t,r,n){const a=r?e.urlUtil.serializeParams(r):"",o=`${this.instanceSettings.url}${t}${a.length?`?${a}`:""}`,i=kt(xt({},n),{url:o});return(0,_.getBackendSrv)().fetch(i)}constructor(e,t=(0,_.getTemplateSrv)()){super(e),It(this,"instanceSettings",void 0),It(this,"templateSrv",void 0),It(this,"uploadedJson",void 0),It(this,"nodeGraph",void 0),It(this,"spanBar",void 0),this.instanceSettings=e,this.templateSrv=t,this.uploadedJson=null,this.nodeGraph=e.jsonData.nodeGraph}}function Ct(t,r=!1){let n=(null==t?void 0:t.data)?[Et(null==t?void 0:t.data)]:[];return r&&n.push(...function(t){const{nodes:r,edges:n}=function(t){const r=[],n=[],a=function(e){let t=0,r=1/0;for(const n of e)n.timestamp<r&&(r=n.timestamp),n.timestamp+n.duration>t&&(t=n.timestamp+n.duration);return t-r}(t),o=function(e){const t={};let r;for(let n=0;r=e(n),r;n++){t[r.id]?t[r.id].span=r.span:t[r.id]={span:r.span,children:[]};for(const e of r.parentIds)e&&(t[e]?t[e].children.push(r.id):t[e]={span:void 0,children:[r.id]})}return t}((e=>{if(!(e>=t.length))return{span:t[e],id:t[e].id,parentIds:t[e].parentId?[t[e].parentId]:[]}}));for(const c of t){var i,s;const t=((l=o[c.id].children.map((e=>{const t=o[e].span;return[t.timestamp,t.timestamp+t.duration]}))).sort(((e,t)=>e[0]-t[0])),l.reduce(((e,t)=>{if(!e.length)return[t];const r=e.slice(-1)[0],[n,a]=r,[o,i]=t;return i<a?e:o>a?[...e,t]:[...e.slice(0,-1),[n,i]]}),[]).reduce(((e,t)=>e+(t[1]-t[0])),0)),u=c.duration-t,p=Ot(c.duration/1e3,a/1e3,u/1e3);r.push({[e.NodeGraphDataFrameFieldNames.id]:c.id,[e.NodeGraphDataFrameFieldNames.title]:(null===(i=c.localEndpoint)||void 0===i?void 0:i.serviceName)||(null===(s=c.remoteEndpoint)||void 0===s?void 0:s.serviceName)||"unknown",[e.NodeGraphDataFrameFieldNames.subTitle]:c.name,[e.NodeGraphDataFrameFieldNames.mainStat]:p.main,[e.NodeGraphDataFrameFieldNames.secondaryStat]:p.secondary,[e.NodeGraphDataFrameFieldNames.color]:u/a}),c.parentId&&o[c.parentId].span&&n.push({[e.NodeGraphDataFrameFieldNames.id]:c.parentId+"--"+c.id,[e.NodeGraphDataFrameFieldNames.target]:c.id,[e.NodeGraphDataFrameFieldNames.source]:c.parentId})}var l;return{nodes:r,edges:n}}(t),[a,o]=[new e.MutableDataFrame({fields:[{name:e.NodeGraphDataFrameFieldNames.id,type:e.FieldType.string},{name:e.NodeGraphDataFrameFieldNames.title,type:e.FieldType.string},{name:e.NodeGraphDataFrameFieldNames.subTitle,type:e.FieldType.string},{name:e.NodeGraphDataFrameFieldNames.mainStat,type:e.FieldType.string,config:{displayName:"Total time (% of trace)"}},{name:e.NodeGraphDataFrameFieldNames.secondaryStat,type:e.FieldType.string,config:{displayName:"Self time (% of total)"}},{name:e.NodeGraphDataFrameFieldNames.color,type:e.FieldType.number,config:{color:{mode:"continuous-GrYlRd"},displayName:"Self time / Trace duration"}}],meta:{preferredVisualisationType:"nodeGraph"}}),new e.MutableDataFrame({fields:[{name:e.NodeGraphDataFrameFieldNames.id,type:e.FieldType.string},{name:e.NodeGraphDataFrameFieldNames.target,type:e.FieldType.string},{name:e.NodeGraphDataFrameFieldNames.source,type:e.FieldType.string}],meta:{preferredVisualisationType:"nodeGraph"}})];for(const e of r)a.add(e);for(const e of n)o.add(e);return[a,o]}(null==t?void 0:t.data)),{data:n}}const qt={data:[(0,e.createDataFrame)({fields:[{name:"trace",type:e.FieldType.trace,values:[]}],meta:{preferredVisualisationType:"trace",custom:{traceFormat:"zipkin"}}})]},_t=new e.DataSourcePlugin(Nt).setQueryEditor((({query:e,onChange:o,onRunQuery:i,datasource:s})=>{const[l,c]=(0,r.useState)(!1),[u,p]=(0,r.useState)(""),d=function(e,t){const r=`${Ge}/services`,[n,a]=_e(Ae((function*(){try{const t=yield e.metadataRequest(r);return t?t.sort().map((e=>({label:e,value:e,isLeaf:!1}))):[]}catch(e){const r=`Failed to load spans from Zipkin: ${(e instanceof Error?e:"An unknown error occurred").toString()}`;throw t(r),e}})),[e]);return Re((()=>{a()})),n}(s,p),f=(0,a.useTheme2)(),m=(0,a.useStyles2)(We),{onLoadOptions:y,allOptions:h}=function(e,t){const n=qe(),[a,o]=(0,r.useState)({}),[,i]=_e((c=Ae((function*(r){const a=`${Ge}/spans`;try{const t=yield e.metadataRequest(a,{serviceName:r});n()&&o((e=>{const n=(0,Pe.fromPairs)(t.map((e=>[e,void 0])));return Ue(Je({},e),{[r]:n})}))}catch(e){const r=`Failed to load spans from Zipkin: ${(e instanceof Error?e:"An unknown error occurred").toString()}`;throw t(r),e}})),function(e){return c.apply(this,arguments)}),[e,a]),[,s]=_e((l=Ae((function*(r,a){const i=`${Ge}/traces`,s={serviceName:r,spanName:a};try{const t=yield e.metadataRequest(i,s);if(n()){const e=t.length?(0,Pe.fromPairs)(t.map((e=>{const t=e.find((e=>!e.parentId));return[`${t.name} [${Math.floor(t.duration/1e3)} ms]`,t.traceId]}))):Ve;o((t=>{const n=t[r];return Ue(Je({},t),{[r]:Ue(Je({},n),{[a]:e})})}))}}catch(e){const r=`Failed to load spans from Zipkin: ${(e instanceof Error?e:"An unknown error occurred").toString()}`;throw t(r),e}})),function(e,t){return l.apply(this,arguments)}),[e]);var l,c;return{onLoadOptions:(0,r.useCallback)((e=>{const t=e[0].value;if(1===e.length)i(t);else if(2===e.length){const r=e[1].value;s(t,r)}}),[i,s]),allOptions:a}}(s,p),v=(0,r.useCallback)(((t,r)=>{if(3===r.length){const t=r[2].value;o(Ue(Je({},e),{query:t})),i()}}),[o,i,e]);(0,r.useEffect)((()=>{e.queryType||o(Ue(Je({},e),{queryType:"traceID"}))}),[e,o]);let g=function(e,t){return(0,r.useMemo)((()=>{let r=[];return e.value&&e.value.length?r=e.value.map((e=>Ue(Je({},e),{children:t[e.value]&&Object.keys(t[e.value]).map((r=>({label:r,value:r,isLeaf:!1,children:t[e.value][r]&&Object.keys(t[e.value][r]).map((n=>({label:n,value:t[e.value][r][n]})))})))}))):e.value&&!e.value.length&&(r=Qe),r}),[e,t])}(d,h);return n().createElement(n().Fragment,null,n().createElement(a.Modal,{title:"Upload trace",isOpen:l,onDismiss:()=>c(!1)},n().createElement("div",{className:(0,t.css)({padding:f.spacing(2)})},n().createElement(a.FileDropzone,{options:{multiple:!1},onLoad:t=>{s.uploadedJson=t,o(Ue(Je({},e),{queryType:"upload"})),c(!1),i()}}))),n().createElement(a.InlineFieldRow,null,n().createElement(a.InlineField,{label:"Query type",grow:!0},n().createElement(a.HorizontalGroup,{spacing:"sm",align:"center",justify:"space-between"},n().createElement(a.RadioButtonGroup,{options:[{value:"traceID",label:"TraceID"}],value:e.queryType||"traceID",onChange:t=>o(Ue(Je({},e),{queryType:t})),size:"md"}),n().createElement(a.Button,{variant:"secondary",size:"sm",onClick:()=>{c(!0)}},"Import trace")))),"traceID"===e.queryType&&n().createElement(a.InlineFieldRow,null,n().createElement(a.ButtonCascader,{options:g,onChange:v,loadData:y,variant:"secondary",buttonProps:{className:m.tracesCascader}},"Traces"),n().createElement("div",{className:"gf-form gf-form--grow flex-shrink-1 min-width-15"},n().createElement(a.QueryField,{query:e.query,onChange:t=>{const r=Ue(Je({},e),{query:t});o(r)},onRunQuery:i,placeholder:"Insert Trace ID (run with Shift+Enter)",portalOrigin:"zipkin"}))),u&&n().createElement($e,{text:u,severity:"error"}))})).setConfigEditor((({options:e,onOptionsChange:t})=>{const r=(0,a.useStyles2)(Se);return n().createElement("div",{className:r.container},n().createElement(y,{dataSourceName:"Zipkin",docsLink:"https://grafana.com/docs/grafana/latest/datasources/zipkin",hasRequiredFields:!1}),n().createElement(a.Divider,{spacing:4}),n().createElement(a.DataSourceHttpSettings,{defaultUrl:"http://localhost:9411",dataSourceConfig:e,showAccessOptions:!1,onChange:t,secureSocksDSProxyEnabled:_.config.secureSocksDSProxyEnabled}),n().createElement(K,{options:e,onOptionsChange:t}),n().createElement(a.Divider,{spacing:4}),_.config.featureToggles.traceToMetrics?n().createElement(n().Fragment,null,n().createElement(ne,{options:e,onOptionsChange:t}),n().createElement(a.Divider,{spacing:4})):null,n().createElement(N,{title:"Additional settings",description:"Additional settings are optional settings that can be configured for more control over your data source.",isCollapsible:!0,isInitiallyOpen:!1},n().createElement(a.Stack,{gap:5,direction:"column"},n().createElement(ye,{options:e,onOptionsChange:t}),n().createElement(Te,{options:e,onOptionsChange:t}))))}))})(),u})()));
//# sourceMappingURL=module.js.map