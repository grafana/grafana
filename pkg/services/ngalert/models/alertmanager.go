package models

const AlertConfigurationVersion = 1

// AlertConfiguration represents a single version of the Alerting Engine Configuration.
type AlertConfiguration struct {
	ID int64 `xorm:"pk autoincr 'id'"`

	AlertmanagerConfiguration string
	ConfigurationHash         string
	ConfigurationVersion      string
	CreatedAt                 int64 `xorm:"created_at"`
	Default                   bool
	OrgID                     int64 `xorm:"org_id"`
}

// HistoricAlertConfiguration represents a previously used alerting configuration.
type HistoricAlertConfiguration struct {
	ID                 int64 `xorm:"pk autoincr 'id'"`
	AlertConfiguration `xorm:"extends"`

	// LastApplied a timestamp indicating the most recent time at which the configuration was applied to an Alertmanager, or 0 otherwise.
	// Only set this field if the configuration has been applied by the caller.
	LastApplied int64 `xorm:"last_applied"`
}

// SaveAlertmanagerConfigurationCmd is the command to save an alertmanager configuration.
type SaveAlertmanagerConfigurationCmd struct {
	AlertmanagerConfiguration string
	FetchedConfigurationHash  string
	ConfigurationVersion      string
	Default                   bool
	OrgID                     int64
	LastApplied               int64
}

// MarkConfigurationAsAppliedCmd is the command for marking a previously saved configuration as successfully applied.
type MarkConfigurationAsAppliedCmd struct {
	OrgID             int64
	ConfigurationHash string
}

func HistoricConfigFromAlertConfig(config AlertConfiguration) HistoricAlertConfiguration {
	// Reset the ID so it can be generated by the DB.
	config.ID = 0
	return HistoricAlertConfiguration{
		AlertConfiguration: config,
	}
}

// ApplyConfigOption is a functional option for ApplyConfig.
type ApplyConfigOption func(*ApplyConfigOptions)

// ApplyConfigOptions holds options for ApplyConfig functions. Exported so other
// packages (for example `remote`) can construct and apply options.
type ApplyConfigOptions struct {
	AutogenInvalidReceiversAction InvalidReceiversAction
}

// WithAutogenInvalidReceiversAction configures which InvalidReceiversAction to use when
// applying configuration and generating autogen routes.
func WithAutogenInvalidReceiversAction(a InvalidReceiversAction) ApplyConfigOption {
	return func(o *ApplyConfigOptions) {
		o.AutogenInvalidReceiversAction = a
	}
}

// WithOverrides returns a copy of the ApplyConfigOptions with each option applied in order.
func (ao ApplyConfigOptions) WithOverrides(opts ...ApplyConfigOption) ApplyConfigOptions {
	for _, o := range opts {
		o(&ao)
	}
	return ao
}

type InvalidReceiversAction string

const (
	ErrorOnInvalidReceivers InvalidReceiversAction = "error"
	LogInvalidReceivers     InvalidReceiversAction = "log"
	IgnoreInvalidReceivers  InvalidReceiversAction = "ignore"
)
