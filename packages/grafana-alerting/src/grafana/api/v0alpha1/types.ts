/**
 * This file contains enhanced and type-narrowed versions of the types generated by the RTKQ codegen package.
 */
import { MergeDeep, MergeExclusive, OverrideProperties } from 'type-fest';

import type { ListReceiverApiResponse, Receiver, Integration as ReceiverIntegration } from './api.gen';

type GenericIntegration = OverrideProperties<
  ReceiverIntegration,
  {
    settings: Record<string, unknown>;
  }
>;

// Based on https://github.com/grafana/alerting/blob/main/receivers/email/config.go#L20-L25
type EmailIntegration = OverrideProperties<
  GenericIntegration,
  {
    type: 'email';
    settings: {
      singleEmail?: boolean;
      addresses: string;
      message?: string;
      subject?: string;
    };
    secureFields: never; // email doesn't have any secure fields
  }
>;

// Based on https://github.com/grafana/alerting/blob/main/receivers/slack/config.go
type SlackIntegration = OverrideProperties<
  GenericIntegration,
  {
    type: 'slack';
    settings: {
      endpointUrl?: string;
      url?: string;
      recipient?: string;
      text?: string;
      title?: string;
      username?: string;
      icon_emoji?: string;
      icon_url?: string;
      mentionChannel?: string;
      mentionUsers?: string; // comma separated string
      mentionGroups?: string; // comma separated string
      color?: string;
    };
    // secureFields is a union type that can be either a token or a URL but you can't have both
    secureFields: MergeExclusive<{ token: string }, { url: string }>;
  }
>;

export type Integration = EmailIntegration | SlackIntegration | GenericIntegration;

// Enhanced version of ContactPoint with typed integrations
// ⚠️ MergeDeep does not check if the property you are overriding exists in the base type and there is no "DeepOverrideProperties" helper
export type ContactPoint = MergeDeep<
  Receiver,
  {
    spec: {
      integrations: Integration[];
    };
  }
>;

export type EnhancedListReceiverApiResponse = OverrideProperties<
  ListReceiverApiResponse,
  {
    items: ContactPoint[];
  }
>;
